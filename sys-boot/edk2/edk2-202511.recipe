SUMMARY="EFI firmware development environment"
DESCRIPTION="The EDK II project is the response to the EFI communityâ€™s \
request for a better build and version tracking environment for UEFI and PI \
development. The main difference between the EDK II to the original EDK is \
the Enhanced Build Environment of the EDK II. The advantages of the Enhanced \
Build Environment include:

* Operating System independence
* Flexibility in choosing the compiler and assembler tools
* The ability to generate working code using open source build tools and \
applications
* Enhanced development and build capability of modules and module packages
* Use of build configuration tools and data sets to provide flexible process
* Online source control allows users to contribute code and become participants"
HOMEPAGE="https://www.tianocore.org/"
COPYRIGHT="2004-2016 Intel Corporation
	2008-2010 Apple Inc
	2011-2015 ARM Limited
	2014-2015 Linaro Limited
	2013-2015 Red Hat, Inc.
	2019 TianoCore and contributors"
LICENSE="BSD (2-clause)
	MIT"
REVISION="1"
SOURCE_URI="https://github.com/tianocore/edk2/archive/refs/tags/edk2-stable$portVersion.tar.gz"
CHECKSUM_SHA256="d919b0344afbd9ea16d757f99919860e26acc1e9246fff743e684128c2f04dd3"
SOURCE_DIR="edk2-edk2-stable$portVersion"
PATCHES="edk2-$portVersion.patchset"
srcGitRev2="e230f474b87134e8c6c85b630084c612057f253e"
SOURCE_URI_2="https://github.com/google/brotli/archive/$srcGitRev2.tar.gz"
CHECKSUM_SHA256_2="a9ba3940267de5dd73581a47c2e81b3eb1e1df6a704138c599020d66f3677a92"
SOURCE_DIR_2="brotli-$srcGitRev2"
SOURCE_FILENAME_2="brotli-$srcGitRev2.tar.gz"

srcGitRev3="370b5944c046bab043dd8b133727b2135af7747a"
SOURCE_URI_3="https://github.com/MIPI-Alliance/public-mipi-sys-t/archive/$srcGitRev3.tar.gz"
CHECKSUM_SHA256_3="9fda3b9a78343ab2be6f06ce6396536e7e065abac29b47c8eb2e42cbb4c4f00b"
SOURCE_DIR_3="public-mipi-sys-t-$srcGitRev3"
SOURCE_FILENAME_3="public-mipi-sys-t-$srcGitRev3.tar.gz"

srcGitRev4="aea7aaf2abb04789f5868cbabec406ea43aa84bf"
SOURCE_URI_4="https://github.com/openssl/openssl/archive/$srcGitRev4.tar.gz"
CHECKSUM_SHA256_4="0db2c5888e78b3ee10df5991c9bd049a2ca0eb693b3c44a05f3078a90add349a"
SOURCE_DIR_4="openssl-$srcGitRev4"
SOURCE_FILENAME_4="openssl-$srcGitRev4.tar.gz"

srcGitRev5="e185d7fd85499c8ce5ca2a54f5cf8fe7dbe3f8df"
SOURCE_URI_5="https://github.com/Mbed-TLS/mbedtls/archive/$srcGitRev5.tar.gz"
CHECKSUM_SHA256_5="052dccf3a404dce25a467c6fe044b0c858d609ace8e883b59e9dfd479fdd4528"
SOURCE_DIR_5="mbedtls-$srcGitRev5"
SOURCE_FILENAME_5="mbedtls-$srcGitRev5.tar.gz"

srcGitRev6="1be116c7b7713fa9003e1bd53b53a34758549eb9"
SOURCE_URI_6="https://github.com/DMTF/libspdm/archive/$srcGitRev6.tar.gz"
CHECKSUM_SHA256_6="59275edc6fb56c629305e6f01fe173ddf9f065cde995f18b89a64e128eae8604"
SOURCE_DIR_6="libspdm-$srcGitRev6"
SOURCE_FILENAME_6="libspdm-$srcGitRev6.tar.gz"

srcGitRev7="4ef89209a239c1aea328cf13c05a2807e5c146d1"
SOURCE_URI_7="https://github.com/kkos/oniguruma/archive/$srcGitRev7.tar.gz"
CHECKSUM_SHA256_7="70bfed97ee8390f5ac08fea28e3e930a3b33df871c6fc1888c8d436c6c6b755d"
SOURCE_DIR_7="oniguruma-$srcGitRev7"
SOURCE_FILENAME_7="oniguruma-$srcGitRev7.tar.gz"

ARCHITECTURES="?all !x86_gcc2 x86_64"
if [ "$targetArchitecture" = x86_gcc2 ]; then
SECONDARY_ARCHITECTURES="?x86"
fi
DISABLE_SOURCE_PACKAGE="yes"

PROVIDES="
	edk2$secondaryArchSuffix = $portVersion compat >= 0
	"
REQUIRES="
	haiku$secondaryArchSuffix
 	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libuuid$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:awk
	cmd:find
	cmd:gcc$secondaryArchSuffix
	cmd:iasl
	cmd:make
	cmd:nasm
	cmd:python3
	cmd:sed
	"

PATCH()
{
	local ACTIVE_PLATFORM="MdeModulePkg/MdeModulePkg.dsc"
	local TARGET="RELEASE" # DEBUG, RELEASE, NOOPT
	local TARGET_ARCH="X64" # IA32, IPF, X64, EBC, ARM or AArch64
	local TOOL_CHAIN_TAG="GCC5"

	if [ "$effectiveTargetArchitecture" = x86 ]; then
		local TARGET_ARCH="IA32" # IA32, IPF, X64, EBC, ARM or AArch64
	fi

	sed -i "s|@ACTIVE_PLATFORM@|$ACTIVE_PLATFORM|g" BaseTools/Conf/target.template
	sed -i "s|@TARGET@|$TARGET|g" BaseTools/Conf/target.template
	sed -i "s|@TARGET_ARCH@|$TARGET_ARCH|g" BaseTools/Conf/target.template
	sed -i "s|@TOOL_CHAIN_TAG@|$TOOL_CHAIN_TAG|g" BaseTools/Conf/target.template

	sed -i "s|gcc-ar|ar|g" BaseTools/Conf/tools_def.template
}

BUILD()
{
	cp -r $sourceDir2/* BaseTools/Source/C/BrotliCompress/brotli
	cp -r $sourceDir3/* MdePkg/Library/MipiSysTLib/mipisyst
	cp -r $sourceDir2/* MdeModulePkg/Library/BrotliCustomDecompressLib/brotli
	cp -r $sourceDir4/* CryptoPkg/Library/OpensslLib/openssl
	cp -r $sourceDir5/* CryptoPkg/Library/MbedTlsLib/mbedtls
	cp -r $sourceDir6/* SecurityPkg/DeviceSecurity/SpdmLib/libspdm
	cp -r $sourceDir7/* MdeModulePkg/Universal/RegularExpressionDxe/oniguruma

	export PYTHON_COMMAND=python3
	if [ "$effectiveTargetArchitecture" = x86 ]; then
		HOST_ARCH=IA32
	fi
	make -C BaseTools ${HOST_ARCH:+HOST_ARCH=$HOST_ARCH}
	. ./edksetup.sh
	local EDK_TOOLS_PATH="$sourceDir"/BaseTools
	. ./edksetup.sh BaseTools
	build
}

INSTALL()
{
	install -m 0755 -d "$dataDir"/edk2
	cd Build
	install -m 0644 -t "$dataDir"/edk2 */RELEASE*/*/*.efi
}
