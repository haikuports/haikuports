SUMMARY="Cargo applet to build and install C-ABI compatibile dynamic and static libraries"
DESCRIPTION="It produces and installs a correct pkg-config file, a static \
library and a dynamic library, and a C header to be used by any C (and \
C-compatible) software."
HOMEPAGE="https://github.com/lu-zero/cargo-c"
COPYRIGHT="2020 Luca Barbato"
LICENSE="MIT"
REVISION="1"
SOURCE_URI="https://github.com/lu-zero/cargo-c/archive/v$portVersion.tar.gz"
CHECKSUM_SHA256="e4ad4f6459522b4b1f485c2637f328f267b81bc46fdd85ec9ddbf011aa7873eb"
SOURCE_FILENAME="cargo_c-v$portVersion.tar.gz"
SOURCE_URI_2="https://github.com/lu-zero/cargo-c/releases/download/v$portVersion/Cargo.lock#noarchive"
CHECKSUM_SHA256_2="808294437c2765887c9ac955acfdce07d91377e58ce692e3a8d777e0a0d57554"
SOURCE_DIR="cargo-c-$portVersion"

ARCHITECTURES="?all !x86_gcc2 !x86_64"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	cargo_c$secondaryArchSuffix
	cmd:cargo_capi = $portVersion
	cmd:cargo_cbuild = $portVersion
	cmd:cargo_cinstall = $portVersion
	cmd:cargo_ctest = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libcurl$secondaryArchSuffix
	lib:libgit2$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libcurl$secondaryArchSuffix
	devel:libgit2$secondaryArchSuffix
	devel:libpcre$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cargo$secondaryArchSuffix
	cmd:gcc$secondaryArchSuffix
	cmd:git
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
#	export PKG_CONFIG_ALLOW_CROSS=1
	pkg-config --libs --cflags libgit2 'libgit2 >= 1.4.0' 'libgit2 < 1.5.0'
	pkg-config --libs --cflags libssl  'libssl >= 1.1.1n'

	cp $sourceDir2/Cargo.lock Cargo.lock

	cargo generate-lockfile

	cargo fetch -v
	cargo build --release --frozen
}

INSTALL()
{
	cargo install --locked --offline --root $prefix --path .

	mkdir -p $docDir
	cp README.md $docDir

	rm -f $prefix/{.crates.toml,.crates2.json}
}

TEST()
{
	cargo test --release
}
