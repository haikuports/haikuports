SUMMARY="A Diagram Editor"
DESCRIPTION="Dia is roughly inspired by the commercial Windows program 'Visio,' though more \
geared towards informal diagrams for casual use. It can be used to draw many different kinds \
of diagrams. It currently has special objects to help draw entity relationship diagrams, UML \
diagrams, flowcharts, network diagrams, and many other diagrams. It is also possible to add \
support for new shapes by writing simple XML files, using a subset of SVG to draw the shape.

It can load and save diagrams to a custom XML format (gzipped by default, to save space), can \
export diagrams to a number of formats, including EPS, SVG, XFIG, WMF and PNG, and can print \
diagrams (including ones that span multiple pages). "
HOMEPAGE="https://wiki.gnome.org/Apps/Dia"
COPYRIGHT="1998-2011 The Free Software Foundation and the authors
	2018-2021 Zander Brown et al"
LICENSE="GNU GPL v2"
REVISION="1"
srcGitRev="e62879c0690111b585f44c0544cc9f3db6320ef9"
#srcGitRev="ea793ab3eb2e5dc50e5191d782d222e15de1eccc" #libxml2 >= 2.14.0
SOURCE_URI="https://gitlab.gnome.org/GNOME/dia/-/archive/$srcGitRev.tar.gz"
CHECKSUM_SHA256="8fecaa0ce2646fb41602994498505e7cfbb324f48855d5ba1e2fc4eef05cedcf"
#CHECKSUM_SHA256="519d11da30462f4adca9042fe38dd1f4189a9a73d6eb385c6fcb9b98a26715e0" #libxml2 >= 2.14.0
SOURCE_FILENAME="dia-$portVersion-$srcGitRev.tar.gz"
SOURCE_DIR="dia-$srcGitRev"
PATCHES="dia-$portVersion.patchset"
ADDITIONAL_FILES="dia.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

commandSuffix=$secondaryArchSuffix
commandBinDir=$binDir
if [ "$targetArchitecture" = x86_gcc2 ]; then
	commandSuffix=
	commandBinDir=$prefix/bin
fi

PROVIDES="
	dia$secondaryArchSuffix = $portVersion
	cmd:Dia = $portVersion
	cmd:dia$commandSuffix = $portVersion
	lib:libdia$secondaryArchSuffix
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libcairo$secondaryArchSuffix
	lib:libgdk_pixbuf_2.0$secondaryArchSuffix
	lib:libglib_2.0$secondaryArchSuffix
	lib:libgio_2.0$secondaryArchSuffix
	lib:libgmodule_2.0$secondaryArchSuffix
	lib:libgraphene_1.0$secondaryArchSuffix
	lib:libpoppler$secondaryArchSuffix >= 155
	lib:libgtk_3$secondaryArchSuffix
	lib:libiconv$secondaryArchSuffix
	lib:libintl$secondaryArchSuffix
	lib:libpango_1.0$secondaryArchSuffix
	lib:libpangocairo_1.0$secondaryArchSuffix
	lib:libpython3.10$secondaryArchSuffix
	lib:libxml2$secondaryArchSuffix
	lib:libxpm_pixbuf$secondaryArchSuffix
	lib:libxslt$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libcairo$secondaryArchSuffix
	devel:libiconv$secondaryArchSuffix
	devel:libgdk_pixbuf_2.0$secondaryArchSuffix
	devel:libglib_2.0$secondaryArchSuffix
	devel:libgio_2.0$secondaryArchSuffix
	devel:libgmodule_2.0$secondaryArchSuffix
	devel:libgraphene_1.0$secondaryArchSuffix
	devel:libpoppler$secondaryArchSuffix >= 155
	devel:libgtk_3$secondaryArchSuffix
	devel:libxml2$secondaryArchSuffix
	devel:libxpm_pixbuf$secondaryArchSuffix
	devel:libxslt$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
#	cmd:appstreamcli #test
	cmd:cmake
#	cmd:diff #test
	cmd:gcc$secondaryArchSuffix
	cmd:git
	cmd:meson
	cmd:msgfmt$secondaryArchSuffix
	cmd:msgmerge$secondaryArchSuffix
	cmd:ninja
	cmd:pkg_config$secondaryArchSuffix
	cmd:python3.10
	cmd:xsltproc
	"

BUILD()
{
	meson setup build --buildtype=release \
		-Ddefault_library=shared \
		--prefix=$prefix \
		--bindir=$commandBinDir \
		--libdir=$libDir \
		-D tests=false

	ninja -C build $jobArgs
}

INSTALL()
{
	ninja -C build install

	mkdir -p $appsDir
	mv $commandBinDir/dia $appsDir/Dia
	ln -s $appsDir/Dia $commandBinDir/dia

	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3 | cut -d~ -f1`"
	local APP_NAME="Dia"
	local LONG_INFO="$SUMMARY"
	local APP_SIGNATURE="application/x-vnd.dia"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		-e "s|@APP_NAME@|$APP_NAME|" \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		$portDir/additional-files/dia.rdef.in > dia.rdef

	addResourcesToBinaries dia.rdef $appsDir/Dia
	addAppDeskbarSymlink $appsDir/Dia

	# cleanup
	rm -rf $dataDir/{applications,icons,metainfo}
}

TEST()
{
	# 4 OK, 1 failed (crashed - dia:objects)
	ninja -C build test
}
