SUMMARY="Robust, small and high performance http and reverse proxy server"
DESCRIPTION="nginx [engine x] is an HTTP and reverse proxy server, a mail proxy \
server, and a generic TCP proxy server, originally written by Igor Sysoev. \
For a long time, it has been running on many heavily loaded Russian sites \
including Yandex, Mail.Ru, VK, and Rambler. According to Netcraft, nginx \
served or proxied 21.89% busiest sites in June 2015."
HOMEPAGE="http://nginx.org/"
COPYRIGHT="2002-2019 Igor Sysoev
	2011-2019 Nginx, Inc."
# "it's complicated", cf. http://packages.gentoo.org/package/www-servers/nginx
LICENSE="BSD (2-clause)"
REVISION="2"
SOURCE_URI="https://nginx.org/download/nginx-$portVersion.tar.gz"
CHECKSUM_SHA256="7ae4dd020c41d3a5e1e6a8578fcc60e508e3e27e7668e845ddc87a05a775b50e"
PATCHES="nginx-$portVersion.patchset"
ADDITIONAL_FILES="userlaunch.in"

ARCHITECTURES="?x86_gcc2 ?x86 x86_64"

GLOBAL_WRITABLE_FILES="
	settings/nginx directory keep-old
	"

#FIXME: on ./auto/configure:
#grep: /etc/group: No such file or directory
PROVIDES="
	nginx$secondaryArchSuffix = $portVersion
	cmd:nginx$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libpcre$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libpcre$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:awk
	cmd:find
	cmd:gcc$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:ranlib
	cmd:sed
	"

BUILD()
{
	./configure --prefix=$prefix \
		--sbin-path=$binDir/nginx \
		--doc-prefix=$docDir \
		--conf-path=$settingsDir/nginx/nginx.conf \
		--error-log-path=$localStateDir/nginx/logs/nginx_error.log \
		--http-log-path=$localStateDir/nginx/logs/nginx_access.log \
		--pid-path=$localStateDir/nginx/nginx.pid \
		--lock-path=$localStateDir/nginx/nginx.lock \
		--http-client-body-temp-path=$localStateDir/nginx/client_body \
		--http-proxy-temp-path=$localStateDir/nginx/proxy \
		--http-fastcgi-temp-path=$localStateDir/nginx/fastcgi \
		--http-uwsgi-temp-path=$localStateDir/nginx/uwsgi \
		--http-scgi-temp-path=$localStateDir/nginx/scgi \
		--with-http_v2_module \
		--with-http_ssl_module \
		--with-threads \
		--with-debug


	make
}

INSTALL()
{
	mkdir -p $binDir
	mkdir -p $docDir
	mkdir -p $localStateDir/nginx/logs/
	make install
	mkdir -p $dataDir/user_launch
	sed \
		-e "s|@APP@|nginx|" \
		-e "s|@BIN@|"$binDir"/nginx|" \
		$portDir/additional-files/userlaunch.in > $dataDir/user_launch/nginx
}
