SUMMARY="A cross-platform application and UI framework"
DESCRIPTION="Qt is a cross-platform application framework that is widely \
used for developing software with a graphical user interface, and also used \
for developing non-GUI programs such as command-line tools and consoles for \
servers."
HOMEPAGE="https://qt.io/"
COPYRIGHT="2015-2024 The Qt Company Ltd."
LICENSE="GNU LGPL v3
	GNU GPL v3
	GNU FDL v1"
REVISION="1"
SOURCE_URI="https://download.qt.io/official_releases/qt/${portVersion%.*}/$portVersion/submodules/qtbase-everywhere-src-$portVersion.tar.xz"
CHECKSUM_SHA256="11b2e29e2e52fb0e3b453ea13bbe51a10fdff36e1c192d8868c5a40233b8b254"
SOURCE_DIR="qtbase-everywhere-src-$portVersion"
srcGitRev2="8d202a636483049d7768b855a70be9ab0d1cc780"
SOURCE_URI_2="https://github.com/threedeyes/qt6-haikuplugins/archive/$srcGitRev2.tar.gz"
CHECKSUM_SHA256_2="ac3694f59eca89cd8f6a679a26c2530c2cf5435b0e664f78336e1e11943345e1"
SOURCE_DIR_2="qt6-haikuplugins-$srcGitRev2"
PATCHES="qt6_base-$portVersion.patchset"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	qt6_base$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6Concurrent$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6Core$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6DBus$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6EglFSDeviceIntegration$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6Gui$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6Network$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6OpenGL$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6OpenGLWidgets$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6PrintSupport$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6Sql$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6Test$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6Widgets$secondaryArchSuffix = $portVersion compat >= 6
	lib:libQt6Xml$secondaryArchSuffix = $portVersion compat >= 6
	"
REQUIRES="
	haiku$secondaryArchSuffix
	haiku_svg_icon_theme
	lib:libbrotlidec$secondaryArchSuffix
	lib:libcrypto$secondaryArchSuffix
	lib:libdouble_conversion$secondaryArchSuffix
	lib:libegl$secondaryArchSuffix
	lib:libfreetype$secondaryArchSuffix
	lib:libfontconfig$secondaryArchSuffix
	lib:libgl$secondaryArchSuffix
	lib:libharfbuzz$secondaryArchSuffix
	lib:libicudata$secondaryArchSuffix
	lib:libicui18n$secondaryArchSuffix
	lib:libicuuc$secondaryArchSuffix
	lib:libintl$secondaryArchSuffix
	lib:libpcre2_16$secondaryArchSuffix
	lib:libpng16$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libstdc++$secondaryArchSuffix
	lib:libvulkan$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	cmd:qsystray
	cmd:qnotify
	"

PROVIDES_devel="
	qt6_base${secondaryArchSuffix}_devel = $portVersion compat >= 6
	devel:libQt6Concurrent$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6Core$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6DBus$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6DeviceDiscoverySupport$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6EdidSupport$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6EglFSDeviceIntegration$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6ExampleIcons$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6FBSupport$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6Gui$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6Network$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6OpenGL$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6OpenGLWidgets$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6PrintSupport$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6Sql$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6Test$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6Widgets$secondaryArchSuffix = $portVersion compat >= 6
	devel:libQt6Xml$secondaryArchSuffix = $portVersion compat >= 6
	cmd:qmake6$secondaryArchSuffix = $portVersion compat >= 6
	cmd:qtpaths6$secondaryArchSuffix = $portVersion compat >= 6
	"
REQUIRES_devel="
	haiku${secondaryArchSuffix}_devel
	qt6_base$secondaryArchSuffix == $portVersion base
	devel:libgl$secondaryArchSuffix
	devel:libharfbuzz$secondaryArchSuffix
	devel:libharfbuzz_gobject$secondaryArchSuffix
	devel:libvulkan$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libbrotlidec$secondaryArchSuffix
	devel:libcrypto$secondaryArchSuffix
	devel:libdouble_conversion$secondaryArchSuffix >= 3
	devel:libegl$secondaryArchSuffix
	devel:libfontconfig$secondaryArchSuffix
	devel:libfreetype$secondaryArchSuffix
	devel:libgl$secondaryArchSuffix
	devel:libglu$secondaryArchSuffix
	devel:libharfbuzz$secondaryArchSuffix
	devel:libharfbuzz_gobject$secondaryArchSuffix
	devel:libicuuc$secondaryArchSuffix >= 74
	devel:libjpeg$secondaryArchSuffix
	devel:libpcre2_16$secondaryArchSuffix
	devel:libpng16$secondaryArchSuffix
	devel:libsqlite3$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libvulkan$secondaryArchSuffix
	devel:libxml2$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:awk
	cmd:cmake
	cmd:find
	cmd:g++$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:ninja
	cmd:perl
	cmd:pkg_config$secondaryArchSuffix
	cmd:python3
	cmd:sed
	cmd:xargs
	"

BUILD()
{
	export DISABLE_ASLR=1

	cmake \
		-B build \
		-S $sourceDir \
		-G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_C_FLAGS="-fPIC -D_DEFAULT_SOURCE" \
		-DCMAKE_CXX_FLAGS="-fPIC -D_DEFAULT_SOURCE" \
		-DCMAKE_INSTALL_PREFIX=$prefix \
		-DBUILD_WITH_PCH=ON \
		-DINSTALL_BINDIR=$libDir/Qt6 \
		-DINSTALL_PUBLICBINDIR=$binDir \
		-DINSTALL_PLUGINSDIR=$addOnsDir/Qt6 \
		-DINSTALL_LIBDIR=$libDir \
		-DINSTALL_LIBEXECDIR=$libDir/Qt6 \
		-DINSTALL_DOCDIR=$docDir \
		-DINSTALL_ARCHDATADIR=$dataDir/Qt6 \
		-DINSTALL_DATADIR=$dataDir/Qt6 \
		-DINSTALL_INCLUDEDIR=$includeDir/Qt6 \
		-DINSTALL_MKSPECSDIR=$dataDir/Qt6/mkspecs \
		-DINSTALL_EXAMPLESDIR=$developDir/sources/Qt6 \
		-DINSTALL_QMLDIR=$dataDir/Qt6/qml \
		-DINSTALL_TRANSLATIONSDIR=$dataDir/Qt6/translations \
		-DQT_QMAKE_TARGET_MKSPEC=haiku-g++ \
		-DQT_FEATURE_openssl_linked=ON \
		-DQT_FEATURE_system_sqlite=ON \
		-DQT_FEATURE_glib=OFF \
		-DFEATURE_rpath=OFF

	ninja -v -C build $jobArgs
}

INSTALL()
{
	ninja -C build install

	# build platform plugins
	PATH=$PATH:$binDir:$libDir/Qt6
	LIBRARY_PATH=$LIBRARY_PATH:$libDir
	mkdir -p $sourceDir2/build
	cd $sourceDir2/build
	qmake6 ../src
	make $jobArgs

	# install platform plugins
	mkdir -p $addOnsDir/Qt6/{platforms,imageformats,styles} $preferencesDir
	cp platform/libqhaiku.so $addOnsDir/Qt6/platforms
	cp imageformats/hvif/libqhvif.so $addOnsDir/Qt6/imageformats
	cp style/libqhaikustyle.so $addOnsDir/Qt6/styles
	cp preferences/Qt6Configurator $preferencesDir

	prepareInstalledDevelLibs \
		libQt6Concurrent \
		libQt6Core \
		libQt6DBus \
		libQt6DeviceDiscoverySupport \
		libQt6EglFSDeviceIntegration \
		libQt6FbSupport \
		libQt6ExampleIcons \
		libQt6Gui \
		libQt6Network \
		libQt6OpenGL \
		libQt6OpenGLWidgets \
		libQt6PrintSupport \
		libQt6Sql \
		libQt6Test \
		libQt6Widgets \
		libQt6Xml

	# fix pkgconfig & cmake files
	fixPkgconfig
	sed -i "s|includedir=.*|includedir=$includeDir/Qt6|" \
		$developLibDir/pkgconfig/*.pc
	sed -i 's,${_IMPORT_PREFIX}/lib',$developDir/lib, \
		$libDir/cmake/Qt6FbSupportPrivate/Qt6FbSupportPrivateTargets-release.cmake
	sed -i 's,${_IMPORT_PREFIX}/lib',$developDir/lib, \
		$libDir/cmake/Qt6DeviceDiscoverySupportPrivate/Qt6DeviceDiscoverySupportPrivateTargets-release.cmake

	mkdir -p $binDir
	ln -s -t $binDir $libDir/Qt6/{qmake6,qtpaths6}
	rm -rf $(dirname "$docDir")

	cd $libDir
	for i in lib*.so.6.*;do
		ln -fs $i $(echo $i | cut -f1,2 -d.)
	done

	packageEntries devel \
		$developDir \
		$binDir \
		$libDir/cmake \
		$dataDir/Qt6/mkspecs

	addPreferencesDeskbarSymlink $preferencesDir/Qt6Configurator "Qt6 Configurator"
}
