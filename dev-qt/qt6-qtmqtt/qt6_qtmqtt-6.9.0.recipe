SUMMARY="MQTT: The Standard for IoT Messaging"
DESCRIPTION="MQTT is an OASIS standard messaging protocol for the Internet of Things (IoT). It is \
designed as an extremely lightweight publish/subscribe messaging transport that is ideal for \
connecting remote devices with a small code footprint and minimal network bandwidth. MQTT today \
is used in a wide variety of industries, such as automotive, manufacturing, telecommunications, \
oil and gas, etc."
HOMEPAGE="https://mqtt.org/"
COPYRIGHT="2024 MQTT.org"
LICENSE="BSD (3-clause)
	GNU FDL v1.3
	GNU GPL v3"
REVISION="1"
SOURCE_URI="https://github.com/qt/qtmqtt/archive/refs/tags/v$portVersion.tar.gz"
CHECKSUM_SHA256="7cdec84ca17ad2bd9d47418ca98820705a7798895a2315b5c20c46528a29547e"
SOURCE_DIR="qtmqtt-$portVersion"

ARCHITECTURES="?all x86_gcc2"
SECONDARY_ARCHITECTURES="?x86"

libVersion="$portVersion"
libVersionCompat="$libVersion compat >= ${libVersion%%.*}"

PROVIDES="
	qt6_qtmqtt$secondaryArchSuffix = $portVersion
	lib:libQt6Mqtt$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libQt6Core$secondaryArchSuffix
	lib:libQt6Network$secondaryArchSuffix
	"

PROVIDES_devel="
	qt6_qtmqtt${secondaryArchSuffix}_devel = $portVersion
	devel:libQt6Mqtt$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES_devel="
	qt6_qtmqtt$secondaryArchSuffix == $portVersion base
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libQt6Core$secondaryArchSuffix
	devel:libQt6Quick$secondaryArchSuffix
	devel:libQt6WebSockets$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:ninja
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	export DISABLE_ASLR=1

	cmake -B build -S . -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_CXX_FLAGS=-fPIC \
		-DQT_GENERATE_SBOM=ON \
		-Wno-dev

	find -name cmake_install.cmake -exec sed -i "s|set(CMAKE_INSTALL_PREFIX.*|set(CMAKE_INSTALL_PREFIX \"$prefix\")|" {} \;

	ninja -v -C build $jobArgs
}

INSTALL()
{
	ninja -C build install

	prepareInstalledDevelLib \
		libQt6Mqtt
	fixPkgconfig

	packageEntries devel \
		$developDir \
		$libDir/cmake \
		$dataDir/Qt6/mkspecs
}

TEST()
{
	make check
}
