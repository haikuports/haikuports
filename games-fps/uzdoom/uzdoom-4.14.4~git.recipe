SUMMARY="Advanced Doom source port with Vulkan/OpenGL support"
DESCRIPTION="ZDoom is a family of enhanced ports of the Doom engine for modern operating systems, with many \
new features not found in the games as originally published by id Software.

UZDoom is a feature centric port for all Doom engine games, based on GZDoom, \
with OpenGL and Vulkan renderers and powerful scripting capabilities.

The binaries will look for .wad files in:
* ~/config/non-packaged/data/games/uzdoom
* ~/config/non-packaged/data/games/doom
* ~/config/non-packaged/data/doomdata
* ~/config/non-packaged/data/doom
* Any compatible game data package
The binaries can be also used via command-line with the -iwad command.
Example: 'UZDoom -iwad /path/to/doom.wad'"
HOMEPAGE="https://zdoom.org/"
COPYRIGHT="
	1998-2025 ZDoom + GZDoom, UZDoom teams, and contributors
	1997 id Software, Raven Software, and contributors
	"
LICENSE="GNU GPL v3"
REVISION="1"
srcGitRev="584dd1d1ae300597e8462d3edb10a6b007d45683"
SOURCE_URI="https://github.com/UZDoom/UZDoom/archive/$srcGitRev.zip"
CHECKSUM_SHA256="71fa51eb1a2d5d95542a915df4ef2039c5d00c714cf135abc7a8391617d03f2b"
SOURCE_DIR="UZDoom-$srcGitRev"
PATCHES="uzdoom-$portVersion.patchset"
ADDITIONAL_FILES="uzdoom.rdef.in"

# 32bit is not supported.
ARCHITECTURES="riscv64 x86_64 ?arm64"

PROVIDES="
	uzdoom = $portVersion
	app:UZDoom = $portVersion
	engine:doom # Standard Doom-compatible engine
	engine:doom_extra # Heretic, Hexen, Strife etc.
	engine:zdoom # Can handle ZDoom-specific game data
	"
REQUIRES="
	haiku
	lib:libbz2
	lib:libexecinfo
	#lib:libglib_2.0 # For internal ZMusic
	lib:libgomp
	lib:libopenal # Optional, required for in-game audio
	lib:libSDL2_2.0
	lib:libvpx
	lib:libzmusic
	"
REPLACES="gzdoom"

BUILD_REQUIRES="
	haiku_devel
	devel:libbz2
	devel:libexecinfo
	devel:libGL # For OpenGL renderer
	#devel:libglib_2.0 # For internal ZMusic
	devel:libopenal # Optional, required for in-game audio
	devel:libSDL2_2.0
	devel:libvpx
	devel:libzmusic
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc
	cmd:git # Optional, needed for build date
	cmd:make
	cmd:pkg_config
	cmd:python3
	"

BUILD()
{
	cmake -Bbuild -S. $cmakeDirArgs \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_CXX_FLAGS="-D_GNU_SOURCE -D_BSD_SOURCE" \
		-DCMAKE_EXE_LINKER_FLAGS="-lbsd -lnetwork" \
		-DINSTALL_PATH=$appsDir \
		-DINSTALL_DOCS_PATH=$docDir \
		-DINSTALL_PK3_PATH=$dataDir/games/uzdoom \
		-DINSTALL_SOUNDFONT_PATH=$dataDir/games/uzdoom \
		-DDYN_GTK=OFF -DNO_GTK=ON \
		-DFORCE_INTERNAL_ZMUSIC=OFF \
		-DVULKAN_USE_XLIB=OFF

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install
	mv $appsDir/uzdoom $appsDir/UZDoom

	# Remove *nixy desktop and cppdap files
	rm -r $prefix/share $libDir $developDir/headers

	# Generate the rdef
	local APP_SIGNATURE="application/x-vnd.uzdoom"
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -b6`"
	local LONG_INFO="$SUMMARY"
	sed \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		$portDir/additional-files/uzdoom.rdef.in > uzdoom.rdef

	addResourcesToBinaries uzdoom.rdef $appsDir/UZDoom
	addAppDeskbarSymlink $appsDir/UZDoom
}
