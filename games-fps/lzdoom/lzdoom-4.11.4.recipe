SUMMARY="Advanced Doom source port with lower system requirements"
DESCRIPTION="ZDoom is a family of enhanced ports of the Doom engine for modern operating systems, with many \
new features not found in the games as originally published by id Software.

LZDoom is based on an older version of GZDoom. It does not provide all features \
currently supported by GZDoom but in turn is capable of running the hardware renderer \
on older hardware which does not support modern OpenGL features.

LZDoom comes with 2 optional UIs, a feature-rich one enabled by installing GTK3, \
and a more lightweight one using KDialog.
Running LZDoom without installed UIs from command-line will provide a simple .wad selection menu.

The binaries will look for .wad files in:
* ~/config/non-packaged/data/lzdoom
* ~/config/non-packaged/data/doomdata
* ~/config/non-packaged/data/doom
* /boot/system/non-packaged/data/doomdata
* Any compatible game data package
The binaries can be also used via command-line with the -iwad command.
Example: 'LZDoom -iwad /path/to/doom.wad'"
HOMEPAGE="https://zdoom.org/"
COPYRIGHT="
	1998-2025 ZDoom + GZDoom, LZDoom teams, and contributors
	1997 id Software, Raven Software, and contributors
	"
LICENSE="GNU GPL v3"
REVISION="1"
SOURCE_URI="https://github.com/drfrag666/lzdoom/archive/l$portVersion.tar.gz"
CHECKSUM_SHA256="dd4fc8ea2a566cb6b614b1aede39a0cc57a4f9d81b3c0f5e74323e92aea8c05e"
SOURCE_DIR="lzdoom-l$portVersion"
PATCHES="lzdoom-$portVersion.patchset"
ADDITIONAL_FILES="lzdoom.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	lzdoom$secondaryArchSuffix = $portVersion
	app:LZDoom = $portVersion
	engine:doom # Standard Doom-compatible engine
	engine:doom_extra # Heretic, Hexen, Strife etc.
	engine:zdoom # Can handle ZDoom-specific game data
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libbz2$secondaryArchSuffix
	lib:libexecinfo$secondaryArchSuffix
	lib:libgomp$secondaryArchSuffix
	lib:libopenal$secondaryArchSuffix # Optional, required for in-game audio
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libvpx$secondaryArchSuffix
	lib:libzmusic$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libbz2$secondaryArchSuffix
	devel:libexecinfo$secondaryArchSuffix
	devel:libGL$secondaryArchSuffix # For OpenGL renderer
	devel:libgtk_3$secondaryArchSuffix # For GTK3 interface, needed with DYN_GTK=OFF, optional with DYN_GTK=ON, skipped with NO_GTK=ON
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libvpx$secondaryArchSuffix
	devel:libzmusic$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:git # Optional, needed for build date
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	cmake -Bbuild -S. $cmakeDirArgs \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_CXX_FLAGS="-D_GNU_SOURCE -D_BSD_SOURCE" \
		-DCMAKE_EXE_LINKER_FLAGS="-lbsd -lnetwork" \
		-DINSTALL_PATH=$appsDir \
		-DINSTALL_DOCS_PATH=$docDir \
		-DINSTALL_PK3_PATH=$dataDir/lzdoom \
		-DINSTALL_SOUNDFONT_PATH=$dataDir/lzdoom \
		-DVULKAN_USE_XLIB=OFF

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install
	mv $appsDir/lzdoom $appsDir/LZDoom

	# Generate the rdef
	local APP_SIGNATURE="application/x-vnd.lzdoom"
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -b6`"
	local LONG_INFO="$SUMMARY"
	sed \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		$portDir/additional-files/lzdoom.rdef.in > lzdoom.rdef

	addResourcesToBinaries lzdoom.rdef $appsDir/LZDoom
	addAppDeskbarSymlink $appsDir/LZDoom
}
