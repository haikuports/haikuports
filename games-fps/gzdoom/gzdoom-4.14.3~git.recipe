SUMMARY="Advanced Doom source port with OpenGL support"
DESCRIPTION="ZDoom is a family of enhanced ports of the Doom engine for running on modern operating systems, \
with many new features not found in the games as originally published by id Software.

ZDoom was originally created by Randi Heit using id Software’s and various others’ sources.
Its successor ports GZDoom and QZDoom are now maintained by Christoph Oelckers, Alexey Lysiuk, Magnus Norddahl, \
Rachael Alexanderson, and Braden Obrzut.

The binaries will look for .wad files in:
* ~/config/non-packaged/data/gzdoom
* ~/config/non-packaged/data/doomdata
* ~/config/non-packaged/data/doom
* ~/doom
* /boot/system/non-packaged/data/doomdata
* Any compatible game data package
The binaries can be also used via command-line with the -iwad command.
Example: 'gzdoom -iwad /path/to/doom.wad'"
HOMEPAGE="https://zdoom.org/"
COPYRIGHT="
	1998-2025 ZDoom + GZDoom teams, and contributors
	1997 id Software, Raven Software, and contributors
	"
LICENSE="GNU GPL v3"
REVISION="1"
srcGitRev="b000203598d16acaa7c5ac2967127b0ba48291de"
SOURCE_URI="https://github.com/ZDoom/gzdoom/archive/$srcGitRev.zip"
CHECKSUM_SHA256="a49a897fc7afdc1b4b2f9e7f701758059addc18c6dcaf027135771be38e153ce"
SOURCE_DIR="gzdoom-$srcGitRev"
PATCHES="gzdoom-$portVersion.patchset"
ADDITIONAL_FILES="gzdoom.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	gzdoom$secondaryArchSuffix = $portVersion
	app:GZDoom = $portVersion
	engine:doom
	engine:doom_extra
	"
REQUIRES="
	haiku$secondaryArchSuffix
	#lib:libatk_1.0$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	lib:libbz2$secondaryArchSuffix
	#lib:libcairo$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	lib:libexecinfo$secondaryArchSuffix
	#lib:libglib_2.0$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	#lib:libgobject_2.0$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	lib:libgomp$secondaryArchSuffix
	#lib:libharfbuzz$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	#lib:libintl$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	#lib:libgdk_pixbuf_2.0$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	#lib:libgtk_3$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	#lib:libpangocairo_1.0$secondaryArchSuffix # Optional, for GTK3 interface, needed with DYN_GTK=OFF
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libvpx$secondaryArchSuffix
	lib:libzmusic$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libbz2$secondaryArchSuffix
	devel:libexecinfo$secondaryArchSuffix
	devel:libGL$secondaryArchSuffix # For OpenGL renderer
	#devel:libgtk_3$secondaryArchSuffix # For GTK3 interface, needed with DYN_GTK=OFF, optional with DYN_GTK=ON, skipped with NO_GTK=ON
	#devel:liblzma$secondaryArchSuffix # Uses in-source one
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libvpx$secondaryArchSuffix
	devel:libzmusic$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:git # Optional, needed for build date
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	cmake -Bbuild -S. $cmakeDirArgs \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_CXX_FLAGS="-D_GNU_SOURCE -D_BSD_SOURCE" \
		-DCMAKE_EXE_LINKER_FLAGS="-lbsd -lnetwork" \
		-DINSTALL_PATH=$appsDir \
		-DINSTALL_DOCS_PATH=$docDir \
		-DINSTALL_PK3_PATH=$dataDir/gzdoom \
		-DINSTALL_SOUNDFONT_PATH=$dataDir/gzdoom \
		-DDYN_GTK="OFF" -DNO_GTK="ON" \
		-DVULKAN_USE_XLIB="OFF"

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install
	mv $appsDir/gzdoom $appsDir/GZDoom

	local APP_SIGNATURE="application/x-vnd.gzdoom"
	local MAJOR="`echo "$portVersion" | cut -b1`"
	local MIDDLE="`echo "$portVersion" | cut -b3,4`"
	local MINOR="`echo "$portVersion" | cut -b6`"

	local LONG_INFO="$SUMMARY"
	sed \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		$portDir/additional-files/gzdoom.rdef.in > gzdoom.rdef

	addResourcesToBinaries gzdoom.rdef $appsDir/GZDoom
	addAppDeskbarSymlink $appsDir/GZDoom
}
