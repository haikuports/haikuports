SUMMARY="Advanced Doom source port with OpenGL support"
DESCRIPTION="ZDoom is a family of enhanced ports of the Doom engine for modern operating systems, with many \
new features not found in the games as originally published by id Software.

GZDoom is a feature centric port for all Doom engine games, based on ZDoom, \
adding OpenGL and Vulkan renderers and powerful scripting capabilities.

The binaries will look for .wad files in:
* ~/config/non-packaged/data/gzdoom
* ~/config/non-packaged/data/doomdata
* ~/config/non-packaged/data/doom
* /boot/system/non-packaged/data/doomdata
* Any compatible game data package
The binaries can be also used via command-line with the -iwad command.
Example: 'GZDoom -iwad /path/to/doom.wad'"
HOMEPAGE="https://zdoom.org/"
COPYRIGHT="
	1998-2025 ZDoom + GZDoom teams, and contributors
	1997 id Software, Raven Software, and contributors
	"
LICENSE="GNU GPL v3"
REVISION="1"
srcGitRev="b746be8a6ba982903ce222307baa4fc26d1a91dd"
SOURCE_URI="https://github.com/ZDoom/gzdoom/archive/$srcGitRev.zip"
CHECKSUM_SHA256="9da46b7e304c4c5f1861086da34aacdfd1c33d5a7b28f0182005b867dacd4dd4"
SOURCE_DIR="gzdoom-$srcGitRev"
PATCHES="gzdoom-$portVersion.patchset"
ADDITIONAL_FILES="gzdoom.rdef.in"

# 32bit is not supported.
ARCHITECTURES="riscv64 x86_64 ?arm64"

PROVIDES="
	gzdoom = $portVersion
	app:GZDoom = $portVersion
	engine:doom # Standard Doom-compatible engine
	engine:doom_extra # Heretic, Hexen, Strife etc.
	engine:zdoom # Can handle ZDoom-specific game data
	"
REQUIRES="
	haiku
	lib:libbz2
	lib:libexecinfo
	lib:libgomp
	lib:libopenal # Optional, required for in-game audio
	lib:libSDL2_2.0
	lib:libvpx
	lib:libzmusic
	"

BUILD_REQUIRES="
	haiku_devel
	devel:libbz2
	devel:libexecinfo
	devel:libGL # For OpenGL renderer
	devel:libSDL2_2.0
	devel:libvpx
	devel:libzmusic
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc
	cmd:git # Optional, needed for build date
	cmd:make
	cmd:pkg_config
	"

BUILD()
{
	cmake -Bbuild -S. $cmakeDirArgs \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_CXX_FLAGS="-D_GNU_SOURCE -D_BSD_SOURCE" \
		-DCMAKE_EXE_LINKER_FLAGS="-lbsd -lnetwork" \
		-DINSTALL_PATH=$appsDir \
		-DINSTALL_DOCS_PATH=$docDir \
		-DINSTALL_PK3_PATH=$dataDir/gzdoom \
		-DINSTALL_SOUNDFONT_PATH=$dataDir/gzdoom \
		-DDYN_GTK=OFF -DNO_GTK=ON \
		-DVULKAN_USE_XLIB=OFF

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install
	mv $appsDir/gzdoom $appsDir/GZDoom

	# Remove *nixy desktop and cppdap files
	rm -r $prefix/share $libDir $developDir/headers

	# Generate the rdef
	local APP_SIGNATURE="application/x-vnd.gzdoom"
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -b6`"
	local LONG_INFO="$SUMMARY"
	sed \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		$portDir/additional-files/gzdoom.rdef.in > gzdoom.rdef

	addResourcesToBinaries gzdoom.rdef $appsDir/GZDoom
	addAppDeskbarSymlink $appsDir/GZDoom
}
