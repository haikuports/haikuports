From 264848145262e0d3d20d3c11b3e3688bde07ab26 Mon Sep 17 00:00:00 2001
From: Ken Mays <kmays2000@gmail.com>
Date: Fri, 26 Nov 2021 08:21:14 +1000
Subject: Fix MAKEDEV for Haiku


diff --git a/xf86drm.c b/xf86drm.c
index 5933e4b..9f25d3a 100644
--- a/xf86drm.c
+++ b/xf86drm.c
@@ -68,6 +68,13 @@
 #include <sys/pciio.h>
 #endif
 
+#if !defined(HAVE_MAJOR) && !defined(major)
+/* Replacement for major/minor/makedev. */
+#define	major(x) ((int)(0x00ff & ((x) >> 8)))
+#define	minor(x) ((int)(0xffff00ff & (x)))
+#define	makedev(maj,min) ((0xff00 & ((maj)<<8)) | (0xffff00ff & (min)))
+#endif
+
 #define ARRAY_SIZE(a) (sizeof(a) / sizeof((a)[0]))
 
 /* Not all systems have MAP_FAILED defined */
-- 
2.30.2


From b51d58487dd964d68e934a549b552cb8b9d3cd83 Mon Sep 17 00:00:00 2001
From: Ken Mays <kmays2000@gmail.com>
Date: Fri, 26 Nov 2021 08:21:14 +1000
Subject: Fix Nouveau IOCTL for Haiku


diff --git a/tests/nouveau/threaded.c b/tests/nouveau/threaded.c
index ddbac74..bd36785 100644
--- a/tests/nouveau/threaded.c
+++ b/tests/nouveau/threaded.c
@@ -36,8 +36,11 @@ static int failed;
 
 static int import_fd;
 
-#if defined(__GLIBC__) || defined(__FreeBSD__)
+#if defined(__GLIBC__) || defined(__FreeBSD__)||defined(__HAIKU__)
+#if defined(__HAIKU__)
+#undef ioctl
 int ioctl(int fd, unsigned long request, ...)
+#endif
 #else
 int ioctl(int fd, int request, ...)
 #endif
-- 
2.30.2


From 52e625d5786926a1d797da77f43175b1cf2554c8 Mon Sep 17 00:00:00 2001
From: Ken Mays <kmays2000@gmail.com>
Date: Fri, 26 Nov 2021 08:45:05 +1000
Subject: Fix libkms for Haiku


diff --git a/libkms/linux.c b/libkms/linux.c
index 5620505..ec6be68 100644
--- a/libkms/linux.c
+++ b/libkms/linux.c
@@ -49,6 +49,13 @@
 
 #define PATH_SIZE 512
 
+#if !defined(HAVE_MAJOR) && !defined(major)
+/* Replacement for major/minor/makedev. */
+#define	major(x) ((int)(0x00ff & ((x) >> 8)))
+#define	minor(x) ((int)(0xffff00ff & (x)))
+#define	makedev(maj,min) ((0xff00 & ((maj)<<8)) | (0xffff00ff & (min)))
+#endif
+
 static int
 linux_name_from_sysfs(int fd, char **out)
 {
-- 
2.30.2


From ba71f19c817a867d842961f3e991a365992eaaa5 Mon Sep 17 00:00:00 2001
From: Ken Mays <kmays2000@gmail.com>
Date: Fri, 26 Nov 2021 08:45:05 +1000
Subject: Fix Haiku ERESTART for libkms


diff --git a/libkms/vmwgfx.c b/libkms/vmwgfx.c
index 1984399..20fde63 100644
--- a/libkms/vmwgfx.c
+++ b/libkms/vmwgfx.c
@@ -38,6 +38,10 @@
 #include "libdrm_macros.h"
 #include "vmwgfx_drm.h"
 
+#ifndef ERESTART and defined __HAIKU__
+#define ERESTART (B_ERRORS_END +1)
+#endif
+
 struct vmwgfx_bo
 {
 	struct kms_bo base;
-- 
2.30.2

