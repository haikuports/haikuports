SUMMARY="Remote terminal that supports intermittent connectivity"
DESCRIPTION="Remote terminal application that allows roaming, supports \
intermittent connectivity, and provides intelligent local echo and line \
editing of user keystrokes.

Mosh is a replacement for SSH. It's more robust and responsive, especially \
over Wi-Fi, cellular, and long-distance links.

Mosh is free software, available for GNU/Linux, FreeBSD, Solaris, Mac OS X, \
and Android."
HOMEPAGE="https://mosh.org/"
COPYRIGHT="2012 Keith Winstein"
LICENSE="GNU GPL v3"
REVISION="1"
SOURCE_URI="https://github.com/mobile-shell/mosh/releases/download/mosh-$portVersion/mosh-$portVersion.tar.gz"
CHECKSUM_SHA256="872e4b134e5df29c8933dff12350785054d2fd2839b5ae6b5587b14db1465ddd"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	mosh$secondaryArchSuffix = $portVersion
	cmd:mosh
	cmd:mosh_client
	cmd:mosh_server
	"
REQUIRES="
	haiku$secondaryArchSuffix
	cmd:perl	# required by cmd:mosh
	lib:libcrypto$secondaryArchSuffix
	lib:libncursesw$secondaryArchSuffix
	lib:libprotobuf$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libncursesw$secondaryArchSuffix
	devel:libprotoc$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:awk
	cmd:gcc$secondaryArchSuffix
	cmd:make
	cmd:perl
	cmd:pkg_config$secondaryArchSuffix
	"

TEST_REQUIRES="
	cmd:gawk
	# cmd:tmux	# makes the tests hang. See HaikuPorts issue #1535.
	"

BUILD()
{
	export CFLAGS="-O2 -D_BSD_SOURCE"
	export CXXFLAGS="-O2 -D_BSD_SOURCE"

	runConfigure --omit-dirs "binDir" ./configure \
		--bindir=$prefix/bin \
		--disable-hardening \
		--enable-compile-warnings=error \
		--enable-completion

	make $jobArgs
}

INSTALL()
{
	make install

	# If "bash-completion.pc" is present, "make install" tries to write the completion file into the
	# read-only "/packages/bash_completion-<bash_completion-version>/.self/data/bash-completion/completions" dir.
	# If "bash-completion.pc" is not present, it writes it under "$settingsDir/bash_completion.d/"
	# (which is "compatdir" in bash_completion.pc).
	# So we adjust the location manually:
	install -d -m 755 $dataDir/bash-completion/completions
	install -m 644 $sourceDir/conf/bash-completion/completions/mosh $dataDir/bash-completion/completions/mosh
	rm -rf $settingsDir/*
}

# Reference results on hrev59189 (x86_64):
# TOTAL: 31
# PASS:  4
# SKIP:  26
# XFAIL: 0
# FAIL:  1
# XPASS: 0
# ERROR: 0
#
# Skipped tests due to missing "cmd:tmux" (which makes tests hang). See HaikuPorts issue #1535.
# FAIL: local.test # Seems reads from a forked pty always fail with "read: Bad file descriptor".
TEST()
{
	make check
}
