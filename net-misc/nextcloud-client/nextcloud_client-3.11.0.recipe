SUMMARY="Desktop Syncing Client for Nextcloud"
DESCRIPTION="The Nextcloud Desktop Client is a tool to synchronize
files from Nextcloud Server with your computer."
HOMEPAGE="http://nextcloud.com"
COPYRIGHT="Nextcloud GmbH"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="https://github.com/nextcloud/desktop/archive/refs/tags/v$portVersion.tar.gz"
CHECKSUM_SHA256="75d53751411a7544ed5b9f23c3e71c19a96f4096313d76dad77314c3773319d9"
SOURCE_DIR="desktop-$portVersion"
PATCHES="nextcloud_client-$portVersion.patchset"
ADDITIONAL_FILES="nextcloud_client.rdef"

ARCHITECTURES="!x86_gcc2 x86_64"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	cmd:nextcloud${secondaryArchSuffix} = $portVersion
	cmd:nextcloudcmd${secondaryArchSuffix} = $portVersion
	libnextcloud_csync${secondaryArchSuffix} = $portVersion
	libnextcloudsync${secondaryArchSuffix} = $portVersion
	lib:libnextcloud_csync$secondaryArchSuffix = $portVersion
	lib:libnextcloudsync$secondaryArchSuffix = $portVersion
	lib:nextcloudsync_vfs_suffix$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku${secondaryArchSuffix}
	lib:libcmocka$secondaryArchSuffix
	lib:libcrypto$secondaryArchSuffix
	lib:libkf5archive$secondaryArchSuffix
	lib:libQt5Concurrent$secondaryArchSuffix
	lib:libQt5Core$secondaryArchSuffix
	lib:libQt5DBus$secondaryArchSuffix
	lib:libQt5Gui$secondaryArchSuffix >= 5.14.0
	lib:libqt5keychain$secondaryArchSuffix
	lib:libqt5Network$secondaryArchSuffix
	lib:libQT5Qml$secondaryArchSuffix
	lib:libQt5QmlModels$secondaryArchSuffix
	lib:libQt5Quick$secondaryArchSuffix
	lib:libQt5QuickControls2$secondaryArchSuffix
	lib:libQt5Sql$secondaryArchSuffix
	lib:libQt5Svg$secondaryArchSuffix
	lib:libqt5Test$secondaryArchSuffix
	lib:libQt5WebEngine$secondaryArchSuffix
	lib:libQt5WebEngineWidgets$secondaryArchSuffix
	lib:libQt5WebSockets$secondaryArchSuffix
	lib:libQt5Widgets$secondaryArchSuffix
	lib:libQt5Xml$secondaryArchSuffix
	lib:libsqlite3$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	#optional
	lib:libQt5WebChannel$secondaryArchSuffix
	lib:libQt5Positioning$secondaryArchSuffix
	lib:libQt5WebEngineCore$secondaryArchSuffix
	lib:libQt5PrintSupport$secondaryArchSuffix
	"

PROVIDES_devel="
	libnextcloud_csync${secondaryArchSuffix}_devel = $portVersion
	libnextcloudsync${secondaryArchSuffix}_devel = $portVersion
	devel:libnextcloud_csync$secondaryArchSuffix = $portVersion
	devel:libnextcloudsync$secondaryArchSuffix = $portVersion
	"
REQUIRES_devel="
	nextcloud_client${secondaryArchSuffix} == $portVersion base
	devel:libQt5Gui$secondaryArchSuffix >= 5.14.0
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	extra_cmake_modules$secondaryArchSuffix
	devel:libcmocka$secondaryArchSuffix
	devel:libcrypto$secondaryArchSuffix
	devel:libkf5archive$secondaryArchSuffix
	devel:libQt5Concurrent$secondaryArchSuffix
	devel:libQt5Core$secondaryArchSuffix
	devel:libQt5DBus$secondaryArchSuffix
	devel:libQt5Gui$secondaryArchSuffix >= 5.14.0
	devel:libqt5keychain$secondaryArchSuffix
	devel:libqt5Network$secondaryArchSuffix
	devel:libQT5Qml$secondaryArchSuffix
	devel:libQt5QmlModels$secondaryArchSuffix
	devel:libQt5Quick$secondaryArchSuffix
	devel:libQt5QuickControls2$secondaryArchSuffix
	devel:libQt5Sql$secondaryArchSuffix
	devel:libQt5Svg$secondaryArchSuffix
	devel:libqt5Test$secondaryArchSuffix
	devel:libQt5WebEngine$secondaryArchSuffix
	devel:libQt5WebEngineWidgets$secondaryArchSuffix
	devel:libQt5WebSockets$secondaryArchSuffix
	devel:libQt5Widgets$secondaryArchSuffix
	devel:libQt5Xml$secondaryArchSuffix
	devel:libsqlite3$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	#optional
	devel:libQt5WebChannel$secondaryArchSuffix
	devel:libQt5Positioning$secondaryArchSuffix
	devel:libQt5WebEngineCore$secondaryArchSuffix
	devel:libQt5PrintSupport$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:g++${secondaryArchSuffix}
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	cmd:linguist$secondaryArchSuffix >= 5
	cmd:qmake$secondaryArchSuffix >= 5
	cmd:rsvg_convert
	"

BUILD()
{
	mkdir -p client-build
	cd client-build
	cmake $cmakeDirArgs \
		-DCMAKE_INSTALL_BINDIR=$commandBinDir \
		-DCMAKE_BUILD_TYPE=Release \
		..
	make $jobArgs
}

INSTALL()
{
	cd client-build
	make install	
	
	# we did tell you it does not belong here already...
	mkdir -p $includeDir
	mv $prefix/include/nextcloudsync $includeDir/
	rmdir $prefix/include

	prepareInstalledDevelLibs \
		libnextcloud_csync \
		libnextcloudsync
	packageEntries devel \
		$developDir
	
	addResourcesToBinaries $portDir/additional-files/nextcloud_client.rdef $binDir/nextcloud
	addAppDeskbarSymlink $binDir/nextcloud
}
