From 8d8286e3a4a25739c2b14550438924aeda7d8e45 Mon Sep 17 00:00:00 2001
From: Chris Roberts <cpr420@gmail.com>
Date: Wed, 18 Sep 2013 03:11:28 -0600
Subject: Fix for gcc2


diff --git a/Src/Modules/param_private.c b/Src/Modules/param_private.c
index 86416c5..b8e7c18 100644
--- a/Src/Modules/param_private.c
+++ b/Src/Modules/param_private.c
@@ -79,6 +79,7 @@ static int makeprivate_error = 0;
 static void
 makeprivate(HashNode hn, UNUSED(int flags))
 {
+    struct gsu_closure *gsu;
     Param pm = (Param)hn;
     if (pm->level == locallevel) {
 	if (pm->ename || (pm->node.flags & PM_NORESTORE) ||
@@ -92,7 +93,7 @@ makeprivate(HashNode hn, UNUSED(int flags))
 	    makeprivate_error = 1;
 	    return;
 	}
-	struct gsu_closure *gsu = zhalloc(sizeof(struct gsu_closure));
+	gsu = zhalloc(sizeof(struct gsu_closure));
 	switch (PM_TYPE(pm->node.flags)) {
 	case PM_SCALAR:
 	    gsu->g = (void *)(pm->gsu.s);
diff --git a/Src/Zle/textobjects.c b/Src/Zle/textobjects.c
index bf83906..180e3fb 100644
--- a/Src/Zle/textobjects.c
+++ b/Src/Zle/textobjects.c
@@ -68,8 +68,9 @@ selectword(UNUSED(char **args))
 	}
 	/* similarly scan forward over characters of the same class */
 	while (zlecs < zlell) {
+	    int pos;
 	    INCCS();
-	    int pos = zlecs;
+	    pos = zlecs;
 	    /* single newlines within blanks are included */
 	    if (all && !sclass && pos < zlell && zleline[pos] == ZWC('\n'))
 		INCPOS(pos);
diff --git a/Src/Zle/zle_hist.c b/Src/Zle/zle_hist.c
index 581ca49..ebe5a1b 100644
--- a/Src/Zle/zle_hist.c
+++ b/Src/Zle/zle_hist.c
@@ -1622,10 +1622,11 @@ doisearch(char **args, int dir, int pattern)
 	    else
 		goto ins;
 	} else if (cmd == Th(z_bracketedpaste)) {
+	    size_t pastelen;
 	    char *paste = bracketedstring();
 	    set_isrch_spot(top_spot++, hl, pos, pat_hl, pat_pos, end_pos,
 			   zlemetacs, sbptr, dir, nomatch);
-	    size_t pastelen = strlen(paste);
+	    pastelen = strlen(paste);
 	    if (sbptr + pastelen >= sibuf - FIRST_SEARCH_CHAR - 2) {
 		int oldsize = sibuf;
 		sibuf += (pastelen >= sibuf) ? pastelen + 1 : sibuf;
diff --git a/Src/Zle/zle_vi.c b/Src/Zle/zle_vi.c
index e0923db..ec66f6a 100644
--- a/Src/Zle/zle_vi.c
+++ b/Src/Zle/zle_vi.c
@@ -183,11 +183,12 @@ getvirange(int wf)
 	vilinerange = (visual == 2);
 	region_active = 0;
     } else {
+	Keymap km;
 	virangeflag = 1;
 	wordflag = wf;
 	mark = -1;
 	/* use operator-pending keymap if one exists */
-	Keymap km = openkeymap("viopp");
+	km = openkeymap("viopp");
 	if (km)
 	    selectlocalmap(km);
 	/* Now we need to execute the movement command, to see where it *
diff --git a/Src/params.c b/Src/params.c
index 6fbee88..451105a 100644
--- a/Src/params.c
+++ b/Src/params.c
@@ -4846,7 +4846,7 @@ arrfixenv(char *s, char **t)
 int
 zputenv(char *str)
 {
-    DPUTS(!str, "Attempt to put null string into environment.");
+    //DPUTS(!str, "Attempt to put null string into environment.");
 #ifdef USE_SET_UNSET_ENV
     /*
      * If we are using unsetenv() to remove values from the
diff --git a/configure.ac b/configure.ac
index ec0bdae..bad78f9 100644
--- a/configure.ac
+++ b/configure.ac
@@ -874,7 +874,7 @@ if test x$enable_cap = xyes; then
   AC_CHECK_LIB(cap, cap_get_proc)
 fi
 
-AC_CHECK_LIB(socket, socket)
+AC_CHECK_LIB(network, socket)
 AC_SEARCH_LIBS(gethostbyname2, bind)
 
 case $LIBS in
-- 
2.14.1


From 0cb932df2a1dfa8c2b3cd721eed1090f6d31c390 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zolt=C3=A1n=20Mizsei?= <zmizsei@extrowerk.com>
Date: Wed, 11 Jan 2017 18:17:20 +0100
Subject: Haiku rusage fix


diff --git a/Src/jobs.c b/Src/jobs.c
index 66dfb5a..47b0a64 100644
--- a/Src/jobs.c
+++ b/Src/jobs.c
@@ -940,7 +940,7 @@ should_report_time(Job j)
 #endif
     }
 
-#ifdef HAVE_GETRUSAGE
+#if defined(HAVE_GETRUSAGE) && !defined(__HAIKU__)
     if (reportmemory >= 0 &&
 	j->procs->ti.ru_maxrss / 1024 > reportmemory)
 	return 1;
-- 
2.14.1


From 882f59c478ca7f8f1367a85c3132fef9bae19151 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zolt=C3=A1n=20Mizsei?= <zmizsei@extrowerk.com>
Date: Mon, 14 Aug 2017 22:07:38 +0200
Subject: Dynamic loadable modules


diff --git a/configure.ac b/configure.ac
index bad78f9..36d90c5 100644
--- a/configure.ac
+++ b/configure.ac
@@ -695,7 +695,6 @@ AC_CHECK_HEADERS(sys/time.h sys/times.h sys/select.h termcap.h termio.h \
 		 ncurses/ncurses.h)
 if test x$dynamic = xyes; then
   AC_CHECK_HEADERS(dlfcn.h)
-  AC_CHECK_HEADERS(dl.h)
 fi
 
 dnl Some SCO systems cannot include both sys/time.h and sys/select.h
@@ -867,7 +866,7 @@ if test `echo $host_os | sed 's/^\(unicos\).*/\1/'` = unicos; then
 fi
 
 if test "x$dynamic" = xyes; then
-  AC_CHECK_LIB(dl, dlopen)
+  AC_CHECK_LIB(root, dlopen)
 fi
 
 if test x$enable_cap = xyes; then
@@ -1433,8 +1432,7 @@ else
 fi
 
 if test x$dynamic = xyes; then
-  AC_CHECK_FUNCS(dlopen dlerror dlsym dlclose load loadquery loadbind unload \
-		shl_load shl_unload shl_findsym)
+  AC_CHECK_FUNCS(dlopen dlerror dlsym dlclose)
 fi
 
 AH_TEMPLATE([XATTR_EXTRA_ARGS],
@@ -2746,19 +2744,7 @@ if test "$ac_cv_func_load"      = yes &&
 elif test "$ac_cv_func_dlopen"  != yes ||
      test "$ac_cv_func_dlsym"   != yes ||
      test "$ac_cv_func_dlerror" != yes; then
-  if test "$ac_cv_func_shl_load" != yes ||
-     test "$ac_cv_func_shl_unload" != yes ||
-     test "$ac_cv_func_shl_findsym" != yes; then
-    dynamic=no
-  elif test "x$dynamic" = xyes; then
-    hpuxdynamic=yes
-    DL_EXT="${DL_EXT=sl}"
-    dnl autoheader won't allow us to define anything which isn't
-    dnl going into a header, and we can't undefine anything, so
-    dnl just define this anyway and rely on the later tests to
-    dnl define DYNAMIC or not.
-    AC_DEFINE(HPUX10DYNAMIC)dnl
-  fi
+    dynamic=yes
 fi
 
 test -n "$GCC" && LDARG=-Wl,
@@ -2899,7 +2885,7 @@ char *argv[];
     aix*)         DLLDFLAGS="${DLLDFLAGS=-G -bexpall -lc}" ;;
     solaris*|sysv4*|esix*) DLLDFLAGS="${DLLDFLAGS=-G}" ;;
     darwin*)      DLLDFLAGS="${DLLDFLAGS=-bundle -flat_namespace -undefined suppress}" ;;
-    beos*|haiku*) DLLDFLAGS="${DLLDFLAGS=-nostart}" ;;
+    beos*|haiku*) DLLDFLAGS="${DLLDFLAGS=-shared}" ;;
     openbsd*)
       if test x$zsh_cv_sys_elf = xyes; then
 	DLLDFLAGS="${DLLDFLAGS=-shared -fPIC}"
@@ -3023,7 +3009,7 @@ main()
     exit(0);
 }], zsh_cv_func_dlsym_needs_underscore=`cat conftestval`,
     zsh_cv_func_dlsym_needs_underscore=failed
-    dynamic=no,
+    dynamic=yes,
     zsh_cv_func_dlsym_needs_underscore=no)])
   if test "x$zsh_cv_func_dlsym_needs_underscore" = xyes; then
     AC_DEFINE(DLSYM_NEEDS_UNDERSCORE)
@@ -3035,7 +3021,7 @@ fi
 
 if test "x$dynamic" = xyes; then
   zsh_SHARED_VARIABLE([environ], [char **])
-  test "$zsh_cv_shared_environ" = yes || dynamic=no
+  test "$zsh_cv_shared_environ" = yes || dynamic=yes
   if test "$ac_cv_func_tgetent" = yes; then
     zsh_SHARED_FUNCTION([tgetent])
   fi

-- 
2.14.1

