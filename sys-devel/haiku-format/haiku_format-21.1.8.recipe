SUMMARY="Code formatter for Haiku coding style"
DESCRIPTION="Format C/C++ code following the Haiku Coding Guidelines.

This is a superset of clang-format with extensions that implement the coding style followed by \
Haiku and several applications running on Haiku.

haiku-format looks for a configuration file '.haiku-format', going up the file hierarchy starting \
with the folder of the file you want to format. This optional configuration file can be used to \
override any default Haiku style options."
HOMEPAGE="https://github.com/owenca/haiku-format"
COPYRIGHT="2003-2019 University of Illinois at Urbana-Champaign
	2018-2026 Owen Pan"
LICENSE="Apache v2 with LLVM Exception"
REVISION="1"
srcGitRev="https://github.com/llvm/llvm-project/releases/download/llvmorg-$portVersion"
SOURCE_URI="$srcGitRev/clang-$portVersion.src.tar.xz"
CHECKSUM_SHA256="6090e3f23720d003cdd84483a47d0eec6d01adbb5e0c714ac0c8b58de546aa62"
SOURCE_DIR="clang-$portVersion.src"
SOURCE_URI_2="$srcGitRev/cmake-$portVersion.src.tar.xz"
CHECKSUM_SHA256_2="85735f20fd8c81ecb0a09abb0c267018475420e93b65050cc5b7634eab744de9"
SOURCE_DIR_2="cmake-$portVersion.src"
SOURCE_URI_3="$srcGitRev/llvm-$portVersion.src.tar.xz"
CHECKSUM_SHA256_3="d9022ddadb40a15015f6b27e6549a7144704ded8828ba036ffe4b8165707de21"
SOURCE_DIR_3="llvm-$portVersion.src"
SOURCE_URI_4="$srcGitRev/third-party-$portVersion.src.tar.xz"
CHECKSUM_SHA256_4="7fe99424384aea529ffaeec9cc9dfb8b451fd1852c03fc109e426fe208a1f1a7"
SOURCE_DIR_4="third-party-$portVersion.src"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	haiku_format$secondaryArchSuffix = $portVersion
	cmd:git_haiku_format = $portVersion
	cmd:haiku_format = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:ninja
	cmd:python3
	"

PATCH()
{
	diffFile="v$portVersion.diff"
	wget -nc https://raw.githubusercontent.com/owenca/haiku-format/refs/heads/master/$diffFile
	patch -p2 -r - < $diffFile
}

BUILD()
{
	cd $sourceDir3/..

	ln -fsv $sourceDir clang
	ln -fsv $sourceDir2 cmake
	ln -fsv $sourceDir3 llvm
	ln -fsv $sourceDir4 third-party

	cmake -Wno-dev -S llvm -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_SKIP_RPATH=On \
		-DLLVM_ENABLE_PROJECTS=clang \
		-DLLVM_TARGETS_TO_BUILD=X86

	ninja -C build clang-format
	strip -sv build/bin/clang-format

	rm -fv clang cmake llvm third-party
}

INSTALL()
{
	mkdir -pv $binDir
	cp -fv $sourceDir3/../build/bin/clang-format $binDir/haiku-format

	gitHaikuFormat="$binDir/git-haiku-format"
	sed s/clang-format/haiku-format/g tools/clang-format/git-clang-format > $gitHaikuFormat
	chmod -v +x $gitHaikuFormat
}
