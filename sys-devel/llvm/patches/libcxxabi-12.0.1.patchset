From b31a068366014b2cf9c1fe60bdf5b3545248e05d Mon Sep 17 00:00:00 2001
From: Trung Nguyen <trungnt282910@gmail.com>
Date: Sat, 9 Jul 2022 11:24:12 +0700
Subject: [libcxxabi] Initial support for Haiku

---
 cmake/config-ix.cmake | 11 ++++++++++-
 src/CMakeLists.txt    |  2 ++
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/cmake/config-ix.cmake b/cmake/config-ix.cmake
index 15b52083fe..ccd4c0d77b 100644
--- a/cmake/config-ix.cmake
+++ b/cmake/config-ix.cmake
@@ -4,7 +4,13 @@ include(CheckCCompilerFlag)
 include(CheckCXXCompilerFlag)
 include(CheckCSourceCompiles)
 
-check_library_exists(c fopen "" LIBCXXABI_HAS_C_LIB)
+if (HAIKU)
+  # Haiku uses libroot instead.
+  set(LIBCXX_HAS_C_LIB NO)
+  check_library_exists(root fopen "" LIBCXXABI_HAS_ROOT_LIB)
+else ()
+  check_library_exists(c fopen "" LIBCXXABI_HAS_C_LIB)
+endif ()
 if (NOT LIBCXXABI_USE_COMPILER_RT)
   if (ANDROID)
     check_library_exists(gcc __gcc_personality_v0 "" LIBCXXABI_HAS_GCC_LIB)
@@ -39,6 +45,9 @@ if (LIBCXXABI_HAS_NODEFAULTLIBS_FLAG)
       list(APPEND CMAKE_REQUIRED_LIBRARIES gcc)
     endif ()
   endif ()
+  if (HAIKU AND LIBCXXABI_HAS_ROOT_LIB)
+    list(APPEND CMAKE_REQUIRED_LIBRARIES root)
+  endif ()
   if (MINGW)
     # Mingw64 requires quite a few "C" runtime libraries in order for basic
     # programs to link successfully with -nodefaultlibs.
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index a8e12aa36e..e7e39bcbe2 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -67,6 +67,8 @@ endif()
 
 if (APPLE)
   add_library_flags_if(LIBCXXABI_HAS_SYSTEM_LIB System)
+elseif(HAIKU)
+  add_library_flags_if(LIBCXXABI_HAS_ROOT_LIB root)
 else()
   if (LIBCXXABI_ENABLE_THREADS)
     add_library_flags_if(LIBCXXABI_HAS_PTHREAD_LIB pthread)
-- 
2.35.0

