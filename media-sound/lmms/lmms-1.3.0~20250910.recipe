SUMMARY="Cross-platform music production software"
DESCRIPTION="LMMS is a free cross-platform alternative to commercial \
programs like FL StudioÂ®, which allow you to produce music with your \
computer. This includes the creation of melodies and beats, the \
synthesis and mixing of sounds, and arranging of samples. You can have fun \
with your MIDI-keyboard and much more; all in a user-friendly and modern \
interface."
HOMEPAGE="http://lmms.io/"
COPYRIGHT="2004-2020 Tobias Doerffel et al.
	2008-2025 LMMS Developers"
LICENSE="GNU GPL v2"
REVISION="1"
srcGitRev="2eea79bdd349a0b385c9a371e0dc6c8dccfc5b6d"
SOURCE_URI="https://github.com/LMMS/lmms/archive/$srcGitRev.tar.gz"
CHECKSUM_SHA256="129dd0ae3e0b12a65b5d56e9c5348c0c65f86285df66e2e1b0e9ed0c18a7bc7f"
SOURCE_FILENAME="lmms-$srcGitRev.tar.gz"
SOURCE_DIR="lmms-$srcGitRev"
srcGitRev_2="1c46ef34a28d4637b43fb6d5ebb31d38c05f4bd8"
SOURCE_URI_2="https://github.com/JohannesLorenz/ringbuffer/archive/$srcGitRev_2.tar.gz"
CHECKSUM_SHA256_2="5ff6e53da5f4929a23490c714852dc4ecc7746cef259ea600edb6bca742e29db"
SOURCE_FILENAME_2="ringbuffer-$srcGitRev_2.tar.gz"
srcGitRev_3="66afe24a08790732cc17d81d4b846a1e0cfa0118"
SOURCE_URI_3="https://github.com/falktx/carla/archive/$srcGitRev_3.tar.gz"
CHECKSUM_SHA256_3="9b0cab7b754201d8b08ee191424d30c64b0a618b12972e888aa7934a9f9218ce"
SOURCE_FILENAME_3="carla-$srcGitRev_3.tar.gz"
srcGitRev_4="21a064ea66a5cdf71910e207c4756095c266814f"
SOURCE_URI_4="https://github.com/libgme/game-music-emu/archive/$srcGitRev_4.tar.gz"
CHECKSUM_SHA256_4="a74a651411096d18ee0def3615475f00f382b59fe7a160b9c3420ef491f3e11e"
SOURCE_FILENAME_4="game-music-emu-$srcGitRev_4.tar.gz"
srcGitRev_5="3ed6617ec00022dfab574c27710d9071a6032c87"
SOURCE_URI_5="https://github.com/adplug/adplug/archive/$srcGitRev_5.tar.gz"
CHECKSUM_SHA256_5="6a5b3aa2e9034add840ccf1e9f25bdc1c52cc77006b38ba7e698a5a4b816bdde"
SOURCE_FILENAME_5="adplug-$srcGitRev_5.tar.gz"
srcGitRev_6="ef72462f5fa0682d099413512b764ae479e77f9b"
SOURCE_URI_6="https://github.com/libsidplayfp/resid/archive/$srcGitRev_6.tar.gz"
CHECKSUM_SHA256_6="6860580f4332137e0cf00dc4d11af38c939203436b857af1cbe0922bef7aa563"
SOURCE_FILENAME_6="libsidplayfp-$srcGitRev_6.tar.gz"
srcGitRev_7="a4b17d543f072d2e3ba564e4bc5c3a0d2b05c338"
SOURCE_URI_7="https://github.com/ArashPartow/exprtk/archive/$srcGitRev_7.tar.gz"
CHECKSUM_SHA256_7="95bde0602bb4d2569b31804ebea852fb4fc4a8471e5994f276ed77ea16fd4abe"
SOURCE_FILENAME_7="exprtk-$srcGitRev_7.tar.gz"
srcGitRev_8="66a42efcc72d4d75a70412795f1510c4297ab826"
SOURCE_URI_8="https://github.com/lmms/zynaddsubfx/archive/$srcGitRev_8.tar.gz"
CHECKSUM_SHA256_8="c894ff52f5ae465736d522ca3c01ef7dd5f3a7bcc0de8ebfd609b9feb8507bb2"
SOURCE_FILENAME_8="zynaddsubfx-$srcGitRev_8.tar.gz"
srcGitRev_9="789d0faf9faed430f48dfb93cf74e04afe88e39f"
SOURCE_URI_9="https://github.com/lmms/veal/archive/$srcGitRev_9.tar.gz"
CHECKSUM_SHA256_9="b1b6953c0a74c16219fc0dbb9f952928928849a371194c2388f466105a031b39"
SOURCE_FILENAME_9="veal-$srcGitRev_9.tar.gz"
srcGitRev_10="24599fb45b99fff6302136f13adb3817e5833e7d"
SOURCE_URI_10="https://github.com/lmms/cmt/archive/$srcGitRev_10.tar.gz"
CHECKSUM_SHA256_10="2289eba416c9eddec8458d4de0249f54632c3e5d2ae4291c7a814c978eff3781"
SOURCE_FILENAME_10="cmt-$srcGitRev_10.tar.gz"
srcGitRev_11="0f54d2430febb4d5f02d13132dd91d7345e080b5"
SOURCE_URI_11="https://github.com/swh/ladspa/archive/$srcGitRev_11.tar.gz"
CHECKSUM_SHA256_11="acc338dd1f9020d8a04cd73323eb0a72e6efec36b67ce30b41e853c59f01acc6"
SOURCE_FILENAME_11="swh-$srcGitRev_11.tar.gz"
srcGitRev_12="85640223047d49a305e90ba1b92303eb066ba474"
SOURCE_URI_12="https://github.com/lmms/tap-plugins/archive/$srcGitRev_12.tar.gz"
CHECKSUM_SHA256_12="ee28a2cca65dbcce39676b86eccc5a9e61707878a8437e45c1c103d80736eb8c"
SOURCE_FILENAME_12="tap-plugins-$srcGitRev_12.tar.gz"

ADDITIONAL_FILES="LMMS.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	lmms$secondaryArchSuffix = $portVersion
	cmd:lmms
	app:LMMS
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libfftw3f$secondaryArchSuffix
#	lib:libfltk$secondaryArchSuffix
#	lib:libfltk_forms$secondaryArchSuffix
#	lib:libfltk_images$secondaryArchSuffix
	lib:libfluidsynth$secondaryArchSuffix
	lib:liblilv_0$secondaryArchSuffix
	lib:libmp3lame$secondaryArchSuffix
	lib:libogg$secondaryArchSuffix
	lib:libmxml$secondaryArchSuffix
	lib:libportaudio$secondaryArchSuffix
	lib:libportmidi$secondaryArchSuffix
	lib:libQt5Core$secondaryArchSuffix
	lib:libQt5Gui$secondaryArchSuffix
	lib:libQt5Widgets$secondaryArchSuffix
	lib:libQt5Xml$secondaryArchSuffix
	lib:libsamplerate$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libsndfile$secondaryArchSuffix
#	lib:libsuil_0$secondaryArchSuffix
	lib:libvorbis$secondaryArchSuffix
	lib:libvorbisenc$secondaryArchSuffix
	lib:libvorbisfile$secondaryArchSuffix
	lib:libxml2$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	extra_cmake_modules$secondaryArchSuffix
	devel:libfftw3f$secondaryArchSuffix
	# Zyn sources not compatible with new fltk (known issue upstream)
#	devel:libfltk$secondaryArchSuffix
#	devel:libfltk_forms$secondaryArchSuffix
#	devel:libfltk_images$secondaryArchSuffix
	devel:libfluidsynth$secondaryArchSuffix >= 2
	devel:libgme$secondaryArchSuffix
	devel:liblilv_0$secondaryArchSuffix
	devel:libmp3lame$secondaryArchSuffix
	devel:libogg$secondaryArchSuffix
	devel:libmxml$secondaryArchSuffix
	devel:libportaudio$secondaryArchSuffix
	devel:libportmidi$secondaryArchSuffix
	devel:libQt5Core$secondaryArchSuffix
	devel:libQt5Gui$secondaryArchSuffix
	devel:libQt5Widgets$secondaryArchSuffix
	devel:libsamplerate$secondaryArchSuffix
	# no UI for LV2 yet for this
#	devel:libsuil_0$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libsndfile$secondaryArchSuffix
	devel:libvorbis$secondaryArchSuffix
	devel:libxcb$secondaryArchSuffix
	devel:libxml2$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	list_moreutils
	lv2$secondaryArchSuffix
	xml_parser
	cmd:cmake
	cmd:doxygen
	cmd:dot
#	cmd:fltk_config$commandSuffix
#	cmd:fluid$commandSuffix
	cmd:g++$secondaryArchSuffix
	cmd:make
	cmd:lrelease$secondaryArchSuffix >= 5
	cmd:perl
	cmd:pkg_config$secondaryArchSuffix
	"


BUILD()
{
	mkdir -p $sourceDir/src/3rdparty/ringbuffer
	mkdir -p $sourceDir/plugins/{CarlaBase/carla,FreeBoy/game-music-emu,OpulenZ/adplug,Sid/resid/resid,Xpressive/exprtk,ZynAddSubFx/zynaddsubfx}
	# 3rdparty
	cp -rf $sourceDir2/ringbuffer-$srcGitRev_2/* $sourceDir/src/3rdparty/ringbuffer
	# plugins
	cp -rf $sourceDir3/Carla-$srcGitRev_3/* $sourceDir/plugins/CarlaBase/carla
	cp -rf $sourceDir4/game-music-emu-$srcGitRev_4/* $sourceDir/plugins/FreeBoy/game-music-emu
	cp -rf $sourceDir5/adplug-$srcGitRev_5/* $sourceDir/plugins/OpulenZ/adplug
	cp -rf $sourceDir6/resid-$srcGitRev_6/* $sourceDir/plugins/Sid/resid/resid
	cp -rf $sourceDir7/exprtk-$srcGitRev_7/* $sourceDir/plugins/Xpressive/exprtk
	cp -rf $sourceDir8/zynaddsubfx-$srcGitRev_8/* $sourceDir/plugins/ZynAddSubFx/zynaddsubfx
	# Ladspa plugins
	cp -rf $sourceDir9/veal-$srcGitRev_9/* $sourceDir/plugins/LadspaEffect/calf/veal
	cp -rf $sourceDir10/cmt-$srcGitRev_10/* $sourceDir/plugins/LadspaEffect/cmt/cmt
	cp -rf $sourceDir11/ladspa-$srcGitRev_11/* $sourceDir/plugins/LadspaEffect/swh/ladspa
	cp -rf $sourceDir12/tap-plugins-$srcGitRev_12/* $sourceDir/plugins/LadspaEffect/tap/tap-plugins

	rm -rf $sourceDir/.gitmodules

	cmake -B build -S . -DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=$appsDir/LMMS \
		-DCMAKE_EXE_LINKER_FLAGS="-lnetwork" \
		-DWANT_QT5=ON \
		-DWANT_JACK=OFF \
		-DWANT_WEAKJACK=OFF \
		-DWANT_VST=OFF \
		-Wno-dev

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	mkdir -p $prefix/bin $dataDir/bash-completion/completions $manDir
	cp doc/bash-completion/lmms $dataDir/bash-completion/completions
	mv $appsDir/LMMS/bin/lmms $appsDir/LMMS/bin/LMMS
	ln -s $appsDir/LMMS/bin/LMMS $prefix/bin/lmms
	mv $appsDir/LMMS/share/man/man1 $manDir
	#cleanup
	rm -rf $appsDir/LMMS/share/{applications,icons,man}

	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3 | cut -d~ -f1`"
	local APP_NAME="LMMS"
	local LONG_INFO="$SUMMARY"
	local APP_SIGNATURE="application/x-vnd.lmmsio-lmms"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		-e "s|@APP_NAME@|$APP_NAME|" \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		$portDir/additional-files/LMMS.rdef.in > LMMS.rdef

	addResourcesToBinaries LMMS.rdef $appsDir/LMMS/bin/LMMS

	addAppDeskbarSymlink $appsDir/LMMS/bin/LMMS
}
