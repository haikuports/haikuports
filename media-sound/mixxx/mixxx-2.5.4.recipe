SUMMARY="Free and open source DJ software"
DESCRIPTION="Mixxx integrates the tools DJs need to perform creative live mixes with digital \
music files.
Whether you are a new DJ with just a laptop or an experienced turntablist, Mixxx can support \
your style and techniques of mixing.

Mixxx is available for Windows, macOS, and Linux as well."
HOMEPAGE="https://mixxx.org/"
COPYRIGHT="2001-2024 Mixxx Development Team"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="https://github.com/mixxxdj/mixxx/archive/refs/tags/$portVersion.tar.gz"
CHECKSUM_SHA256="53fb1a2a6c5ac6eb3562cb99c5bcae8777d81e48b96b5b3c292794c0c105b269"
SOURCE_FILENAME="mixxx-$portVersion.tar.gz"
PATCHES="mixxx-$portVersion.patchset"
libdjinteropVer="0.24.3"
SOURCE_URI_2="https://github.com/xsco/libdjinterop/archive/refs/tags/$libdjinteropVer.tar.gz#noarchive"
CHECKSUM_SHA256_2="df41fe39bed9d16d27a3649d237b68edd2cdb6fc71a82cae5cd746d4e4ef6578"
SOURCE_FILENAME_2="libdjinterop-$libdjinteropVer.tar.gz"
libkeyfinderVer="2.2.8"
SOURCE_URI_3="https://github.com/mixxxdj/libkeyfinder/archive/refs/tags/$libkeyfinderVer.zip#noarchive"
CHECKSUM_SHA256_3="4f10e9e5673d948776e47e78273fa4d61408155cb0e210af1538c83222f285d4"
SOURCE_FILENAME_3="libkeyfinder-$libkeyfinderVer.zip"
ADDITIONAL_FILES="mixxx.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	mixxx$secondaryArchSuffix = $portVersion
	app:Mixxx = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	ffmpeg6$secondaryArchSuffix
#	lib:libbenchmark$secondaryArchSuffix
	lib:libchromaprint$secondaryArchSuffix
	lib:libcrypto$secondaryArchSuffix
	lib:libebur128$secondaryArchSuffix
	lib:libfftw3$secondaryArchSuffix
	lib:libFLAC$secondaryArchSuffix
	lib:libGL$secondaryArchSuffix
	lib:libhidapi$secondaryArchSuffix
	lib:libid3tag$secondaryArchSuffix
	lib:liblilv_0$secondaryArchSuffix
	lib:libmad$secondaryArchSuffix
	lib:libmodplug$secondaryArchSuffix
	lib:libmp3lame$secondaryArchSuffix
	lib:libogg$secondaryArchSuffix
	lib:libopus$secondaryArchSuffix
	lib:libopusfile$secondaryArchSuffix
	lib:libportaudio$secondaryArchSuffix
	lib:libportmidi$secondaryArchSuffix
	lib:libprotobuf_lite$secondaryArchSuffix
	lib:libQt6Core$secondaryArchSuffix
	lib:libQt6DBus$secondaryArchSuffix
	lib:libQt6Core5Compat$secondaryArchSuffix
	lib:libQt6Gui$secondaryArchSuffix
	lib:libQt6Keychain$secondaryArchSuffix
	lib:libQt6Network$secondaryArchSuffix
	lib:libQt6OpenGL$secondaryArchSuffix
	lib:libQt6Qml$secondaryArchSuffix
	lib:libQt6Quick$secondaryArchSuffix
	lib:libQt6ShaderTools$secondaryArchSuffix
	lib:libQt6Sql$secondaryArchSuffix
	lib:libQt6Svg$secondaryArchSuffix
	lib:libQt6Test$secondaryArchSuffix
	lib:libQt6Widgets$secondaryArchSuffix
	lib:libQt6Xml$secondaryArchSuffix
	lib:librubberband$secondaryArchSuffix
	lib:libsndfile$secondaryArchSuffix
	lib:libSoundTouch$secondaryArchSuffix
	lib:libsqlite3$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libtag$secondaryArchSuffix
	lib:libusb_1.0$secondaryArchSuffix
	lib:libvorbis$secondaryArchSuffix
	lib:libvorbisfile$secondaryArchSuffix
	lib:libvorbisenc$secondaryArchSuffix
	lib:libwavpack$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	ffmpeg6${secondaryArchSuffix}_devel
	devel:ms_gsl
#	devel:libbenchmark$secondaryArchSuffix
	devel:libchromaprint$secondaryArchSuffix
	devel:libcrypto$secondaryArchSuffix >= 3
	devel:libebur128$secondaryArchSuffix
	devel:libfftw3$secondaryArchSuffix
	devel:libFLAC$secondaryArchSuffix
	devel:libGL$secondaryArchSuffix
	devel:libgtest$secondaryArchSuffix
	devel:libhidapi$secondaryArchSuffix
	devel:libid3tag$secondaryArchSuffix
	devel:liblilv_0$secondaryArchSuffix
	devel:libmad$secondaryArchSuffix
	devel:libmodplug$secondaryArchSuffix
	devel:libmp3lame$secondaryArchSuffix
	devel:libogg$secondaryArchSuffix
	devel:libopusfile$secondaryArchSuffix
	devel:libportaudio$secondaryArchSuffix
	devel:libportmidi$secondaryArchSuffix
	devel:libprotobuf$secondaryArchSuffix >= 31
	devel:libQt6Core$secondaryArchSuffix
	devel:libQt6Core5Compat$secondaryArchSuffix
	devel:libQt6Keychain$secondaryArchSuffix
	devel:libQt6Qml$secondaryArchSuffix
	devel:libQt6ShaderTools$secondaryArchSuffix
	devel:libQt6Svg$secondaryArchSuffix
	devel:librubberband$secondaryArchSuffix >= 3
	devel:libsndfile$secondaryArchSuffix
	devel:libsoundtouch$secondaryArchSuffix
	devel:libsqlite3$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix >= 3
	devel:libtag$secondaryArchSuffix >= 2.0
	devel:libusb_1.0$secondaryArchSuffix
	devel:libvorbis$secondaryArchSuffix
	devel:libwavpack$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
#	cmd:dia
	cmd:dot
	cmd:doxygen
	cmd:gcc$secondaryArchSuffix
	cmd:lld >= 20
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	mkdir -p build/downloads
	cp $sourceDir2/libdjinterop-$libdjinteropVer.tar.gz build/downloads
	cp $sourceDir3/libkeyfinder-$libkeyfinderVer.zip build/downloads

	export LDFLAGS="-lnetwork"
	cmake -B build -S . -DCMAKE_BUILD_TYPE=Release \
		$cmakeDirArgs \
		-D CMAKE_INSTALL_BINDIR=$appsDir \
		-D CMAKE_DISABLE_PRECOMPILE_HEADERS=ON \
		-D QT_NO_PRIVATE_MODULE_WARNING=ON \
		-D BATTERY=OFF \
		-D BUILD_TESTING=OFF \
		-W no-dev

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	mv $appsDir/mixxx $appsDir/Mixxx

	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	local APP_NAME="Mixxx"
	local LONG_INFO="$SUMMARY"
	local APP_SIGNATURE="application/x-vnd.qt6-mixx"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		-e "s|@APP_NAME@|$APP_NAME|" \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		$portDir/additional-files/mixxx.rdef.in > mixxx.rdef

	addResourcesToBinaries mixxx.rdef $appsDir/Mixxx
	addAppDeskbarSymlink $appsDir/Mixxx
}

TEST()
{
	make -C build test
}
