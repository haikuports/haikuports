SUMMARY="Free Lossless Image Format"
DESCRIPTION="FLIF is a lossless image format based on MANIAC compression. \
MANIAC (Meta-Adaptive Near-zero Integer Arithmetic Coding) is a variant of \
CABAC (context-adaptive binary arithmetic coding), where the contexts are \
nodes of decision trees which are dynamically learned at encode time.

FLIF outperforms PNG, FFV1, lossless WebP, lossless BPG and lossless \
JPEG2000 in terms of compression ratio.

Moreover, FLIF supports a form of progressive interlacing (essentially a \
generalization/improvement of PNG's Adam7) which means that any prefix \
(e.g. partial download) of a compressed file can be used as a reasonable \
lossy encoding of the entire image."
HOMEPAGE="https://flif.info/"
COPYRIGHT="2016 Jon Sneyers
	Pieter Wuille"
LICENSE="Apache v2
	GNU GPL v3
	GNU LGPL v3"
REVISION="1"
srcGitRev="74ea92bf1ab2db18ae6d2a521dff946fcc679618"
SOURCE_URI="https://github.com/FLIF-hub/FLIF/archive/$srcGitRev.tar.gz"
CHECKSUM_SHA256="aeeb4d24f19204f2b0cecc41ee1ebdda1c1ae730f0c6fa4969f67aab7e5eccac"
SOURCE_FILENAME="flif-$portVersion-$srcGitRev.tar.gz"
SOURCE_DIR="FLIF-$srcGitRev"

ARCHITECTURES="!x86_gcc2 x86 x86_64"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	flif$secondaryArchSuffix = $portVersion
	cmd:apng2flif = $portVersion
	cmd:dflif = $portVersion
	cmd:flif = $portVersion
	cmd:gif2flif = $portVersion
	cmd:viewflif = $portVersion
	lib:libflif$secondaryArchSuffix = 0
	lib:libflif_dec$secondaryArchSuffix = 0
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libGL$secondaryArchSuffix
	lib:libpng16$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

PROVIDES_devel="
	flif${secondaryArchSuffix}_devel = $portVersion
	devel:libflif$secondaryArchSuffix = 0
	devel:libflif_dec$secondaryArchSuffix = 0
	"
REQUIRES_devel="
	flif$secondaryArchSuffix == $portVersion base
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libpng16$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:convert$secondaryArchSuffix
	cmd:gcc$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	cd src
	cmake . $cmakeDirArgs
	sed -i 's/;-ltdl//g' CMakeCache.txt
	sed -i 's/;ltdl//g' CMakeCache.txt

	make $jobArgs
}

INSTALL()
{
	cd src
	make install

	# move headers
	mkdir -p $includeDir
	mv $prefix/include/* $includeDir
	rm -rf $prefix/include

	# move libs for secondaryArchSuffix
	if [ "$targetArchitecture" = x86_gcc2 ]; then
		mv $prefix/lib $prefix/lib2
		mkdir $(dirname $libDir)
		mv $prefix/lib2 $libDir
	fi

	prepareInstalledDevelLibs libflif libflif_dec

	mkdir -p "$developLibDir"/pkgconfig
	cat > "$developLibDir"/pkgconfig/flif.pc << EOF
prefix=${prefix}
exec_prefix=${prefix}
libdir=${libDir}
includedir=${includeDir}

Name: flif
Description: Free Lossless Image Format
Version: ${portVersion}
Libs: -L${developLibDir} -lflif -lflif_dec
Cflags: -I${includeDir}
EOF

	packageEntries devel \
		$developDir
}

TEST()
{
	cd src
	make test
}
