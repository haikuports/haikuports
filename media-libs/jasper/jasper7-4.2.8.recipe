SUMMARY="Implementation of the codec specified in the JPEG-2000 Part-1 standard"
DESCRIPTION="The JasPer Project is an open-source initiative to provide a \
free software-based reference implementation of the codec specified in the \
JPEG-2000 Part-1 standard. More details about this software can be found in \
the JasPer Software Reference Manual."
HOMEPAGE="http://www.ece.uvic.ca/~frodo/jasper/"
COPYRIGHT="1999-2021 Michael D. Adams"
LICENSE="JasPer v2"
REVISION="2"
SOURCE_URI="https://github.com/jasper-software/jasper/archive/refs/tags/version-$portVersion.tar.gz"
CHECKSUM_SHA256="987e8c8b4afcff87553833b6f0fa255b5556a0ecc617b45ee1882e10c1b5ec14"
SOURCE_DIR="jasper-version-$portVersion"

ARCHITECTURES="ALL !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

libVersion="7.0.0"
libVersionCompat="$libVersion compat >= ${libVersion%%.*}"

PROVIDES="
	jasper7$secondaryArchSuffix = $portVersion
	lib:libjasper$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libjpeg$secondaryArchSuffix
	"

PROVIDES_devel="
	jasper7${secondaryArchSuffix}_devel = $portVersion
	devel:libjasper$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES_devel="
	jasper7$secondaryArchSuffix == $portVersion base
	"
CONFLICTS_devel="
	jasper${secondaryArchSuffix}_devel
	"

ARCHITECTURES_doc="any"
PROVIDES_doc="
	jasper7_doc
	"

if [ -z "$secondaryArchSuffix" ]; then
	SUMMARY_tools="The jasper tools"
	PROVIDES_tools="
		jasper7${secondaryArchSuffix}_tools = $portVersion
		cmd:imgcmp$secondaryArchSuffix = $portVersion
		cmd:imginfo$secondaryArchSuffix = $portVersion
		cmd:jasper$secondaryArchSuffix = $portVersion
		cmd:jiv$secondaryArchSuffix = $portVersion
		"
	REQUIRES_tools="
		jasper7$secondaryArchSuffix == $portVersion base
		haiku$secondaryArchSuffix
		lib:libGL$secondaryArchSuffix
		lib:libglu$secondaryArchSuffix
		lib:libjpeg$secondaryArchSuffix
		"
fi

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libGL$secondaryArchSuffix
	devel:libglu$secondaryArchSuffix
	devel:libjpeg$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:doxygen
	cmd:dot
	cmd:gcc$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

TEST_REQUIRES="
	cmd:awk
	"

BUILD()
{
	cmake -B buildJ -S . -DCMAKE_BUILD_TYPE=Release \
		$cmakeDirArgs \
		-DCMAKE_INSTALL_DOCDIR=$documentationDir/packages/jasper \
		-DJAS_ENABLE_AUTOMATIC_DEPENDENCIES=OFF \
		-DCMAKE_SKIP_RPATH=ON \
		-DJAS_ENABLE_OPENGL=ON \
		-DALLOW_IN_SOURCE_BUILD=TRUE

	make -C buildJ
}

INSTALL()
{
	make -C buildJ install

	sed  -i "1i prefix=$prefix" \
		$libDir/pkgconfig/jasper.pc

	prepareInstalledDevelLib libjasper
	fixPkgconfig

	# devel package
	packageEntries devel \
		$developDir

	# doc package
	packageEntries doc \
		$documentationDir/packages

	# tools package
	if [ -z "$secondaryArchSuffix" ]; then
		packageEntries tools \
			$binDir \
			$documentationDir
	fi

	# Remove stuff we don't need in the secondary architecture base package.
	if [ -n "$secondaryArchSuffix" ]; then
		rm -rf $prefix/bin
		rm -rf $documentationDir
	fi
}

TEST()
{
	export LIBRARY_PATH="$sourceDir/build/src/libjasper${LIBRARY_PATH:+:$LIBRARY_PATH}"
	make -C build test
}
