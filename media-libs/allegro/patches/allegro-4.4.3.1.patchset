From 56050788732681dcb87582db8b7f63d1bc36461c Mon Sep 17 00:00:00 2001
From: Adrien Destugues <pulkomandy@pulkomandy.tk>
Date: Sat, 30 Nov 2013 12:14:54 +0100
Subject: Import Allegro 4.4.1.1 fixes that were not upstreamed.


diff --git a/CMakeLists.txt b/CMakeLists.txt
index d661bd9..8a7f4da 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -287,7 +287,7 @@ if(APPLE)
     endif(COMPILER_GCC)
 endif(APPLE)
 
-if(BEOS)
+if(BEOS OR HAIKU)
     if(CMAKE_SYSTEM_NAME STREQUAL Haiku)
         set(ALLEGRO_HAIKU 1)
     else(CMAKE_SYSTEM_NAME STREQUAL Haiku)
@@ -296,9 +296,9 @@ if(BEOS)
     set(WFLAGS "-W -Wall -Wno-unused -Wno-multichar")
     set(WFLAGS_C_ONLY "")
     set(WFLAGS_CXX_ONLY "-Wno-ctor-dtor-privacy")
-endif(BEOS)
+endif()
 
-if(UNIX AND NOT APPLE AND NOT BEOS)
+if(UNIX AND NOT APPLE AND NOT BEOS AND NOT HAIKU)
     set(ALLEGRO_UNIX 1)
 endif()
 
@@ -634,10 +634,10 @@ endif(WIN32)
 
 # -- Haiku/BeOS --
 
-if(BEOS)
+if(BEOS OR HAIKU)
     list(APPEND PLATFORM_SOURCES ${ALLEGRO_SRC_BEOS_FILES})
     list(APPEND PLATFORM_LIBS game midi device)
-endif(BEOS)
+endif()
 
 # -- Mac OS X --
 
diff --git a/cmake/Common.cmake b/cmake/Common.cmake
index 41822dd..1b89f7e 100644
--- a/cmake/Common.cmake
+++ b/cmake/Common.cmake
@@ -43,7 +43,11 @@ endfunction(install_our_library)
 function(install_our_headers)
     foreach(hdr ${ARGN})
         get_source_file_property(LOC ${hdr} MACOSX_PACKAGE_LOCATION)
-        string(REGEX REPLACE "^Headers" "include" LOC ${LOC})
+		if(HAIKU)
+        	string(REGEX REPLACE "^Headers" "develop/headers" LOC ${LOC})
+		else()
+        	string(REGEX REPLACE "^Headers" "include" LOC ${LOC})
+        endif()
         install(FILES ${hdr} DESTINATION ${LOC})
     endforeach()
 endfunction(install_our_headers)
diff --git a/src/beos/bsysapi.cpp b/src/beos/bsysapi.cpp
index c6e4dad..a7c9d46 100644
--- a/src/beos/bsysapi.cpp
+++ b/src/beos/bsysapi.cpp
@@ -128,7 +128,7 @@ static int32 system_thread(void *data)
       using_custom_allegro_app = false;
 
       term = getenv("TERM");
-      if (!strcmp(term, "dumb")) {
+      if (!term || !strcmp(term, "dumb")) {
          /* The TERM environmental variable is set to "dumb" if the app was
           * not started from a terminal.
           */
-- 
2.52.0


From dd3a6d68e5eaa5a790713100e3accbc84d12908d Mon Sep 17 00:00:00 2001
From: Adrien Destugues <pulkomandy@pulkomandy.tk>
Date: Thu, 25 Sep 2014 11:09:14 +0200
Subject: Hack install dirfor binaries.


diff --git a/CMakeLists.txt b/CMakeLists.txt
index 8a7f4da..a6a6366 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -899,7 +899,7 @@ if(UNIX) # including MACOSX
         )
 
     install(PROGRAMS ${CMAKE_BINARY_DIR}/allegro-config
-            DESTINATION bin
+            DESTINATION bin${LIB_SUFFIX}
             )
 endif(UNIX)
 
diff --git a/tools/CMakeLists.txt b/tools/CMakeLists.txt
index 170c3b4..d6d1bef 100644
--- a/tools/CMakeLists.txt
+++ b/tools/CMakeLists.txt
@@ -48,7 +48,7 @@ target_link_libraries(aldat allegro ${ALDAT_JPGALLEG})
 function(add_our_tool nm)
     add_our_executable(${nm} ${nm}.c ${ARGN})
     install(TARGETS ${nm}
-	    DESTINATION bin
+	    DESTINATION bin${LIB_SUFFIX}
 	    )
 endfunction()
 
@@ -69,7 +69,7 @@ target_link_libraries(pat2dat aldat)
 add_our_executable(grabber WIN32 grabber.c)
 target_link_libraries(grabber aldat)
 install(TARGETS grabber
-        DESTINATION bin
+        DESTINATION bin${LIB_SUFFIX}
         )
 
 #-----------------------------------------------------------------------------#
-- 
2.52.0


From e815145bfee4abe4996dd22c271bae7891360090 Mon Sep 17 00:00:00 2001
From: Adrien Destugues <pulkomandy@pulkomandy.tk>
Date: Thu, 12 Nov 2015 23:02:46 +0100
Subject: Remove useless check of the keyboard id

* Why not accept different keyboard types?

diff --git a/src/beos/bkeyapi.cpp b/src/beos/bkeyapi.cpp
index 302f353..74a672f 100644
--- a/src/beos/bkeyapi.cpp
+++ b/src/beos/bkeyapi.cpp
@@ -26,8 +26,6 @@
 #error something is wrong with the makefile
 #endif                
 
-#define KEY_ID_PC101 0 // the docs say it should be 0x83ab, but they lie
-
 #define KEY_SEMAPHORE_NAME "keyboard driver waiting..."
 
 #define KEY_THREAD_PERIOD   33333             // microseconds, 1/30th of a second
@@ -44,8 +42,6 @@
 #define PREFIX_W                "al-bkey WARNING: "
 #define PREFIX_E                "al-bkey ERROR: "
 
-static uint16 keyboard_id = (uint16)(-1);
-
 static volatile int keyboard_thread_running = FALSE;
 static thread_id    keyboard_thread_id      = -1;
 
@@ -299,14 +295,6 @@ extern "C" int be_key_init(void)
 
    _pckeys_init();
 
-   if (get_keyboard_id(&keyboard_id) == B_ERROR) {
-      goto cleanup;
-   }
-
-   if (keyboard_id != KEY_ID_PC101) {
-      goto cleanup;
-   }
-
    waiting_for_input = create_sem(0, "waiting for input...");
 
    if (waiting_for_input < B_NO_ERROR) {
@@ -363,8 +351,6 @@ extern "C" void be_key_exit(void)
       delete_sem(waiting_for_input);
       waiting_for_input = -1;
    }
-
-   keyboard_id = (uint16)(-1);
 }
 
 
-- 
2.52.0


From 9e985a9b5ca55b06ec8c5e71b4abfb7fbbe5cb6d Mon Sep 17 00:00:00 2001
From: begasus <begasus@gmail.com>
Date: Sat, 11 May 2019 10:44:07 +0200
Subject: Enabel liballeggl for Haiku


diff --git a/addons/allegrogl/CMakeLists.txt b/addons/allegrogl/CMakeLists.txt
index 36cfcc3..f306586 100644
--- a/addons/allegrogl/CMakeLists.txt
+++ b/addons/allegrogl/CMakeLists.txt
@@ -7,7 +7,7 @@ find_package(OpenGL)
 if(NOT OPENGL_FOUND)
     return()
 endif()
-if(UNIX AND NOT APPLE)
+if(UNIX AND NOT APPLE AND NOT HAIKU)
     find_package(X11)
     if(NOT X11_FOUND)
 	return()
diff --git a/addons/allegrogl/include/alleggl.h b/addons/allegrogl/include/alleggl.h
index fa36c98..8e64b34 100644
--- a/addons/allegrogl/include/alleggl.h
+++ b/addons/allegrogl/include/alleggl.h
@@ -462,6 +462,11 @@ AGL_FUNC(void, allegro_gl_load_settings, (void));
   #define GFX_OPENGL_WINDOWED               AL_ID('O','G','L','W')
   #define GFX_OPENGL_FULLSCREEN             AL_ID('O','G','L','F')
 
+#elif defined ALLEGRO_HAIKU
+  /* Haiku always supports fullscreen */
+  #define GFX_OPENGL_WINDOWED               AL_ID('O','G','L','W')
+  #define GFX_OPENGL_FULLSCREEN             AL_ID('O','G','L','F')
+
 #else
   #warning Unknown or unsupported platform.
 #endif
-- 
2.52.0


From 963c40b8118db9c460c8d9123fcd71d6b2e360cc Mon Sep 17 00:00:00 2001
From: Oscar Lesta <oscar.lesta@gmail.com>
Date: Mon, 5 Jan 2026 02:35:33 -0300
Subject: Use parenthesis around negated value.


diff --git a/src/beos/bwindow.cpp b/src/beos/bwindow.cpp
index 61a1885..a089205 100644
--- a/src/beos/bwindow.cpp
+++ b/src/beos/bwindow.cpp
@@ -119,7 +119,7 @@ extern "C" void be_gfx_bwindow_release(struct BITMAP *bmp)
  */
 extern "C" uintptr_t _be_gfx_bwindow_read_write_bank(BITMAP *bmp, int line)
 {
-   if (!bmp->id & BMP_ID_LOCKED) {
+   if (!(bmp->id & BMP_ID_LOCKED)) {
       bmp->id |= (BMP_ID_LOCKED | BMP_ID_AUTOLOCK);
    }
    _be_dirty_lines[bmp->y_ofs + line] = 1;
-- 
2.52.0


From fc5f81dd59d968419c723d7d289e1041b22658dc Mon Sep 17 00:00:00 2001
From: Oscar Lesta <oscar.lesta@gmail.com>
Date: Mon, 5 Jan 2026 06:17:19 -0300
Subject: Attempt to get the correct app signature from resources.

Also, make sure to instantiate a BeAllegroApp, if _be_allegro_app is
null, before attempting to call Run() on it (this seems to fix the
instant crash on startup on x86_64).

diff --git a/src/beos/bsysapi.cpp b/src/beos/bsysapi.cpp
index a7c9d46..b129450 100644
--- a/src/beos/bsysapi.cpp
+++ b/src/beos/bsysapi.cpp
@@ -113,8 +113,34 @@ static int32 system_thread(void *data)
 {
    (void)data;
 
-   if (_be_allegro_app == NULL) {
-      char sig[MAXPATHLEN] = "application/x-vnd.Allegro-";
+   if (_be_allegro_app != NULL) {
+      using_custom_allegro_app = true;
+      _be_allegro_app->Run();
+      return 0;
+   }
+
+   using_custom_allegro_app = false;
+   char* signature = NULL;
+
+   // Try getting the correct signature from the binary's resources:
+   image_info info;
+   int32 cookie = 0;
+   if (get_next_image_info(B_CURRENT_TEAM, &cookie, &info) == B_OK) {
+      BFile f(info.name, O_RDONLY);
+      if (f.InitCheck() == B_OK) {
+         BAppFileInfo app_info(&f);
+         if (app_info.InitCheck() == B_OK) {
+            char sig[B_MIME_TYPE_LENGTH];
+            if (app_info.GetSignature(sig) == B_OK)
+               signature = strndup(sig, B_MIME_TYPE_LENGTH);
+         }
+      }
+   }
+
+   // If no signature was found, try to add a "good enough one":
+   if (signature == NULL) {
+      // default application signature
+      char sig[B_MIME_TYPE_LENGTH] = "application/x-vnd.Allegro-";
       char exe[MAXPATHLEN];
       char *term, *p;
 
@@ -123,9 +149,7 @@ static int32 system_thread(void *data)
       strncat(sig, get_filename(exe), sizeof(sig)-1);
       sig[sizeof(sig)-1] = '\0';
 
-      _be_allegro_app = new BeAllegroApp(sig);
-
-      using_custom_allegro_app = false;
+      signature = strndup(sig, B_MIME_TYPE_LENGTH);
 
       term = getenv("TERM");
       if (!term || !strcmp(term, "dumb")) {
@@ -138,16 +162,14 @@ static int32 system_thread(void *data)
          _al_sane_strncpy(app_path, exe, MAXPATHLEN);
       }
    }
-   else {
-      using_custom_allegro_app = true;
-   }
 
+   _be_allegro_app = new BeAllegroApp(signature);
+   free(signature);
    _be_allegro_app->Run();
 
    /* XXX commented out due to conflicting TRACE in Haiku
    TRACE(PREFIX_I "system thread exited\n");
    */
-
    return 0;
 }
 
-- 
2.52.0

