SUMMARY="Cross-Platform MIDI IO"
DESCRIPTION="PortMidi is a cross-platform MIDI input/output library."
HOMEPAGE="https://github.com/PortMidi/portmidi"
COPYRIGHT="1999-2000 Ross Bencina and Phil Burk
	2001-2009 Roger B. Dannenberg"
LICENSE="MIT"
REVISION="1"
srcGitRev="7db20989f1571b27bd01cf9418361e988bdcf99a"
SOURCE_URI="https://github.com/PortMidi/portmidi/archive/$srcGitRev.tar.gz"
CHECKSUM_SHA256="96872e3c89339c9cbe44d5d86de1745ced7d803563a3ef71840aa9b120497e60"
SOURCE_DIR="portmidi-$srcGitRev"
ADDITIONAL_FILES="pmdefaults.rdef.in"

ARCHITECTURES="all"
SECONDARY_ARCHITECTURES="x86"

portVersionCompat="$portVersion compat >= ${portVersion%%.*}"

PROVIDES="
	portmidi$secondaryArchSuffix = $portVersion
	lib:libportmidi$secondaryArchSuffix = $portVersionCompat
	"
REQUIRES="
	haiku${secondaryArchSuffix}
	"

PROVIDES_devel="
	portmidi${secondaryArchSuffix}_devel = $portVersion
	devel:libpmjni$secondaryArchSuffix = $portVersionCompat
	devel:libportmidi$secondaryArchSuffix = $portVersionCompat
	"
REQUIRES_devel="
	portmidi$secondaryArchSuffix == $portVersion base
	portmidi${secondaryArchSuffix}_java == $portVersion
	"

PROVIDES_java="
	portmidi${secondaryArchSuffix}_java = $portVersion
	lib:libpmjni$secondaryArchSuffix = $portVersionCompat
	"
REQUIRES_java="
	haiku${secondaryArchSuffix}
	portmidi$secondaryArchSuffix == $portVersion base
	cmd:java
	java:runtime
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	java:environment
	"

BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc${secondaryArchSuffix}
	cmd:javac
	cmd:ld${secondaryArchSuffix}
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	source /system/data/profile.d/openjdk.sh

	mkdir -p build
	cd build
	cmake -DCMAKE_BUILD_TYPE=Release $cmakeDirArgs \
		-DBUILD_PORTMIDI_TESTS=ON -DBUILD_JAVA_NATIVE_INTERFACE=ON -DBUILD_PMDEFAULTS=ON \
		..
	make $jobArgs
}

INSTALL()
{
	cd build
	make install
	cd ..

	cp pm_java/pmdefaults/pmdefaults.jar $libDir

	mkdir $preferencesDir
	cat <<- EOF > "$preferencesDir/PortMidi Setup"
	#!/bin/sh
	java -jar $libDir/pmdefaults.jar > /dev/null
	EOF

	chmod +x "$preferencesDir/PortMidi Setup"

	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3 | cut -d~ -f1`"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		$portDir/additional-files/pmdefaults.rdef.in \
			> pmdefaults.rdef

	rc pmdefaults.rdef
	settype -t application/x-vnd.Be-elfexecutable "$preferencesDir/PortMidi Setup"
	resattr -o "$preferencesDir/PortMidi Setup" pmdefaults.rsrc

	prepareInstalledDevelLibs libportmidi libpmjni

	fixPkgconfig

	# the java bindings need an unversioned libpmjni.so
	ln -s libpmjni.so.${portVersion%~*} $libDir/libpmjni.so

	addPreferencesDeskbarSymlink "$preferencesDir/PortMidi Setup"

	packageEntries devel \
		$developDir \
		$libDir/cmake

	packageEntries java \
		$libDir/libpmjni.so* \
		$libDir/pmdefaults.jar \
		"$preferencesDir/PortMidi Setup" \
		$dataDir # this contains the Deskbar symlink
}

TEST()
{
	# the tests are individual commands that need to be run interactively
	true
}
