SUMMARY="A library for encoding and decoding WebP image files"
DESCRIPTION="WebP is an image format that provides lossless and lossy \
compression for images on the web. WebP lossless images are 26% smaller in \
size compared to PNGs. WebP lossy images are 25-34% smaller in size \
compared to JPEG images at equivalent SSIM index.
WebP supports lossless transparency (also known as alpha channel) with \
just 22% additional bytes. Transparency is also supported with lossy \
compression and typically provides 3x smaller file sizes compared to \
PNG when lossy compression is acceptable for the red/green/blue color \
channels."
HOMEPAGE="https://developers.google.com/speed/webp"
COPYRIGHT="2011-2025 Google Inc."
LICENSE="BSD (3-clause)"
REVISION="2"
SOURCE_URI="http://downloads.webmproject.org/releases/webp/libwebp-$portVersion.tar.gz"
CHECKSUM_SHA256="e4ab7009bf0629fd11982d4c2aa83964cf244cffba7347ecd39019a9e38c4564"
PATCHES="libwebp-$portVersion.patchset"

ARCHITECTURES="all"
SECONDARY_ARCHITECTURES="x86"

# On x86_gcc2 we don't want to install the commands in bin/<arch>/, but in bin/.
commandBinDir=$binDir
commandSuffix=$secondaryArchSuffix
if [ "$targetArchitecture" = x86_gcc2 ]; then
	commandSuffix=
	commandBinDir=$prefix/bin
fi

webpLibs="\
	libsharpyuv \
	libwebp \
	libwebpdecoder \
	libwebpdemux \
	libwebpmux \
	"
libsharpyuvVersion="0.1.2"
libwebpVersion="7.2.0"
libwebpdecoderVersion="3.2.0"
libwebpdemuxVersion="2.0.17"
libwebpmuxVersion="3.1.2"
for i in $webpLibs; do
	eval "${i}VersionCompat=\"\$${i}Version compat >= \${${i}Version%%.*}\""
done

PROVIDES="
	libwebp$secondaryArchSuffix = $portVersion
	lib:libsharpyuv$secondaryArchSuffix = $libsharpyuvVersionCompat
	lib:libwebp$secondaryArchSuffix = $libwebpVersionCompat
	lib:libwebpdecoder$secondaryArchSuffix = $libwebpdecoderVersionCompat
	lib:libwebpdemux$secondaryArchSuffix = $libwebpdemuxVersionCompat
	lib:libwebpmux$secondaryArchSuffix = $libwebpmuxVersionCompat
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libgif$secondaryArchSuffix
	lib:libjpeg$secondaryArchSuffix
	lib:libpng16$secondaryArchSuffix
	lib:libtiff$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

PROVIDES_devel="
	libwebp${secondaryArchSuffix}_devel = $portVersion
	devel:libsharpyuv$secondaryArchSuffix = $libsharpyuvVersionCompat
	devel:libwebp$secondaryArchSuffix = $libwebpVersionCompat
	devel:libwebpdecoder$secondaryArchSuffix = $libwebpdecoderVersionCompat
	devel:libwebpdemux$secondaryArchSuffix = $libwebpdemuxVersionCompat
	devel:libwebpmux$secondaryArchSuffix = $libwebpmuxVersionCompat
	"
REQUIRES_devel="
	libwebp$secondaryArchSuffix == $portVersion base
	"

PROVIDES_tools="
	libwebp${secondaryArchSuffix}_tools = $portVersion
	cmd:cwebp$commandSuffix
	cmd:dwebp$commandSuffix
	cmd:gif2webp$commandSuffix
	cmd:img2webp$commandSuffix
	cmd:webpinfo$commandSuffix
	cmd:webpmux$commandSuffix
	"
REQUIRES_tools="
	libwebp$secondaryArchSuffix == $portVersion base
	$REQUIRES
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libgif$secondaryArchSuffix >= 7
	devel:libjpeg$secondaryArchSuffix
	devel:libpng16$secondaryArchSuffix
#	devel:libSDL_1.2$secondaryArchSuffix
	devel:libtiff$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:make
	"

defineDebugInfoPackage libwebp$secondaryArchSuffix \
	"$(getPackagePrefix tools)"/bin/cwebp \
	"$(getPackagePrefix tools)"/bin/dwebp \
	"$(getPackagePrefix tools)"/bin/gif2webp \
	"$(getPackagePrefix tools)"/bin/img2webp \
	"$(getPackagePrefix tools)"/bin/webpinfo \
	"$(getPackagePrefix tools)"/bin/webpmux \
	"$libDir"/libwebp.so.$libwebpVersion \
	"$libDir"/libwebpdecoder.so.$libwebpdecoderVersion \
	"$libDir"/libwebpdemux.so.$libwebpdemuxVersion \
	"$libDir"/libwebpmux.so.$libwebpmuxVersion

BUILD()
{
	cmake -B build -S . -DCMAKE_BUILD_TYPE=RelWithDebInfo \
		$cmakeDirArgs \
		-DCMAKE_INSTALL_BINDIR=$commandBinDir \
		-DBUILD_SHARED_LIBS=ON \
		-DWEBP_BUILD_VWEBP=OFF

	# Mimic autotools build without --enable-asserts
	CFLAGS+=" -DNDEBUG"
	CXXFLAGS+=" -DNDEBUG"

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	prepareInstalledDevelLibs $webpLibs
	fixPkgconfig

	sed -i -e 's,^includedir=\(.*\),includedir=${prefix}/'${relativeIncludeDir}'/webp,' \
		$installDestDir$developLibDir/pkgconfig/libsharpyuv.pc

	if [ -n "$secondaryArchSuffix" ]; then
		rm -rf $manDir
		maybe_manDir=
	else
		maybe_manDir=$manDir
	fi

	# tools package
	packageEntries tools \
		$commandBinDir \
		$maybe_manDir

	#devel package
	packageEntries devel \
		$developDir \
		$libDir/cmake
}

TEST()
{
	# need fuzz-tests to be enabled (git fetching from upstream)
	ctest --test-dir build --output-on-failure
}
