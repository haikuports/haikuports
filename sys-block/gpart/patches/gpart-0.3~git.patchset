From 95e9513621a19e11cae839ef75d55c605a7c2d3a Mon Sep 17 00:00:00 2001
From: localanu <localanu@gmail.com>
Date: Sat, 6 Jan 2018 10:46:19 +0000
Subject: Add support for haiku

diff --git a/src/disku.c b/src/disku.c
index d50cebf..867def5 100644
--- a/src/disku.c
+++ b/src/disku.c
@@ -33,6 +33,10 @@
 #include <sys/disk.h>
 #endif
 
+#if defined(__HAIKU__)
+#include <Drivers.h>
+#endif
+
 #include <unistd.h>
 
 static void geometry_from_num_sectors(struct disk_geom *g, uint64_t nsects)
@@ -95,8 +99,20 @@ static void os_disk_geometry(disk_desc *d, struct disk_geom *g)
 	g.d_nsecs = o / u;
 	g.d_c = g.d_nsecs / g.d_h / g.d_s;
 }
+#elif defined(__HAIKU__)
+static void os_disk_geometry(disk_desc *d, struct disk_geom *g)
+{
+device_geometry dg;
+	if (ioctl(d->d_fd, B_GET_GEOMETRY, & dg) == 0 ){
+		g -> d_h = dg.head_count;
+		g -> d_c = dg.cylinder_count;
+		g -> d_s = dg.sectors_per_track * dg.cylinder_count;
+	}
+	else
+	pr(FATAL, EM_IOCTLFAILED, "B_GET_GEOMETRY", strerror(errno));
+}
 #else
-#error Only Linux and FreeBSD supported
+#error Only Linux, FreeBSD, and Haiku supported
 #endif
 
 /*
diff --git a/src/gpart.h b/src/gpart.h
index e6e213c..1ae5b11 100644
--- a/src/gpart.h
+++ b/src/gpart.h
@@ -23,6 +23,7 @@
 #include "l64seek.h"
 
 #include <stdint.h>
+#include <endian.h>
 
 typedef uint8_t byte_t;
 
diff --git a/src/l64seek.h b/src/l64seek.h
index 5e8dc4b..95720c1 100644
--- a/src/l64seek.h
+++ b/src/l64seek.h
@@ -26,8 +26,11 @@
  * lseek function capable of seeking with at least 64bit
  * offsets.
  */
-
+#ifdef __HAIKU__
+typedef off_t off64_t;
+#else
 typedef loff_t off64_t;
+#endif
 typedef off64_t s64_t;
 
 off64_t l64seek(int fd, off64_t offset, int whence);
-- 
2.14.2

