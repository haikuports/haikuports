From 91a5196b57f2e80b172313b69dd7fe0475db85d5 Mon Sep 17 00:00:00 2001
From: My Name <mymail@mydomain.org>
Date: Sat, 6 Jan 2018 14:00:23 +0000
Subject: applying patch gpart-0.3.patchset.2


diff --git a/src/disku.c b/src/disku.c
index d50cebf..794abe9 100644
--- a/src/disku.c
+++ b/src/disku.c
@@ -33,6 +33,11 @@
 #include <sys/disk.h>
 #endif
 
+#if defined(__HAIKU__)
+#include <drivers/Drivers.h>
+#include <fcntl.h>
+#endif
+
 #include <unistd.h>
 
 static void geometry_from_num_sectors(struct disk_geom *g, uint64_t nsects)
@@ -95,8 +100,22 @@ static void os_disk_geometry(disk_desc *d, struct disk_geom *g)
 	g.d_nsecs = o / u;
 	g.d_c = g.d_nsecs / g.d_h / g.d_s;
 }
+#elif defined(__HAIKU__)
+static void os_disk_geometry(disk_desc *d, struct disk_geom *g)
+{
+	device_geometry geom;
+
+	if (ioctl(d->d_fd, B_GET_GEOMETRY, &geom, sizeof(geom)) == -1) {
+		pr(FATAL, EM_IOCTLFAILED, "B_GET_GEOMETRY", strerror(errno));
+	}
+
+	g->d_c = geom.cylinder_count;
+	g->d_h = geom.head_count;
+	g->d_s = geom.sectors_per_track;
+	g->d_nsecs = ((uint64_t)g->d_c) * g->d_h * g->d_s;
+}
 #else
-#error Only Linux and FreeBSD supported
+#error Only Linux, FreeBSD and Haiku are supported
 #endif
 
 /*
diff --git a/src/gpart.c b/src/gpart.c
index 3b44a75..279ee05 100644
--- a/src/gpart.c
+++ b/src/gpart.c
@@ -175,6 +175,10 @@ ssize_t bread(int fd, byte_t *buf, size_t ssize, size_t nsecs)
 			// ret < 0, an error case
 			if (errno == EINTR)
 				continue; // Rogue signal interruption, retry
+#ifdef __HAIKU__
+			if (errno == EINVAL)
+				return read_bytes;	// on Haiku, EOF causes EINVAL
+#endif
 			berrno = errno;
 			break;
 		}
@@ -504,20 +508,28 @@ static void u_to_chs(disk_desc *d, unsigned long u, long *c, long *h, long *s)
 
 static int on_cyl_boundary(disk_desc *d, s64_t sec)
 {
+#ifndef __HAIKU__
 	struct disk_geom *g = &d->d_dg;
 
 	if (g->d_h && g->d_s)
 		return ((sec % (g->d_h * g->d_s)) == 0);
 	return (1);
+#else
+	return (1);
+#endif
 }
 
 static int on_head_boundary(disk_desc *d, s64_t sec)
 {
+#ifndef __HAIKU__
 	struct disk_geom *g = &d->d_dg;
 
 	if (g->d_s)
 		return ((sec % g->d_s) == 0);
 	return (1);
+#else
+	return (1);
+#endif
 }
 
 static void print_partition(disk_desc *d, dos_part_entry *p, int inset, s64_t offset)
@@ -936,7 +948,11 @@ static void do_guess_loop(disk_desc *d)
 	d->d_nsb = 0;
 	bincr = incr * d->d_ssize;
 
+#ifdef __HAIKU__
+	start = skipsec ? skipsec : incr;
+#else
 	start = skipsec ? skipsec : d->d_dg.d_s;
+#endif
 	d->d_nsb = start - incr;
 	start *= d->d_ssize;
 	if (l64seek(d->d_fd, start, SEEK_SET) == -1)
diff --git a/src/gpart.h b/src/gpart.h
index e6e213c..5cf8a1c 100644
--- a/src/gpart.h
+++ b/src/gpart.h
@@ -22,6 +22,7 @@
 #include "errmsgs.h"
 #include "l64seek.h"
 
+#include <endian.h>
 #include <stdint.h>
 
 typedef uint8_t byte_t;
diff --git a/src/l64seek.h b/src/l64seek.h
index 5e8dc4b..b2324b6 100644
--- a/src/l64seek.h
+++ b/src/l64seek.h
@@ -27,6 +27,10 @@
  * offsets.
  */
 
+#ifdef __HAIKU__
+typedef off_t loff_t;
+#endif
+
 typedef loff_t off64_t;
 typedef off64_t s64_t;
 
-- 
2.15.0

