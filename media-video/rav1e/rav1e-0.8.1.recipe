SUMMARY="The fastest and safest AV1 encoder"
DESCRIPTION="rav1e is an AV1 video encoder. It is designed to eventually cover all use cases, \
though in its current form it is most suitable for cases where libaom (the reference encoder) is \
too slow."
HOMEPAGE="https://github.com/xiph/rav1e/"
COPYRIGHT="2017-2021, the rav1e contributors"
LICENSE="BSD (2-clause)"
REVISION="1"
SOURCE_URI="$HOMEPAGE/archive/refs/tags/v$portVersion.tar.gz"
CHECKSUM_SHA256="06d1523955fb6ed9cf9992eace772121067cca7e8926988a1ee16492febbe01e"
SOURCE_FILENAME="rav1e-v$portVersion.tar.gz"
SOURCE_URI_2="$HOMEPAGE/releases/download/v$portVersion/Cargo.lock#noarchive"
CHECKSUM_SHA256_2="861482385bdef579e207bb371937dd49cb9ff47d9406c40660b760fa672d0589"

ARCHITECTURES="ALL !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

libVersion="$portVersion"
libVersionCompat="$libVersion compat >= ${libVersion%.*}"

PROVIDES="
	rav1e$secondaryArchSuffix =$portVersion
	cmd:rav1e = $portVersion
	lib:librav1e$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES="
	haiku$secondaryArchSuffix
	"

PROVIDES_devel="
	rav1e${secondaryArchSuffix}_devel = $portVersion
	devel:librav1e$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES_devel="
	rav1e$secondaryArchSuffix == $portVersion base
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libgit2$secondaryArchSuffix
	devel:libssh2$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cargo$secondaryArchSuffix >= 0.74
	cmd:cargo_cbuild
	cmd:cargo_cinstall
	cmd:gcc$secondaryArchSuffix
	cmd:nasm
	cmd:pkg_config$secondaryArchSuffix
	"

defineDebugInfoPackage rav1e$secondaryArchSuffix \
	$prefix/bin/rav1e \
	$libDir/librav1e.so.$libVersion

BUILD()
{
	cp $sourceDir2/Cargo.lock Cargo.lock
	cargo fetch
}

INSTALL()
{
	export CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse
	export LIBSSH2_SYS_USE_PKG_CONFIG=1
	export LIBGIT2_SYS_USE_PKG_CONFIG=1
	export PKG_CONFIG_ALLOW_CROSS=1

	cargo install --locked --root $prefix --path .
	cargo cinstall --release --prefix=$prefix \
		--libdir=$libDir \
		--pkgconfigdir=$libDir/pkgconfig \
		--includedir=$includeDir

	rm -f $libDir/*.a
	rm -f $prefix/{.crates.toml,.crates2.json}

	prepareInstalledDevelLib librav1e
	fixPkgconfig

	#package devel
	packageEntries devel \
		$developDir
}

TEST()
{
	cargo test --release
}
