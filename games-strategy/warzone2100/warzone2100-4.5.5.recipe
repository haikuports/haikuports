SUMMARY="A free and open-source 3D real-time strategy game"
DESCRIPTION="Warzone 2100 was originally developed by Pumpkin Studios and published by Eidos Interactive.
In 1999, it was released commercially for Microsoft Windows and Sony PlayStation.
Pumpkin Studios ended their support for Warzone 2100 on January 5, 2000.

In 2004, after fan petition, Warzone's source code was released publicly under an open-source license.
It has been developed, maintained, and improved by the community ever since, under the banner of the 'Warzone 2100 Project'."
HOMEPAGE="https://wz2100.net/"
COPYRIGHT="
	2004-2024 Warzone 2100 Project
	1999-2000 Pumpkin Studios
	"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="https://github.com/Warzone2100/warzone2100/releases/download/$portVersion/warzone2100_src.tar.xz"
CHECKSUM_SHA256="07f61bae721687edeb62da4877e85030a03a053a593d645194fc65778e0480ff"
SOURCE_DIR="warzone2100"
PATCHES="warzone2100-$portVersion.patchset"
ADDITIONAL_FILES="warzone2100.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	warzone2100$secondaryArchSuffix = $portVersion
	cmd:warzone2100
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libcurl$secondaryArchSuffix
	lib:libfreetype$secondaryArchSuffix
	lib:libfribidi$secondaryArchSuffix
	lib:libharfbuzz$secondaryArchSuffix
	lib:libintl$secondaryArchSuffix
	lib:libminiupnpc$secondaryArchSuffix
	lib:libogg$secondaryArchSuffix
	lib:libopenal$secondaryArchSuffix
	lib:libopus$secondaryArchSuffix
	lib:libpng16$secondaryArchSuffix
	lib:libphysfs$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libsodium$secondaryArchSuffix
	lib:libsqlite3$secondaryArchSuffix
	lib:libtheoradec$secondaryArchSuffix
	lib:libvorbis$secondaryArchSuffix
	lib:libvorbisfile$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	gcc${secondaryArchSuffix}_syslibs_devel
	devel:libcurl$secondaryArchSuffix
	devel:libfreetype$secondaryArchSuffix
	devel:libfribidi$secondaryArchSuffix
	devel:libharfbuzz$secondaryArchSuffix
	devel:libminiupnpc$secondaryArchSuffix
	devel:libogg$secondaryArchSuffix
	devel:libopenal$secondaryArchSuffix
	devel:libopus$secondaryArchSuffix
	#devel:libopusfile$secondaryArchSuffix # Uses in-source one even when included
	devel:libpng16$secondaryArchSuffix
	devel:libphysfs$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libsodium$secondaryArchSuffix
	devel:libsqlite3$secondaryArchSuffix
	devel:libtheora$secondaryArchSuffix
	devel:libvorbis$secondaryArchSuffix
	devel:libvulkan$secondaryArchSuffix
	devel:libzip$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:asciidoc # Optional, for documentation
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	#cmd:git # Optional, inclusion messes up config/settings dir
	cmd:gettext
	#cmd:glslc # Optional, for vulkan renderer (that won't compile)
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	cmd:zip
	"

BUILD()
{
	cmake -Bbuild -S. $cmakeDirArgs -DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_EXE_LINKER_FLAGS="-lbsd -lnetwork"

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	# Remove unneeded files
	rm -rf $dataDir/{applications,icons,metainfo}

	# Generate the rdef
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	local LONG_INFO="$SUMMARY"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		$portDir/additional-files/warzone2100.rdef.in > warzone2100.rdef

	addResourcesToBinaries warzone2100.rdef $prefix/bin/warzone2100
	addAppDeskbarSymlink $prefix/bin/warzone2100 "Warzone 2100"
}
