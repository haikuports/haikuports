SUMMARY="Free artillery strategy game inspired by the Worms series"
DESCRIPTION="Hedgewars is a turn-based strategy, artillery, action and comedy game, \
featuring the antics of pink hedgehogs with attitude as they battle from the depths of hell to the depths of space.

As commander, it's your job to assemble your crack team of hedgehog soldiers and bring the war to your enemy."
HOMEPAGE="https://hedgewars.org/"
COPYRIGHT="2004-2024 Hedgewars Project"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="https://hedgewars.org/download/releases/hedgewars-src-$portVersion.tar.bz2"
CHECKSUM_SHA256="201fe5e45bd8ca5b3d81b18ec06bd6bbc9fa7c2c63bf019005e2f80be5bcf212"
SOURCE_DIR="hedgewars-src-$portVersion"
PATCHES="hedgewars-$portVersion.patchset"
ADDITIONAL_FILES="hedgewars.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURE="x86"

PROVIDES="
	hedgewars$secondaryArchSuffix = $portVersion
	app:hedgewars = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	#lib:libavcodec$secondaryArchSuffix # Only needed if video recording is enabled
	#lib:liblua$secondaryArchSuffix # Only needed if building with system Lua is enabled
	lib:libphysfs$secondaryArchSuffix
	lib:libpng16$secondaryArchSuffix # Optional, for png screenshots
	lib:libQt5Core$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libSDL2_image_2.0$secondaryArchSuffix
	lib:libSDL2_mixer_2.0$secondaryArchSuffix
	lib:libSDL2_net_2.0$secondaryArchSuffix
	lib:libSDL2_ttf_2.0$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	#devel:libavcodec$secondaryArchSuffix # Only needed if video recording is enabled
	#devel:liblua$secondaryArchSuffix # Only needed if building with system Lua is enabled
	devel:libphysfs$secondaryArchSuffix
	devel:libpng16$secondaryArchSuffix # Optional, for png screenshots
	devel:libQt5Core$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libSDL2_image_2.0$secondaryArchSuffix
	devel:libSDL2_mixer_2.0$secondaryArchSuffix
	devel:libSDL2_net_2.0$secondaryArchSuffix
	devel:libSDL2_ttf_2.0$secondaryArchSuffix
	devel:libssp_nonshared$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:fpc$secondaryArchSuffix
	cmd:gcc$secondaryArchSuffix
	cmd:linguist$secondaryArchSuffix >= 5
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	export FPCDIR="`finddir B_SYSTEM_DIRECTORY`/$relativeLibDir/fpc/3.2.2" CXXFLAGS="-Wall -w"

	cmake -Bbuild -S. \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=$prefix \
		-DDATA_INSTALL_DIR=$dataDir/hedgewars \
		-Dtarget_binary_install_dir=$appsDir/hedgewars \
		-Dtarget_library_install_dir=$libDir \
		-DFONTS_DIRS=$dataDir/fonts/ttfonts \
		-DBUILD_SHARED_LIBS=OFF \
		-DLUA_SYSTEM=OFF \
		-DNOAUTOUPDATE=ON \
		-DNOSERVER=1 \
		-DNOVIDEOREC=1

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	# Generate the rdef
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	local LONG_INFO="$SUMMARY"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		$portDir/additional-files/hedgewars.rdef.in > hedgewars.rdef

	addResourcesToBinaries hedgewars.rdef $appsDir/hedgewars/hedgewars
	addAppDeskbarSymlink $appsDir/hedgewars/hedgewars "Hedgewars"
}
