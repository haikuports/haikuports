SUMMARY="The programming language Erlang/OTP"
DESCRIPTION="Erlang is a programming language used to build massively \
scalable soft real-time systems with requirements on high availability. \
Some of its uses are in telecoms, banking, e-commerce, computer telephony \
and instant messaging. Erlang's runtime system has built-in support for \
concurrency, distribution and fault tolerance."
HOMEPAGE="http://www.erlang.org"
COPYRIGHT="1997-2013 Ericsson AB"
LICENSE="EPL"
REVISION="1"
SOURCE_URI="http://www.erlang.org/download/otp_src_19.2.tar.gz"
CHECKSUM_SHA256="a016b3ef5dac1e532972617b2715ef187ecb616f7cd7ddcfe0f1d502f5d24870"
SOURCE_DIR="otp_src_19.2"
PATCHES="erlang-19.02.patchset"

ARCHITECTURES="x86_gcc2 x86"

PROVIDES="
	erl = $portVersion
	cmd:erl = $portVersion
	cmd:ct_run = $portVersion
	cmd:dialyzer = $portVersion
	cmd:epmd = $portVersion
	cmd:erlc = $portVersion
	cmd:escript = $portVersion
	cmd:run_erl = $portVersion
	cmd:to_erl = $portVersion
	cmd:typer = $portVersion
	"
REQUIRES="
	haiku
	cmd:libtool
	cmd:perl
	cmd:gcc
	lib:libcrypto
	lib:libssl
	"

BUILD_REQUIRES="
	haiku_devel
	"

BUILD_PREREQUIRES="
	cmd:perl
	cmd:make
	cmd:gcc
	cmd:tar
	cmd:uname
	cmd:pkg_config
	devel:libncurses
	devel:libssl
	devel:libcrypto
	"

ERLANG_CFLAGS="-DETHR_X86_OUT_OF_ORDER -DHAVE_NET_IF_DL_H -DETHR_HAVE_ETHREAD_DEFINES -DETHR_PTHREADS -DETHR_SIZEOF_PTR=4 -DHAVE_CONFIG_H -D_BSD_SOURCE=1 -I../i586-pc-haiku -I../../i586-pc-haiku -I../include/internal -I../../include/internal -I../../emulator/sys/unix -I../../include/i586-pc-haiku -I../../emulator/beam -I../../../erts/include/internal/i586-pc-haiku -I../../../erts/i586-pc-haiku -Imisc -I../include -Iepmd -Iconnect -I../../../erts/emulator/beam -I../../../erts/include/i586-pc-haiku -I../../../../erts/emulator/beam -I../../../../erts/include/i586-pc-haiku -I../../../../erts/i586-pc-haiku"

BUILD()
{
	rm -rf `finddir B_SYSTEM_SETTINGS_DIRECTORY`/network
	mkdir -p `finddir B_SYSTEM_SETTINGS_DIRECTORY`/network
	touch `finddir B_SYSTEM_SETTINGS_DIRECTORY`/network/hostname
	runConfigure --omit-dirs "docDir dataRootDir" configure --prefix="$prefix" --disable-ipv6 --enable-dynamic-ssl-lib --with-ssl="/boot/system/develop" --disable-hipe CFLAGS="-I/boot/system/develop/headers" LDFLAGS="-lnetwork"
	echo "#undef ERTS_SMP" >> erts/i586-pc-haiku/config.h
	echo "#undef USE_THREADS" >> erts/i586-pc-haiku/config.h
	echo "Skip" > lib/megaco/SKIP
	HOME=/boot/home make CFLAGS="$ERLANG_CFLAGS"
}

INSTALL()
{
	HOME=/boot/home make CFLAGS="$ERLANG_CFLAGS" install
}
