From 987175449870f8cc7c3ce0795b18be3a9db4da55 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zolt=C3=A1n=20Mizsei?= <zmizsei@extrowerk.com>
Date: Sun, 5 May 2019 11:57:46 +0200
Subject: We don't allow unsetting O_NONBLOCK or O_NDELAY on packaged FS


diff --git a/ruby.c b/ruby.c
index 96d8f75..8c23ec1 100644
--- a/ruby.c
+++ b/ruby.c
@@ -2102,10 +2102,10 @@ open_load_file(VALUE fname_v, int *xflag)
 	int fd;
 	/* open(2) may block if fname is point to FIFO and it's empty. Let's
 	   use O_NONBLOCK. */
-#if defined O_NONBLOCK && HAVE_FCNTL && !(O_NONBLOCK & O_ACCMODE)
+#if defined O_NONBLOCK && HAVE_FCNTL && !(O_NONBLOCK & O_ACCMODE) && !defined(__HAIKU__)
 	/* TODO: fix conflicting O_NONBLOCK in ruby/win32.h */
 # define MODE_TO_LOAD (O_RDONLY | O_NONBLOCK)
-#elif defined O_NDELAY && HAVE_FCNTL && !(O_NDELAY & O_ACCMODE)
+#elif defined O_NDELAY && HAVE_FCNTL && !(O_NDELAY & O_ACCMODE) && !defined(__HAIKU__)
 # define MODE_TO_LOAD (O_RDONLY | O_NDELAY)
 #else
 # define MODE_TO_LOAD (O_RDONLY)
-- 
2.28.0


From d029f8d46c5895eb7d7642b89aea2f12fb3b5bab Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zolt=C3=A1n=20Mizsei?= <zmizsei@extrowerk.com>
Date: Sun, 5 May 2019 15:35:20 +0200
Subject: Test fix for Haiku


diff --git a/test/fiddle/helper.rb b/test/fiddle/helper.rb
index 73f6f78..ba51c22 100644
--- a/test/fiddle/helper.rb
+++ b/test/fiddle/helper.rb
@@ -99,6 +99,18 @@ when /aix/
       end
     end
   end
+when /haiku/
+  libdir = '/system/lib'
+  case [0].pack('L!').size
+  when 4
+    # 32-bit ruby
+    libdir = '/system/lib/x86' if File.directory? '/system/lib/x86'
+  when 8
+    # 64-bit ruby
+    libdir = '/system/lib/' if File.directory? '/system/lib/'
+  end
+  libc_so = File.join(libdir, "libroot.so")
+  libm_so = File.join(libdir, "libroot.so")
 else
   libc_so = ARGV[0] if ARGV[0] && ARGV[0][0] == ?/
   libm_so = ARGV[1] if ARGV[1] && ARGV[1][0] == ?/
-- 
2.28.0


From 507b1c39da76a278ecab3ad879524181e0209617 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zolt=C3=A1n=20Mizsei?= <zmizsei@extrowerk.com>
Date: Wed, 25 Dec 2019 19:53:24 +0100
Subject: Add Haiku to the context support list


diff --git a/configure.ac b/configure.ac
index 6766df2..ca10de2 100644
--- a/configure.ac
+++ b/configure.ac
@@ -2346,6 +2346,9 @@ AS_CASE([$rb_cv_coroutine], [yes|''], [
         [*-openbsd*], [
             rb_cv_coroutine=copy
         ],
+        [*-haiku*], [
+            rb_cv_coroutine=copy
+        ],
         [*], [
             rb_cv_coroutine=ucontext
         ]
-- 
2.28.0


From da26e0efbd12913c205d73945d69fedb62939dba Mon Sep 17 00:00:00 2001
From: Gerasim Troeglazov <3dEyes@gmail.com>
Date: Mon, 8 Jun 2020 19:42:51 +1000
Subject: Disable stack-protector


diff --git a/configure.ac b/configure.ac
index ca10de2..b13de6c 100644
--- a/configure.ac
+++ b/configure.ac
@@ -587,7 +587,7 @@ AS_IF([test "$GCC" = yes], [
 
     # -fstack-protector
     AS_CASE(["$target_os"],
-    [mingw*], [
+    [mingw*|haiku*], [
 	stack_protector=no
     ])
     AS_IF([test -z "${stack_protector+set}"], [
-- 
2.28.0

