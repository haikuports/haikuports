SUMMARY="Modern and safe systems programming language"
DESCRIPTION="Rust is a systems programming language that runs blazingly fast, \
prevents almost all crashes*, and eliminates data races."
HOMEPAGE="https://www.rust-lang.org/"
COPYRIGHT="2018 The Rust Project Developers"
LICENSE="MIT"
REVISION="1"

case "$effectiveTargetArchitecture" in
	x86)
SOURCE_URI="http://dl.rust-on-haiku.com/dist/$portVersion/rust-$portVersion-i686-unknown-haiku.tar.xz"
CHECKSUM_SHA256="f7dd24059a6cc7375d1547c0e915c226ff52bff123c57e5e79e680ee0d90ce49"
SOURCE_DIR="rust-$portVersion-i686-unknown-haiku"
		;;
	x86_64)
SOURCE_URI="http://dl.rust-on-haiku.com/dist/$portVersion/rust-$portVersion-x86_64-unknown-haiku.tar.xz"
CHECKSUM_SHA256="e26c564611ad920dcfad0c96bb86782afe29a684107afca908461ae09634b428"
SOURCE_DIR="rust-$portVersion-x86_64-unknown-haiku"
		;;
	*)
SOURCE_URI="http://dl.rust-on-haiku.com/dist/$portVersion/rustc-$portVersion-src.tar.xz"
CHECKSUM_SHA256="f180eab88ea3139765bff9499ecbdb12d67a4f0b5fcbf86829f30b0a9a58fd8f"
SOURCE_DIR="rustc-$portVersion-src"
		;;
esac

ARCHITECTURES="!x86_gcc2 ?x86 x86_64"
SECONDARY_ARCHITECTURES="x86"
DISABLE_SOURCE_PACKAGE=yes

cargoVersion="0.29.0"
rlsVersion="0.128.0"
rustfmtVersion="0.8.2"

PROVIDES="
	rust_bin$secondaryArchSuffix = $portVersion
	cmd:rustc = $portVersion
	cmd:rustdoc = $portVersion
	cmd:rust_gdb = $portVersion
	cmd:rust_lldb = $portVersion
	cmd:cargo$secondaryArchSuffix = $cargoVersion
	cmd:cargo_fmt = $cargoVersion
	cmd:rls = $rlsVersion
	cmd:rustfmt = $rustfmtVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libcrypto$secondaryArchSuffix
	lib:libcurl$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libssh2$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"
CONFLICTS="
	rust$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	"

INSTALL()
{
	./install.sh                                   \
		--prefix=$prefix                           \
		--docdir=$developDocDir                    \
		--libdir=$libDir                           \
		--mandir=$manDir                           \
		--sysconfdir=$dataDir                      \
		--disable-ldconfig

	# move the cargo and binaries (in case of a secondary arch)
	if [ -n "$secondaryArchSuffix" ]; then
		mkdir -p $binDir
		mv $prefix/bin/cargo $binDir/cargo
	fi

	# remove zsh data, it is not used on Haiku anyway
	rm -rf $prefix/share

	# move the `rustlib` folder to the developLibDirs (as it is a framework of sorts)
	# do create a link in $prefix/lib as that is where rustc expects things to live
	# Note; this actually seems to be a bug in the Rust build system. The path
	# to rustlib is hardcoded in the rustc binary, but it does allow it to be
	# set to libdir_relative (see config.rs in the bootstrap tool). This variable
	# is only set when the configure script is used to generate the config, not
	# with config.toml
	mkdir -p $developLibDir
	mv $libDir/rustlib $developLibDir
	ln -r -s $developLibDir/rustlib $prefix/lib/rustlib

	# clean out unneccesary files created by the rust installer
	rm $developLibDir/rustlib/components
	rm $developLibDir/rustlib/install.log
	rm $developLibDir/rustlib/manifest-*
	rm $developLibDir/rustlib/rust-installer-version
	rm $developLibDir/rustlib/uninstall.sh
}
