From 7e6d1ed18915b0acb1e8df782c99d2202e4f42dd Mon Sep 17 00:00:00 2001
From: Gerasim Troeglazov <3dEyes@gmail.com>
Date: Sun, 28 Feb 2021 17:54:22 +1000
Subject: Add haiku support


diff --git a/CMakeLists.txt b/CMakeLists.txt
index 88ca78c..db112c4 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -260,7 +260,7 @@ install(FILES "doc/texture_packs.md" DESTINATION "${DOCDIR}" COMPONENT "Docs")
 install(FILES "doc/world_format.md" DESTINATION "${DOCDIR}" COMPONENT "Docs")
 install(FILES "minetest.conf.example" DESTINATION "${EXAMPLE_CONF_DIR}")
 
-if(UNIX AND NOT APPLE)
+if(UNIX AND NOT APPLE AND NOT HAIKU)
 	install(FILES "doc/luanti.6" "doc/luantiserver.6" DESTINATION "${MANDIR}/man6")
 	install(FILES "misc/net.minetest.minetest.desktop" DESTINATION "${XDG_APPS_DIR}")
 	install(FILES "misc/net.minetest.minetest.metainfo.xml" DESTINATION "${METAINFODIR}")
diff --git a/src/defaultsettings.cpp b/src/defaultsettings.cpp
index ff325a8..bee73f0 100644
--- a/src/defaultsettings.cpp
+++ b/src/defaultsettings.cpp
@@ -265,7 +265,11 @@ void set_default_settings()
 	settings->setDefault("lighting_boost_spread", "0.2");
 	settings->setDefault("texture_path", "");
 	settings->setDefault("shader_path", "");
+#ifdef __HAIKU__
+	settings->setDefault("video_driver", "ogles2");
+#else
 	settings->setDefault("video_driver", "");
+#endif
 	settings->setDefault("cinematic", "false");
 	settings->setDefault("camera_smoothing", "0.0");
 	settings->setDefault("cinematic_camera_smoothing", "0.7");
@@ -306,7 +310,11 @@ void set_default_settings()
 	settings->setDefault("minimap_double_scan_height", "true");
 
 	// Effects
+#ifdef __HAIKU__
+	settings->setDefault("enable_post_processing", "false");
+#else
 	settings->setDefault("enable_post_processing", "true");
+#endif
 	settings->setDefault("post_processing_texture_bits", "16");
 	settings->setDefault("directional_colored_fog", "true");
 	settings->setDefault("inventory_items_animations", "false");
-- 
2.45.2


From 81a675b40b60d2a201a4df0468b6d40fc7fee098 Mon Sep 17 00:00:00 2001
From: Maite Gamper <victor@wenzeslaus.de>
Date: Tue, 10 Oct 2023 07:17:36 +0200
Subject: fix 3dEye's patch


diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 88c0c5a..a5fcbad 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -279,9 +279,13 @@ endif()
 # Use cmake_config.h
 add_compile_definitions(USE_CMAKE_CONFIG_H)
 
-set(THREADS_PREFER_PTHREAD_FLAG ON)
-find_package(Threads REQUIRED)
-set(PLATFORM_LIBS Threads::Threads)
+if(HAIKU)
+	set(PLATFORM_LIBS ${PLATFORM_LIBS} intl be)
+else()
+	set(THREADS_PREFER_PTHREAD_FLAG ON)
+	find_package(Threads REQUIRED)
+	set(PLATFORM_LIBS Threads::Threads)
+endif(HAIKU)
 
 if(WIN32)
 	# Windows
diff --git a/src/porting.cpp b/src/porting.cpp
index faef75b..01d614b 100644
--- a/src/porting.cpp
+++ b/src/porting.cpp
@@ -65,6 +65,14 @@
 #include <signal.h>
 #include <atomic>
 
+#if defined(__HAIKU__)
+	#include <Application.h>
+ 	#include <FindDirectory.h>
+	#include <Path.h>
+	#include <Roster.h>
+	#include <OS.h>
+#endif
+
 #if CHECK_CLIENT_BUILD() && defined(_WIN32)
 // On Windows export some driver-specific variables to encourage Minetest to be
 // executed on the discrete GPU in case of systems with two. Portability is fun.
@@ -294,6 +302,15 @@ static bool getExecPathFromProcfs(char *buf, size_t buflen)
 
 	buf[len] = '\0';
 	return true;
+#elif defined(__HAIKU__)
+	app_info appInfo;
+	if (be_app->GetAppInfo(&appInfo) == B_OK) {
+		BPath path(&appInfo.ref);
+		sprintf(buf, path.Path());
+	} else {
+		return false;
+	}
+	return true;
 #else
 	return false;
 #endif
@@ -552,6 +569,19 @@ bool setSystemPaths()
 	return true;
 }
 
+//// Haiku
+#elif defined(__HAIKU__)
+
+bool setSystemPaths()
+{
+	path_share = STATIC_SHAREDIR;
+	static char dir[PATH_MAX] = "";
+	if (find_directory(B_USER_SETTINGS_DIRECTORY, -1, false, dir, sizeof(dir)) != B_OK)
+		sprintf(dir, "/boot/home/config/settings");
+	dir[sizeof(dir) - 1] = 0;
+	path_user  = std::string(dir) + "/" + lowercase(PROJECT_NAME);
+	return true;
+}
 
 #else
 
-- 
2.45.2


From de8d1e312b3ed1f0d7abc097f8c18517444874c3 Mon Sep 17 00:00:00 2001
From: Maite Gamper <victor@wenzeslaus.de>
Date: Thu, 19 Oct 2023 08:36:46 +0200
Subject: fix for haiku (copied from irrlicht recipe)


diff --git a/irr/src/CFileSystem.h b/irr/src/CFileSystem.h
index d2a627e..634401a 100644
--- a/irr/src/CFileSystem.h
+++ b/irr/src/CFileSystem.h
@@ -4,6 +4,7 @@
 
 #pragma once
 
+#include <unistd.h>
 #include <vector>
 #include "IFileSystem.h"
 
diff --git a/irr/src/CMakeLists.txt b/irr/src/CMakeLists.txt
index e591d23..94f39fe 100644
--- a/irr/src/CMakeLists.txt
+++ b/irr/src/CMakeLists.txt
@@ -71,6 +71,9 @@ elseif(EMSCRIPTEN)
 elseif(SOLARIS)
 	add_compile_definitions(_IRR_SOLARIS_PLATFORM_ _IRR_POSIX_API_)
 	set(DEVICE "X11")
+elseif(HAIKU)
+	add_definitions(-D_IRR_POSIX_API_)
+	set(DEVICE "SDL")
 else()
 	add_compile_definitions(_IRR_POSIX_API_)
 	set(LINUX_PLATFORM TRUE)
-- 
2.45.2

