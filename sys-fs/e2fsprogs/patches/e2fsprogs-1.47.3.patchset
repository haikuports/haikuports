From 969c478ac340fb6384e80c212073b764b42b2886 Mon Sep 17 00:00:00 2001
From: Adrien Destugues <pulkomandy@pulkomandy.tk>
Date: Sun, 25 Feb 2018 14:25:11 +0100
Subject: Ugly hacks to get things building on Haiku.


diff --git a/configure.ac b/configure.ac
index bdd5f1f..e808dfe 100644
--- a/configure.ac
+++ b/configure.ac
@@ -106,7 +106,8 @@ AC_MSG_ERROR([--with-ldopts no longer supported; use LDFLAGS= instead]))
 dnl
 AC_PROG_CC
 if test "$GCC" = yes; then
-   RDYNAMIC="-rdynamic"
+   #RDYNAMIC="-rdynamic"
+   RDYNAMIC=""
    AC_SUBST(RDYNAMIC)
 fi
 AC_PROG_CPP
@@ -1294,7 +1295,7 @@ dnl Check to see if -lsocket is required (solaris) to make something
 dnl that uses socket() to compile; this is needed for the UUID library
 dnl
 SOCKET_LIB=''
-AC_CHECK_LIB(socket, socket, [SOCKET_LIB=-lsocket])
+AC_SEARCH_LIBS(socket, socket network, SOCKET_LIB=-lnetwork)
 AC_SUBST(SOCKET_LIB)
 dnl
 dnl See if libmagic exists
diff --git a/e2fsck/Makefile.in b/e2fsck/Makefile.in
index fbb7b15..015eb8f 100644
--- a/e2fsck/Makefile.in
+++ b/e2fsck/Makefile.in
@@ -17,7 +17,7 @@ MANPAGES=	e2fsck.8
 FMANPAGES=	e2fsck.conf.5
 
 LIBS= $(LIBSUPPORT) $(LIBEXT2FS) $(LIBCOM_ERR) $(LIBBLKID) $(LIBUUID) \
-	$(LIBINTL) $(LIBE2P) $(LIBMAGIC) $(SYSLIBS)
+       $(LIBINTL) $(LIBE2P) $(LIBMAGIC) $(SYSLIBS) -lbsd
 DEPLIBS= $(DEPLIBSUPPORT) $(LIBEXT2FS) $(DEPLIBCOM_ERR) $(DEPLIBBLKID) \
 	 $(DEPLIBUUID) $(DEPLIBE2P)
 
diff --git a/e2fsck/e2fsck.h b/e2fsck/e2fsck.h
index ae1273d..691eaaa 100644
--- a/e2fsck/e2fsck.h
+++ b/e2fsck/e2fsck.h
@@ -19,9 +19,7 @@
 #ifdef HAVE_SYS_TYPES_H
 #include <sys/types.h>
 #endif
-#ifdef HAVE_SYS_TIME_H
 #include <sys/time.h>
-#endif
 #ifdef HAVE_SETJMP_H
 #include <setjmp.h>
 #endif
diff --git a/misc/create_inode.c b/misc/create_inode.c
index 624efc0..85d73a8 100644
--- a/misc/create_inode.c
+++ b/misc/create_inode.c
@@ -45,6 +45,11 @@
 
 #include "create_inode_libarchive.h"
 
+#ifdef __HAIKU__
+#define major(x) 0
+#define minor(x) (x)
+#endif
+
 /* 64KiB is the minimum blksize to best minimize system call overhead. */
 #define COPY_FILE_BUFLEN	65536
 
-- 
2.52.0


From 29cb70f0b1318361d8e079488b14103f2d7c84b3 Mon Sep 17 00:00:00 2001
From: Adrien Destugues <pulkomandy@pulkomandy.tk>
Date: Sun, 25 Feb 2018 15:38:54 +0100
Subject: Extra patches.


diff --git a/configure.ac b/configure.ac
index e808dfe..a30f0f0 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1533,8 +1533,8 @@ esac
 dnl
 dnl Check the available mount options
 dnl
-AX_CHECK_MOUNT_OPT(nosuid)
-AX_CHECK_MOUNT_OPT(nodev)
+dnl AX_CHECK_MOUNT_OPT(nosuid)
+dnl AX_CHECK_MOUNT_OPT(nodev)
 dnl Enable LTO for all packages
 dnl
 AC_ARG_ENABLE([lto],
diff --git a/lib/blkid/devname.c b/lib/blkid/devname.c
index 6a21963..d72e64a 100644
--- a/lib/blkid/devname.c
+++ b/lib/blkid/devname.c
@@ -43,6 +43,10 @@
 
 #include "blkidP.h"
 
+#ifdef __HAIKU__
+#define makedev(maj,min) (min)
+#endif
+
 /*
  * Find a dev struct in the cache by device name, if available.
  *
diff --git a/lib/blkid/devno.c b/lib/blkid/devno.c
index b1cadc9..a5e7541 100644
--- a/lib/blkid/devno.c
+++ b/lib/blkid/devno.c
@@ -37,6 +37,10 @@
 
 #include "blkidP.h"
 
+#ifdef __HAIKU__
+#define makedev(maj,min) (min)
+#endif
+
 #if defined(__GNUC__) && __GNUC__ >= 8
 /* gcc incorrectly thinks the destination string is not being null-terminated */
 #pragma GCC diagnostic push
diff --git a/lib/ext2fs/bmap64.h b/lib/ext2fs/bmap64.h
index de33454..e8ef9de 100644
--- a/lib/ext2fs/bmap64.h
+++ b/lib/ext2fs/bmap64.h
@@ -9,6 +9,8 @@
  * %End-Header%
  */
 
+#include <sys/time.h>
+
 struct ext2_bmap_statistics {
 	int		type;
 	struct timeval	created;
-- 
2.52.0


From 5e168fcec0337f578cb45cc3b8d6d34636b05596 Mon Sep 17 00:00:00 2001
From: Jerome Duval <jerome.duval@gmail.com>
Date: Thu, 7 Jan 2021 20:23:58 +0100
Subject: Haiku: type loff_t


diff --git a/lib/ext2fs/imager.c b/lib/ext2fs/imager.c
index 16b0977..7ebd517 100644
--- a/lib/ext2fs/imager.c
+++ b/lib/ext2fs/imager.c
@@ -37,6 +37,9 @@
 #ifndef HAVE_TYPE_SSIZE_T
 typedef int ssize_t;
 #endif
+#ifdef __HAIKU__
+typedef off_t loff_t;
+#endif
 
 /*
  * This function returns 1 if the specified block is all zeros
diff --git a/misc/e2fuzz.c b/misc/e2fuzz.c
index 9f60bcf..1b1b697 100644
--- a/misc/e2fuzz.c
+++ b/misc/e2fuzz.c
@@ -42,6 +42,10 @@ static ssize_t my_pwrite(int fd, const void *buf, size_t count,
 }
 #endif /* !defined HAVE_PWRITE64 && !defined HAVE_PWRITE */
 
+#ifdef __HAIKU__
+typedef off_t loff_t;
+#endif
+
 static int getseed(void)
 {
 	int r;
-- 
2.52.0

