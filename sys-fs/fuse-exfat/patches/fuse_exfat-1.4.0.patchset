From d845891d272148c863afe47faf2631c73993e5c1 Mon Sep 17 00:00:00 2001
From: Oscar Lesta <oscar.lesta@gmail.com>
Date: Tue, 21 Oct 2025 23:23:56 -0300
Subject: Initial Haiku patch.


diff --git a/libexfat/platform.h b/libexfat/platform.h
index 9bd125a..730e96f 100644
--- a/libexfat/platform.h
+++ b/libexfat/platform.h
@@ -66,7 +66,18 @@
 #define EXFAT_LITTLE_ENDIAN __LITTLE_ENDIAN
 #define EXFAT_BIG_ENDIAN __BIG_ENDIAN
 
-#else 
+
+#elif defined(__HAIKU__)
+
+#include <ByteOrder.h>
+#define exfat_bswap16(x) B_SWAP_INT16(x)
+#define exfat_bswap32(x) B_SWAP_INT32(x)
+#define exfat_bswap64(x) B_SWAP_INT64(x)
+#define EXFAT_BYTE_ORDER __BYTE_ORDER
+#define EXFAT_LITTLE_ENDIAN __LITTLE_ENDIAN
+#define EXFAT_BIG_ENDIAN __BIG_ENDIAN
+
+#else
 #error Unknown platform
 #endif
 
-- 
2.51.0


From 9b9c05ec019fe6ba52d57fb3ae09b5746292cfed Mon Sep 17 00:00:00 2001
From: Oscar Lesta <oscar.lesta@gmail.com>
Date: Fri, 7 Nov 2025 09:52:07 -0300
Subject: Use saner permissions default values.


diff --git a/libexfat/mount.c b/libexfat/mount.c
index 86fb84d..ef9c7f2 100644
--- a/libexfat/mount.c
+++ b/libexfat/mount.c
@@ -87,6 +87,13 @@ static void parse_options(struct exfat* ef, const char* options)
 	ef->dmask = get_int_option(options, "dmask", 8, opt_umask);
 	ef->fmask = get_int_option(options, "fmask", 8, opt_umask);
 
+#if defined(__HAIKU__)
+	if (ef->dmask == 0)
+		ef->dmask = 18; // 0o022, so we get rwxr-xr-x (once negated in exfat_stat())
+	if (ef->fmask == 0)
+		ef->fmask = 91; // 0o133. so we get rw-r--r-- (once negated in exfat_stat())
+#endif
+
 	ef->uid = get_int_option(options, "uid", 10, geteuid());
 	ef->gid = get_int_option(options, "gid", 10, getegid());
 
-- 
2.51.0


From 7b4dc549639e366aedd93a0b5c5a2fecdbccf030 Mon Sep 17 00:00:00 2001
From: Oscar Lesta <oscar.lesta@gmail.com>
Date: Mon, 10 Nov 2025 14:18:33 -0300
Subject: Propagate R/O flag.


diff --git a/fuse/main.c b/fuse/main.c
index f7aacb4..95762bc 100644
--- a/fuse/main.c
+++ b/fuse/main.c
@@ -395,6 +395,10 @@ static int fuse_exfat_statfs(UNUSED const char* path, struct statvfs* sfs)
 	sfs->f_favail = sfs->f_bfree >> ef.sb->spc_bits;
 	sfs->f_ffree = sfs->f_bavail;
 
+#ifdef __HAIKU__
+	sfs->f_flag = ((ef.ro != 0) ? ST_RDONLY : 0) | ST_NOSUID;
+#endif
+
 	return 0;
 }
 
-- 
2.51.0

