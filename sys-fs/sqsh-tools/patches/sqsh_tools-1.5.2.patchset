From 36ec836d13a9155de13d6d9fef5eb13e6352d8be Mon Sep 17 00:00:00 2001
From: Oscar Lesta <oscar.lesta@gmail.com>
Date: Sun, 9 Nov 2025 16:31:55 -0300
Subject: Add the fuse statfs() function.

It fixes the missing "sqshfs Volume" icon in Tracker.


diff --git a/tools/src/fs2.c b/tools/src/fs2.c
index c6547d2..7dac7b9 100644
--- a/tools/src/fs2.c
+++ b/tools/src/fs2.c
@@ -322,6 +322,33 @@ fs_mac_getxattr(
 }
 #endif
 
+#ifdef __HAIKU__
+static int fs_statfs(const char* path, struct statvfs* sfs)
+{
+	(void)path; // avoids a warning.
+	const struct SqshSuperblock* superblock = sqsh_archive_superblock(context.archive);
+
+	sfs->f_bsize = sqsh_superblock_block_size(superblock);	/* block size */
+	sfs->f_blocks = sqsh_superblock_bytes_used(superblock) / sfs->f_bsize;	/* number of blocks on file system in units of ~f_frsize~ f_bsize */
+	sfs->f_files = sqsh_superblock_inode_count(superblock);	/* number of file serial numbers */
+
+	// No free space here.
+	sfs->f_bfree = 0;	/* number of free blocks */
+	sfs->f_bavail = 0;	/* number of free blocks available to processes */
+	sfs->f_ffree = 0;	/* number of free file serial numbers */
+
+	// Ignored (according to Haiku's fuse.h comments for statfs():
+	sfs->f_frsize = 0;	/* fundamental block size */
+	sfs->f_favail = 0;	/* number of file serial numbers available to processes */
+	sfs->f_fsid = 666;		/* file system ID */
+	sfs->f_flag = ST_RDONLY | ST_NOSUID; 
+
+	sfs->f_namemax = NAME_MAX;	/* maximum file name length */
+
+	return 0;
+}
+#endif
+
 static struct fuse_operations fs_oper = {
 		.access = fs_access,
 		.getattr = fs_getattr,
@@ -338,6 +365,9 @@ static struct fuse_operations fs_oper = {
 #else
 		.getxattr = fs_getxattr,
 #endif
+#ifdef __HAIKU__
+		.statfs = fs_statfs,
+#endif
 };
 
 static int
-- 
2.51.0

