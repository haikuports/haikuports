SUMMARY="A tool for analyzing and editing NetImmerse/Gamebryo files"
DESCRIPTION="NifSkope is a tool for opening and editing the NetImmerse file format (NIF). \
NIF is used by video games such as Morrowind, Oblivion, Skyrim, Fallout 3/NV/4/76, Starfield, \
Civilization IV, and more."
HOMEPAGE="http://www.niftools.org/
	https://github.com/fo76utils/nifskope"
COPYRIGHT="2005-2014 NIF File Format Library and Tools"
LICENSE="NIFSKOPE"
REVISION="1"
SOURCE_URI="https://github.com/fo76utils/nifskope/archive/refs/tags/v2.0.dev11-20251230.tar.gz"
CHECKSUM_SHA256="bbc2795d7e2ecef7eaca0da47a3d24ae682ff15ebcfb5e3ce122b9799f05f3a8"
SOURCE_DIR="nifskope-2.0.dev11-20251230"
PATCHES="nifskope-2.0.dev11_20251230.patchset"
srcGitRev2="779b99ac6656e4d30c3b24e96e0136a59649a869"
SOURCE_URI_2="https://github.com/g-truc/gli/archive/$srcGitRev2.tar.gz"
CHECKSUM_SHA256_2="2f4f67ac4d1673216f03ff37e406bb403689b39a2df3d2efad501448705bbb3f"
SOURCE_FILENAME_2="gli-$srcGitRev2.tar.gz"
SOURCE_DIR_2="gli-$srcGitRev2"
srcGitRev3="d1c2fc0caa5f644f3a0f220290d4a868c68ed4f6"
SOURCE_URI_3="https://github.com/qhull/qhull/archive/$srcGitRev3.tar.gz"
CHECKSUM_SHA256_3="421177cc21a7dcb4c1bbc51f65bc16f21d1f157814116bb5c341d694e23d154d"
SOURCE_FILENAME_3="qhull-$srcGitRev3.tar.gz"
SOURCE_DIR_3="qhull-$srcGitRev3"
srcGitRev4="970a6238218a106daaeb89a61bcda0eeaf9d08c4"
SOURCE_URI_4="https://github.com/niftools/nifxml/archive/$srcGitRev4.tar.gz"
CHECKSUM_SHA256_4="ac91ae440c8800ae6bd18899e149b6026a9c80b31bea8aa3f5a215733a0600ee"
SOURCE_FILENAME_4="nifxml-$srcGitRev4.tar.gz"
SOURCE_DIR_4="nifxml-$srcGitRev4"
SOURCE_URI_5="https://raw.githubusercontent.com/niftools/kfmxml/develop/kfm.xml#noarchive"
CHECKSUM_SHA256_5="3af5634dfef643494bb7646924b1b18ab22bc0d9b5ea4758d4e6b693c78a2f3e"
srcGitRev6="ec2ee8b7eee36cebfd0c2b4bf28322da90492484"
SOURCE_URI_6="https://github.com/zeux/meshoptimizer/archive/$srcGitRev6.tar.gz"
CHECKSUM_SHA256_6="9d3a8550a5b833f2bf67115b34dee3093fb4e6ef51e40f363e75d6af2002127b"
SOURCE_FILENAME_6="meshoptimizer-$srcGitRev6.tar.gz"
SOURCE_DIR_6="meshoptimizer-$srcGitRev6"
ADDITIONAL_FILES="nifskope.rdef.in"

ARCHITECTURES="?all !x86_gcc2 x86_64"
SECONDARY_ARCHITECTURES="!x86"

GLOBAL_WRITABLE_FILES="
	settings/nifskope/kfm.xml keep-old
	settings/nifskope/nif.xml keep-old
	"

PROVIDES="
	nifskope = $portVersion
	app:NifSkope = $portVersion
	"
REQUIRES="
	haiku
	lib:libGL
	lib:libQt6Core
	lib:libQt6Gui
	lib:libQt6Network
	lib:libQt6OpenGL
	lib:libQt6OpenGLWidgets
	lib:libQt6Xml
	lib:libQt6Widgets
	lib:libz
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	qt6_tools${secondaryArchSuffix}_devel
	glm${secondaryArchSuffix}_devel
	devel:libQt6Core
	devel:libz
	"
BUILD_PREREQUIRES="
	cmd:g++
	cmd:make
	cmd:qmake6
	"

BUILD()
{
	cp -r $sourceDir2/gli/* $sourceDir/src/
	cp -r $sourceDir2/external/glm/* $sourceDir/src/
	cp -r $sourceDir3/src/libqhull $sourceDir/src/
	mkdir -p $sourceDir/build/docsys/nifxml/
	cp $sourceDir4/nif.xml $sourceDir/build/docsys/nifxml/
	mkdir -p $sourceDir/build/docsys/kfmxml/
	cp $sourceDir5/kfm.xml $sourceDir/build/docsys/kfmxml/
	cp -r $sourceDir6/* $sourceDir/lib/meshoptimizer

	qmake6

	make $jobArgs
}

INSTALL()
{
	mkdir -p $appsDir $dataDir/nifskope/shaders $documentationDir/packages/nifskope
	mkdir -p $settingsDir/nifskope/

	cp $sourceDir/release/NifSkope $appsDir/

	cp $sourceDir/release/style.qss $dataDir/nifskope

	cp $sourceDir/release/shaders/*.frag $dataDir/nifskope/shaders
	cp $sourceDir/release/shaders/*.prog $dataDir/nifskope/shaders
	cp $sourceDir/release/shaders/*.vert $dataDir/nifskope/shaders

	cp $sourceDir/release/nif.xml $settingsDir/nifskope/
	cp $sourceDir/release/kfm.xml $settingsDir/nifskope/

	cp $sourceDir/{CHANGELOG.md,README.md,README_GLTF.md} $documentationDir/packages/nifskope

	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	local APP_NAME="NifSkope"
	local LONG_INFO="$SUMMARY"
	local APP_SIGNATURE="application/x-vnd.nifskope"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|11|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		-e "s|@APP_NAME@|$APP_NAME|" \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		$portDir/additional-files/nifskope.rdef.in > nifskope.rdef
	addResourcesToBinaries nifskope.rdef $appsDir/NifSkope

	addAppDeskbarSymlink $appsDir/NifSkope
}
