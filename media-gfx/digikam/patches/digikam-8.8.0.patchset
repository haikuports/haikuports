From 32ec748546e9bee48117c81a4a258aae8df4bb6a Mon Sep 17 00:00:00 2001
From: Gerasim Troeglazov <3dEyes@gmail.com>
Date: Thu, 14 Mar 2024 22:51:39 +1000
Subject: Fix build for Haiku


diff --git a/core/app/DigikamCoreTarget.cmake b/core/app/DigikamCoreTarget.cmake
index 3383a46..985b018 100644
--- a/core/app/DigikamCoreTarget.cmake
+++ b/core/app/DigikamCoreTarget.cmake
@@ -226,6 +226,10 @@ target_link_libraries(digikamcore
                       Qt${QT_VERSION_MAJOR}::WebEngineWidgets
 )
 
+if(HAIKU)
+    target_link_libraries(digikamcore PUBLIC network iconv intl)
+endif()
+
 if(ENABLE_DBUS)
 
     target_link_libraries(digikamcore
diff --git a/core/app/main/digikamapp_setup.cpp b/core/app/main/digikamapp_setup.cpp
index 90d6783..0475920 100644
--- a/core/app/main/digikamapp_setup.cpp
+++ b/core/app/main/digikamapp_setup.cpp
@@ -886,7 +886,9 @@ void DigikamApp::setupActions()
 
     // Load Themes
 
+#ifndef Q_OS_HAIKU
     loadThemesActions();
+#endif
 
     createGUI(xmlFile());
 
diff --git a/core/dplugins/generic/tools/mediaserver/upnpsdk/Neptune/Source/Core/NptConfig.h b/core/dplugins/generic/tools/mediaserver/upnpsdk/Neptune/Source/Core/NptConfig.h
index 8cc5f37..3cae501 100644
--- a/core/dplugins/generic/tools/mediaserver/upnpsdk/Neptune/Source/Core/NptConfig.h
+++ b/core/dplugins/generic/tools/mediaserver/upnpsdk/Neptune/Source/Core/NptConfig.h
@@ -146,6 +146,11 @@
 #define NPT_CONFIG_HAVE_GETADDRINFO
 #endif
 
+/* Haiku */
+#if defined(__HAIKU__)
+#define NPT_CONFIG_HAVE_GETADDRINFO
+#endif
+
 /* linux */
 #if defined(__linux__)
 #define NPT_CONFIG_HAVE_GETADDRINFO
diff --git a/core/dplugins/generic/tools/mediaserver/upnpsdk/Neptune/Source/System/Bsd/NptBsdNetwork.cpp b/core/dplugins/generic/tools/mediaserver/upnpsdk/Neptune/Source/System/Bsd/NptBsdNetwork.cpp
index 5f20d6c..990927f 100644
--- a/core/dplugins/generic/tools/mediaserver/upnpsdk/Neptune/Source/System/Bsd/NptBsdNetwork.cpp
+++ b/core/dplugins/generic/tools/mediaserver/upnpsdk/Neptune/Source/System/Bsd/NptBsdNetwork.cpp
@@ -13,6 +13,9 @@
 #include <sys/types.h>
 #include <sys/socket.h>
 #include <sys/select.h>
+#ifdef __HAIKU__
+#include <sys/sockio.h>
+#endif
 #include <sys/time.h>
 #include <sys/ioctl.h>
 #include <netinet/in.h>
diff --git a/core/libs/dimg/filters/curves/curveswidget.cpp b/core/libs/dimg/filters/curves/curveswidget.cpp
index 48c70aa..f95f2a1 100644
--- a/core/libs/dimg/filters/curves/curveswidget.cpp
+++ b/core/libs/dimg/filters/curves/curveswidget.cpp
@@ -23,6 +23,7 @@
 
 #include <QPixmap>
 #include <QPainter>
+#include <QPainterPath>
 #include <QPoint>
 #include <QPen>
 #include <QTimer>
diff --git a/core/libs/dngwriter/extra/dng_sdk/dng_string.cpp b/core/libs/dngwriter/extra/dng_sdk/dng_string.cpp
index 1758ad4..00421d3 100644
--- a/core/libs/dngwriter/extra/dng_sdk/dng_string.cpp
+++ b/core/libs/dngwriter/extra/dng_sdk/dng_string.cpp
@@ -38,7 +38,7 @@
 
 #endif
 
-#if qiPhone || qAndroid || qLinux
+#if qiPhone || qAndroid || qLinux || __HAIKU__
 #include <ctype.h> // for isdigit
 #endif
 
diff --git a/core/libs/dngwriter/extra/dng_sdk/dng_types.h b/core/libs/dngwriter/extra/dng_sdk/dng_types.h
index 1260941..d2ff317 100644
--- a/core/libs/dngwriter/extra/dng_sdk/dng_types.h
+++ b/core/libs/dngwriter/extra/dng_sdk/dng_types.h
@@ -49,6 +49,9 @@ typedef std::uint64_t uint64;
 
 #else
 
+#ifdef __HAIKU__
+#include <SupportDefs.h>
+#else
 typedef int8_t  int8;
 typedef int16_t int16;
 typedef int32_t int32;
@@ -58,6 +61,7 @@ typedef uint8_t  uint8;
 typedef uint16_t uint16;
 typedef uint32_t uint32;
 typedef uint64_t uint64;
+#endif
 
 #endif  // __cplusplus
 
diff --git a/core/libs/pgfutils/libpgf/PGFplatform.h b/core/libs/pgfutils/libpgf/PGFplatform.h
index ac0708e..3ee990b 100644
--- a/core/libs/pgfutils/libpgf/PGFplatform.h
+++ b/core/libs/pgfutils/libpgf/PGFplatform.h
@@ -320,7 +320,7 @@ inline OSError SetFPos(HANDLE hFile, int posMode, INT64 posOff) {
 //-------------------------------------------------------------------------------
 // LINUX
 //-------------------------------------------------------------------------------
-#if defined(__linux__) || defined(__GLIBC__)
+#if defined(__linux__) || defined(__GLIBC__) || defined(__HAIKU__)
 #define __POSIX__
 #endif // __linux__ or __GLIBC__
 
@@ -336,7 +336,7 @@ inline OSError SetFPos(HANDLE hFile, int posMode, INT64 posOff) {
 //-------------------------------------------------------------------------------
 // *BSD
 //-------------------------------------------------------------------------------
-#if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD__)
+#if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD__) || defined(__HAIKU__)
 #ifndef __POSIX__
 #define __POSIX__
 #endif
diff --git a/core/libs/settings/applicationsettings_miscs.cpp b/core/libs/settings/applicationsettings_miscs.cpp
index 06bd987..72fbc61 100644
--- a/core/libs/settings/applicationsettings_miscs.cpp
+++ b/core/libs/settings/applicationsettings_miscs.cpp
@@ -530,7 +530,11 @@ void ApplicationSettings::setApplicationFont(const QFont& font)
 
 QFont ApplicationSettings::getApplicationFont() const
 {
+#ifdef Q_OS_HAIKU
+    return QFontDatabase::systemFont(QFontDatabase::GeneralFont);
+#else
     return d->applicationFont;
+#endif
 }
 
 bool ApplicationSettings::getHelpBoxNotificationSeen()
diff --git a/core/libs/threadimageio/thumb/thumbnailcreator_basic.cpp b/core/libs/threadimageio/thumb/thumbnailcreator_basic.cpp
index b04363e..0087e10 100644
--- a/core/libs/threadimageio/thumb/thumbnailcreator_basic.cpp
+++ b/core/libs/threadimageio/thumb/thumbnailcreator_basic.cpp
@@ -38,7 +38,7 @@ extern "C"
 #include <sys/stat.h>
 #include <sys/types.h>
 
-#ifndef Q_OS_WIN32          // krazy:exclude=cpp
+#if !defined(Q_OS_WIN32) && !defined(Q_OS_HAIKU)          // krazy:exclude=cpp
 #   include <sys/ipc.h>
 #   include <sys/shm.h>
 #endif
diff --git a/core/libs/widgets/mainview/thememanager.cpp b/core/libs/widgets/mainview/thememanager.cpp
index ffd19ac..836287b 100644
--- a/core/libs/widgets/mainview/thememanager.cpp
+++ b/core/libs/widgets/mainview/thememanager.cpp
@@ -83,6 +83,7 @@ void ThemeManager::setCurrentTheme(const QString& name)
 
 void ThemeManager::slotChangePalette()
 {
+#ifndef Q_OS_HAIKU
     updateCurrentDesktopDefaultThemePreview();
 
     QString theme(currentThemeName());
@@ -108,6 +109,7 @@ void ThemeManager::slotChangePalette()
     qCDebug(DIGIKAM_WIDGETS_LOG) << theme << " :: " << filePath;
 
     Q_EMIT signalThemeChanged();
+#endif
 }
 
 void ThemeManager::setThemeMenuAction(QMenu* const action)
@@ -134,6 +136,7 @@ void ThemeManager::registerThemeActions(DXmlGuiWindow* const win)
 
 void ThemeManager::populateThemeMenu()
 {
+#ifndef Q_OS_HAIKU
     if (!d->themeMenuAction)
     {
         return;
@@ -198,6 +201,7 @@ void ThemeManager::populateThemeMenu()
 
     updateCurrentDesktopDefaultThemePreview();
     setCurrentTheme(theme);
+#endif
 }
 
 void ThemeManager::updateCurrentDesktopDefaultThemePreview()
diff --git a/core/showfoto/main/showfoto_setup.cpp b/core/showfoto/main/showfoto_setup.cpp
index 41d1f06..0d55d2b 100644
--- a/core/showfoto/main/showfoto_setup.cpp
+++ b/core/showfoto/main/showfoto_setup.cpp
@@ -19,7 +19,9 @@ namespace ShowFoto
 
 void Showfoto::setupActions()
 {
+#ifndef Q_OS_HAIKU
     Digikam::ThemeManager::instance()->setThemeMenuAction(new QMenu(i18n("&Themes"), this));
+#endif
     setupStandardActions();
 
     // Extra 'File' menu actions ---------------------------------------------
diff --git a/core/showfoto/main/showfotosettings.cpp b/core/showfoto/main/showfotosettings.cpp
index 79c5cbb..5eb0f88 100644
--- a/core/showfoto/main/showfotosettings.cpp
+++ b/core/showfoto/main/showfotosettings.cpp
@@ -294,7 +294,11 @@ QString ShowfotoSettings::getIconTheme() const
 
 QFont ShowfotoSettings::getApplicationFont() const
 {
+#ifdef Q_OS_HAIKU
+       return QFontDatabase::systemFont(QFontDatabase::GeneralFont);
+#else
     return d->applicationFont;
+#endif
 }
 
 bool ShowfotoSettings::getShowSplash() const
diff --git a/core/showfoto/setup/showfotosetupmisc.cpp b/core/showfoto/setup/showfotosetupmisc.cpp
index ae41f19..d9a01ed 100644
--- a/core/showfoto/setup/showfotosetupmisc.cpp
+++ b/core/showfoto/setup/showfotosetupmisc.cpp
@@ -88,8 +88,9 @@ public:
     QComboBox*            sortOrderComboBox     = nullptr;
     QComboBox*            applicationStyle      = nullptr;
     QComboBox*            applicationIcon       = nullptr;
+#ifndef Q_OS_HAIKU
     DFontSelect*          applicationFont       = nullptr;
-
+#endif
     SystemSettingsWidget* systemSettingsWidget  = nullptr;
 
 #ifdef HAVE_SONNET
@@ -298,8 +299,10 @@ ShowfotoSetupMisc::ShowfotoSetupMisc(QWidget* const parent)
         d->applicationIcon->addItem(it.key(), it.value());
     }
 
+#ifndef Q_OS_HAIKU
     d->applicationFont = new DFontSelect(i18n("Application font:"), appearancePanel);
     d->applicationFont->setToolTip(i18n("Select here the font used to display text in whole application."));
+#endif
 
     // --------------------------------------------------------
 
@@ -310,7 +313,9 @@ ShowfotoSetupMisc::ShowfotoSetupMisc(QWidget* const parent)
     layout2->addWidget(tabStyleHbox);
     layout2->addWidget(appStyleHbox);
     layout2->addWidget(iconThemeHbox);
+#ifndef Q_OS_HAIKU
     layout2->addWidget(d->applicationFont);
+#endif
     layout2->addStretch();
 
     d->tab->insertTab(Appearance, appearancePanel, i18nc("@title:tab", "Appearance"));
@@ -407,7 +412,9 @@ void ShowfotoSetupMisc::readSettings()
 #endif
 
     d->applicationIcon->setCurrentIndex(d->applicationIcon->findData(d->settings->getIconTheme()));
+#ifndef Q_OS_HAIKU
     d->applicationFont->setFont(d->settings->getApplicationFont());
+#endif
 
     // NOTE: Spellcheck and Localize read settings is done in widget constructor.
 }
@@ -435,7 +442,9 @@ void ShowfotoSetupMisc::applySettings()
 #endif
 
     d->settings->setIconTheme(d->applicationIcon->currentData().toString());
+#ifndef Q_OS_HAIKU
     d->settings->setApplicationFont(d->applicationFont->font());
+#endif
     d->settings->syncConfig();
 
 #ifdef HAVE_SONNET
diff --git a/core/utilities/import/backend/gpcamera.cpp b/core/utilities/import/backend/gpcamera.cpp
index c5fdea4..cf2d0f0 100644
--- a/core/utilities/import/backend/gpcamera.cpp
+++ b/core/utilities/import/backend/gpcamera.cpp
@@ -59,6 +59,10 @@ extern "C"
 
 //#define GPHOTO2_DEBUG 1
 
+#ifdef Q_OS_HAIKU
+#define HAVE_GPHOTO25 1
+#endif
+
 #ifdef HAVE_GPHOTO2
 
 // LibGphoto2 includes
-- 
2.51.0

