SUMMARY="3D Creation/Animation/Publishing System"
DESCRIPTION="Blender is the free and open source 3D creation suite. It \
supports the entirety of the 3D pipeline—modeling, rigging, animation, \
simulation, rendering, compositing and motion tracking, even video editing \
and game creation.
Advanced users employ Blender’s API for Python scripting to customize the \
application and write specialized tools; often these are included in Blender’s \
future releases. Blender is well suited to individuals and small studios who \
benefit from its unified pipeline and responsive development process."
HOMEPAGE="http://www.blender.org/"
COPYRIGHT="2002-2017 Blender Foundation"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="http://download.blender.org/source/blender-$portVersion.tar.gz"
CHECKSUM_SHA256="a9de03e769a2a4a0bf92186556896c4f4d32fd9ac4480915ae92d7f95b25c899"
PATCHES="blender-$portVersion.patchset"
ADDITIONAL_FILES="blender.rdef.in"

ARCHITECTURES="!x86_gcc2 !x86 x86_64"

PYTHON_VERSION="3.6"
PORT_SUBFOLDER=`echo $portVersion | sed 's/.$//'`
INSTALL_PATH="$appsDir/Blender"

PROVIDES="
	blender = $portVersion
	cmd:blender
	cmd:blender_thumbnailer.py
	cmd:cycles
	"
REQUIRES="
	haiku
	lib:libavcodec
	lib:libboost_atomic
	lib:libboost_chrono
	lib:libboost_date_time
	lib:libboost_filesystem
	lib:libboost_locale
	lib:libboost_regex
	lib:libboost_system
	lib:libboost_thread
	lib:libfftw3
	lib:libfreetype
	lib:libgcc_s
#	lib:libgflags
	lib:libgl
	lib:libglew
#	lib:libglog
	lib:libglu
	lib:libgomp
#	lib:libgtest
	lib:libhalf
	lib:libhdf5
	lib:libiconv
	lib:libiex_2_2
	lib:libilmimf_2_2
	lib:libilmthread_2_2
	lib:libimath_2_2
	lib:libjpeg
	lib:libllvm_4.0
	lib:liblzma
	lib:liblzo2
	lib:libopencolorio
	lib:libopenimageio
	lib:libopenjp2
	lib:libpng16
	lib:libpython${PYTHON_VERSION}m
	lib:libsdl2_2.0
	lib:libsndfile
	lib:libtinyxml
	lib:libtiff
	lib:libxml2
	lib:libz
	"

BUILD_REQUIRES="
	haiku_devel
#	devel:eigen
	devel:libavcodec
	devel:libboost_atomic
	devel:libboost_chrono
	devel:libboost_date_time
	devel:libboost_filesystem
	devel:libboost_locale
	devel:libboost_regex
	devel:libboost_system
	devel:libboost_thread
	devel:libfftw3
	devel:libfreetype
#	devel:libgflags
	devel:libgl
	devel:libglew
#	devel:libglog
	devel:libglu
	devel:libgomp
#	devel:libgtest
	devel:libhalf
	devel:libhdf5
	devel:libiconv
	devel:libiex_2_2
	devel:libilmimf_2_2
	devel:libilmthread_2_2
	devel:libimath_2_2
	devel:libjpeg
	devel:libllvm_4.0
	devel:liblzma
	devel:liblzo2
	devel:libopencolorio
	devel:libopenimageio
	devel:libopenjp2
	devel:libpng16
	devel:libpython${PYTHON_VERSION}m
	devel:libsdl2_2.0
	devel:libsndfile
	devel:libtinyxml
	devel:libtiff
	devel:libxml2
	devel:libz
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:git
	cmd:gcc
	cmd:ld
	cmd:make
	cmd:python${PYTHON_VERSION}
	cmd:sed
	llvm
	#python3_numpy
	#python3_requests #maybe later
	"

BUILD()
{
	mkdir -p build_haiku
	cd build_haiku

	cmake .. \
		-DPYTHON_VERSION=${PYTHON_VERSION} \
		-DPYTHON_INCLUDE_DIR=/system/develop/headers/python${PYTHON_VERSION}m/ \
		-DPYTHON_LIBRARY=/system/lib/libpython${PYTHON_VERSION}m.so.1.0 \
		-DPYTHON_EXECUTABLE=/bin/python${PYTHON_VERSION} \
		-DWITH_PYTHON_INSTALL:BOOL=ON \
		-DWITH_PYTHON_INSTALL_NUMPY:BOOL=OFF \
		-DWITH_PYTHON_INSTALL_REQUESTS:BOOL=OFF \
		-DWITH_BOOST:BOOL=ON \
		-DWITH_CYCLES:BOOL=ON \
		-DCMAKE_INSTALL_PREFIX:PATH=$INSTALL_PATH \
		-DWITH_SDL:BOOL=ON \
		-DWITH_GHOST_SDL:BOOL=ON \
		-DWITH_GAMEENGINE_DECKLINK:BOOL=OFF \
		-DWITH_OPENIMAGEIO:BOOL=ON \
		-DWITH_OPENCOLORIO:BOOL=ON \
		-DWITH_FFTW3:BOOL=ON \
		-DWITH_CODEC_SNDFILE:BOOL=ON \
		-DWITH_SYSTEM_OPENJPEG:BOOL=ON \
		-DWITH_SYSTEM_EIGEN3:BOOL=OFF \
		-DWITH_SYSTEM_LZO:BOOL=ON \
		-DWITH_SYSTEM_GLOG:BOOL=OFF \
		-DWITH_GTESTS:BOOL=OFF \
		-DWITH_SYSTEM_GFLAGS:BOOL=OFF \
		-DWITH_IMAGE_OPENEXR:BOOL=ON \
		-DWITH_LLVM:BOOL=ON \
		-DWITH_SDL_DYNLOAD:BOOL=ON \
		-DWITH_CODEC_FFMPEG:BOOL=ON \
		-DWITH_CYCLES_STANDALONE:BOOL=ON \
		-DWITH_CYCLES_STANDALONE_GUI:BOOL=ON \
		-DWITH_RAYOPTIMIZATION:BOOL=ON \
		-DWITH_CYCLES_NATIVE_ONLY:BOOL=ON \
		-Wno-dev

	make $jobArgs
}

INSTALL()
{
	cd build_haiku
	make install $jobArgs

	# Standalone Cycles doesn't installed automatically.
	mkdir -p $binDir
	cp bin/cycles $binDir

	mv $INSTALL_PATH/blender $INSTALL_PATH/Blender
	strip $INSTALL_PATH/Blender

	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2 | sed 's/[a-z]*//g'`"
	local MINOR="`echo 0`"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		$portDir/additional-files/blender.rdef.in > blender.rdef

	addResourcesToBinaries blender.rdef \
		$INSTALL_PATH/Blender

	cd $INSTALL_PATH
	mkdir -p $docDir/blender

	mv GPL-license.txt GPL3-license.txt \
		LICENSE-bfont.ttf.txt jemalloc-license.txt \
		Python-license.txt copyright.txt readme.html \
		blender.svg ocio-license.txt LICENSE-bmonofont-i18n.ttf.txt \
		LICENSE-droidsans.ttf.txt $docDir/blender

	rm -rf blender.desktop

	addAppDeskbarSymlink $INSTALL_PATH/Blender Blender
}
