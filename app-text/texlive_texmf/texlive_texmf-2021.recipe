SUMMARY="A comprehensive TeX system - texmf tree"
DESCRIPTION="TeX Live is an easy way to get up and running with the TeX \
document production system. It provides a comprehensive TeX system. It \
includes all the major TeX-related programs, macro packages, and fonts that \
are free software, including support for many languages around the world."
HOMEPAGE="http://tug.org/texlive/"
COPYRIGHT="1996 by collaboration between the TeX user groups."
LICENSE="GNU GPL v2"
REVISION="1"
fullVersion=20210325
SOURCE_URI="ftp://tug.org/historic/systems/texlive/$portVersion/install-tl-unx.tar.gz"
SOURCE_URI_2="ftp://tug.org/historic/systems/texlive/$portVersion/texlive-$fullVersion-texmf.tar.xz"
SOURCE_URI_3="ftp://tug.org/historic/systems/texlive/$portVersion/texlive-$fullVersion-extra.tar.xz"
CHECKSUM_SHA256="74eac0855e1e40c8db4f28b24ef354bd7263c1f76031bdc02b52156b572b7a1d"
CHECKSUM_SHA256_2="ff12d436c23e99fb30aad55924266104356847eb0238c193e839c150d9670f1c"
CHECKSUM_SHA256_3="46a3f385d0b30893eec6b39352135d2929ee19a0a81df2441bfcaa9f6c78339c"
SOURCE_DIR="install-tl-20210324"
SOURCE_DIR_2="texlive-$fullVersion-texmf"
SOURCE_DIR_3="texlive-$fullVersion-extra"
ADDITIONAL_FILES="texlive.profile"

ARCHITECTURES="?any"
DISABLE_SOUURCE_PACKAGE="yes"

PROVIDES="
	texlive_texmf = $portVersion
	"
REQUIRES="
	cmd:kpsewhich
	"

PROVIDES_doc="
	texlive_texmf_doc = $portVersion
	"
REQUIRES_doc="
	cmd:kpsewhich
	"

BUILD_REQUIRES="
	haiku_devel
	cmd:kpsewhich
	"
BUILD_PREREQUIRES="
	cmd:perl
	"

GLOBAL_WRITABLE_FILES="
	settings/texlive/ls-R auto-merge
	var/texlive/ls-R auto-merge
	var/texlive/tex/generic/config/language.dat auto-merge
	var/texlive/tex/generic/config/language.dat.lua auto-merge
	var/texlive/tex/generic/config/language.def auto-merge
	var/texlive/web2c/aleph/aleph.fmt auto-merge
	var/texlive/web2c/aleph/aleph.log auto-merge
	var/texlive/web2c/eptex/eptex.fmt auto-merge
	var/texlive/web2c/eptex/eptex.log auto-merge
	var/texlive/web2c/eptex/platex-dev.fmt auto-merge
	var/texlive/web2c/eptex/platex-dev.log auto-merge
	var/texlive/web2c/eptex/platex.fmt auto-merge
	var/texlive/web2c/eptex/platex.log auto-merge
	var/texlive/web2c/euptex/euptex.fmt auto-merge
	var/texlive/web2c/euptex/euptex.log auto-merge
	var/texlive/web2c/euptex/uplatex-dev.fmt auto-merge
	var/texlive/web2c/euptex/uplatex-dev.log auto-merge
	var/texlive/web2c/euptex/uplatex.fmt auto-merge
	var/texlive/web2c/euptex/uplatex.log auto-merge
	var/texlive/web2c/luahbtex/luahbtex.fmt auto-merge
	var/texlive/web2c/luahbtex/luahbtex.log auto-merge
	var/texlive/web2c/luahbtex/lualatex-dev.fmt auto-merge
	var/texlive/web2c/luahbtex/lualatex-dev.log auto-merge
	var/texlive/web2c/luahbtex/lualatex.fmt auto-merge
	var/texlive/web2c/luahbtex/lualatex.log auto-merge
	var/texlive/web2c/luajithbtex/luajithbtex.fmt auto-merge
	var/texlive/web2c/luajithbtex/luajithbtex.log auto-merge
	var/texlive/web2c/luajittex/luajittex.fmt auto-merge
	var/texlive/web2c/luajittex/luajittex.log auto-merge
	var/texlive/web2c/luatex/dvilualatex-dev.fmt auto-merge
	var/texlive/web2c/luatex/dvilualatex-dev.log auto-merge
	var/texlive/web2c/luatex/dvilualatex.fmt auto-merge
	var/texlive/web2c/luatex/dvilualatex.log auto-merge
	var/texlive/web2c/luatex/dviluatex.fmt auto-merge
	var/texlive/web2c/luatex/dviluatex.log auto-merge
	var/texlive/web2c/luatex/luacsplain.fmt auto-merge
	var/texlive/web2c/luatex/luacsplain.log auto-merge
	var/texlive/web2c/luatex/luatex.fmt auto-merge
	var/texlive/web2c/luatex/luatex.log auto-merge
	var/texlive/web2c/luatex/optex.fmt auto-merge
	var/texlive/web2c/luatex/optex.log auto-merge
	var/texlive/web2c/luatex/pdfcsplain.fmt auto-merge
	var/texlive/web2c/luatex/pdfcsplain.log auto-merge
	var/texlive/web2c/metafont/mf.base auto-merge
	var/texlive/web2c/metafont/mf.log auto-merge
	var/texlive/web2c/pdftex/amstex.fmt auto-merge
	var/texlive/web2c/pdftex/amstex.log auto-merge
	var/texlive/web2c/pdftex/cont-en.fmt auto-merge
	var/texlive/web2c/pdftex/cont-en.log auto-merge
	var/texlive/web2c/pdftex/cslatex.fmt auto-merge
	var/texlive/web2c/pdftex/cslatex.log auto-merge
	var/texlive/web2c/pdftex/csplain.fmt auto-merge
	var/texlive/web2c/pdftex/csplain.log auto-merge
	var/texlive/web2c/pdftex/eplain.fmt auto-merge
	var/texlive/web2c/pdftex/eplain.log auto-merge
	var/texlive/web2c/pdftex/etex.fmt auto-merge
	var/texlive/web2c/pdftex/etex.log auto-merge
	var/texlive/web2c/pdftex/jadetex.fmt auto-merge
	var/texlive/web2c/pdftex/jadetex.log auto-merge
	var/texlive/web2c/pdftex/latex-dev.fmt auto-merge
	var/texlive/web2c/pdftex/latex-dev.log auto-merge
	var/texlive/web2c/pdftex/latex.fmt auto-merge
	var/texlive/web2c/pdftex/latex.log auto-merge
	var/texlive/web2c/pdftex/mex.fmt auto-merge
	var/texlive/web2c/pdftex/mex.log auto-merge
	var/texlive/web2c/pdftex/mllatex.fmt auto-merge
	var/texlive/web2c/pdftex/mllatex.log auto-merge
	var/texlive/web2c/pdftex/mltex.fmt auto-merge
	var/texlive/web2c/pdftex/mltex.log auto-merge
	var/texlive/web2c/pdftex/mptopdf.fmt auto-merge
	var/texlive/web2c/pdftex/mptopdf.log auto-merge
	var/texlive/web2c/pdftex/pdfcslatex.fmt auto-merge
	var/texlive/web2c/pdftex/pdfcslatex.log auto-merge
	var/texlive/web2c/pdftex/pdfcsplain.fmt auto-merge
	var/texlive/web2c/pdftex/pdfcsplain.log auto-merge
	var/texlive/web2c/pdftex/pdfetex.fmt auto-merge
	var/texlive/web2c/pdftex/pdfetex.log auto-merge
	var/texlive/web2c/pdftex/pdfjadetex.fmt auto-merge
	var/texlive/web2c/pdftex/pdfjadetex.log auto-merge
	var/texlive/web2c/pdftex/pdflatex-dev.fmt auto-merge
	var/texlive/web2c/pdftex/pdflatex-dev.log auto-merge
	var/texlive/web2c/pdftex/pdflatex.fmt auto-merge
	var/texlive/web2c/pdftex/pdflatex.log auto-merge
	var/texlive/web2c/pdftex/pdfmex.fmt auto-merge
	var/texlive/web2c/pdftex/pdfmex.log auto-merge
	var/texlive/web2c/pdftex/pdftex.fmt auto-merge
	var/texlive/web2c/pdftex/pdftex.log auto-merge
	var/texlive/web2c/pdftex/pdfxmltex.fmt auto-merge
	var/texlive/web2c/pdftex/pdfxmltex.log auto-merge
	var/texlive/web2c/pdftex/texsis.fmt auto-merge
	var/texlive/web2c/pdftex/texsis.log auto-merge
	var/texlive/web2c/pdftex/utf8mex.fmt auto-merge
	var/texlive/web2c/pdftex/utf8mex.log auto-merge
	var/texlive/web2c/pdftex/xmltex.fmt auto-merge
	var/texlive/web2c/pdftex/xmltex.log auto-merge
	var/texlive/web2c/ptex/ptex.fmt auto-merge
	var/texlive/web2c/ptex/ptex.log auto-merge
	var/texlive/web2c/tex/lollipop.fmt auto-merge
	var/texlive/web2c/tex/lollipop.log auto-merge
	var/texlive/web2c/tex/tex.fmt auto-merge
	var/texlive/web2c/tex/tex.log auto-merge
	var/texlive/web2c/uptex/uptex.fmt auto-merge
	var/texlive/web2c/uptex/uptex.log auto-merge
	var/texlive/web2c/xetex/cont-en.fmt auto-merge
	var/texlive/web2c/xetex/cont-en.log auto-merge
	var/texlive/web2c/xetex/pdfcsplain.fmt auto-merge
	var/texlive/web2c/xetex/pdfcsplain.log auto-merge
	var/texlive/web2c/xetex/xelatex-dev.fmt auto-merge
	var/texlive/web2c/xetex/xelatex-dev.log auto-merge
	var/texlive/web2c/xetex/xelatex.fmt auto-merge
	var/texlive/web2c/xetex/xelatex.log auto-merge
	var/texlive/web2c/xetex/xetex.fmt auto-merge
	var/texlive/web2c/xetex/xetex.log auto-merge
	"

fetchTexLiveInstaller()
{
	# Put the texmf-dist into the correct location
	rm -rv texmf-dist || true
	ln -sv $sourceDir2/texmf-dist/ texmf-dist

	# Link our binaries to bin/{i386,x86_64}-haiku

	if [ $targetArchitecture = x86_gcc2 ] || [ $targetArchitecture = x86 ]; then
		if [ ! -e bin/i386-haiku ] ; then
			mkdir -p bin
			ln -s /boot/system/bin bin/i386-haiku
		fi

	elif [ $targetArchitecture = x86_64 ]; then
		if [ ! -e bin/x86_64-haiku ] ; then
			mkdir -p bin
			ln -s /boot/system/bin bin/x86_64-haiku
		fi
	fi

	# link or copy the needed files from the "extra" sources
	rm -v tlpkg/{texlive.tlpdb,tlpostcode} readme-{html,txt}.dir README{,.usergroups} {index,doc}.html || true
	ln -sv $sourceDir3/tlpkg/{texlive.tlpdb,tlpostcode} tlpkg
	ln -sv $sourceDir3/readme-{html,txt}.dir .
	cp -v $sourceDir3/{README{,.usergroups},{index,doc}.html} .
}

PATCH() {
	sed -i "s|\`kpsewhich -var-value=SELFAUTOPARENT\`|\"$dataDir/texlive\"|" $sourceDir/tlpkg/TeXLive/TLUtils.pm
}

INSTALL()
{
	fetchTexLiveInstaller
	export TEXLIVE_INSTALL_PREFIX=$dataDir/texlive
	export TEXLIVE_INSTALL_TEXMFSYSVAR=$sharedStateDir/texlive
	export TEXLIVE_INSTALL_TEXMFSYSCONFIG=$sysconfDir/texlive
	export TEXLIVE_INSTALL_TEXMFLOCAL=/boot/system/non-packaged/data/texmf-dist
	export TEXLIVE_INSTALL_TEXMFVAR=/boot/home/config/var/texmf
	export TEXLIVE_INSTALL_TEXMFCONFIG=/boot/home/config/settings/texmf/config
	export TEXLIVE_INSTALL_TEXMFHOME=/boot/home/config/settings
	# hmm, need to work-around /boot/system/non-packaged not existing....
	# the texfm local tree should probably be done with a post-install script, perhaps
	sed -i -e 's/make_local_skeleton \".*//' install-tl
	# run the TeX Live installer, and specify all our paths, once more, to be sure... ;-)
	export PATH=bin/i386-haiku:bin/${targetArchitecture}-haiku:$binDir:$PATH
	if [ $targetArchitecture = x86_gcc2 ] || [ $targetArchitecture = x86 ]; then
		customBinDir=bin/i386-haiku/
	else
		customBinDir=bin/${targetArchitecture}-haiku/
	fi
	sed -e "s@dataDir@$dataDir@g" \
		-e "s@sharedStateDir@$sharedStateDir@g" \
		-e "s@sysconfDir@$sysconfDir@g" \
		$portDir/additional-files/texlive.profile > texlive.profile
	install-tl --custom-bin=$customBinDir --profile=texlive.profile

	# somewhere along the way, a texmf.cnf gets created with ALL the wrong paths...
	# replace it with the known working version from the main texlive package
	cp -f /boot/system/data/texmf-dist/web2c/texmf.cnf $dataDir/texlive/texmf-dist/web2c/texmf.cnf

	# some reason, this doesn't get created, which we need
	if [ ! -e $prefix/bin/mktexfmt ] ; then
		ln -s fmtutil $prefix/bin/mktexfmt
	fi

	# needed post-install steps apparently not done by install-tl
	fmtutil-sys --all
	#mtxrun --generate

	# remove useless libtool files and other unneeded files
	rm -f $libDir/*.la

	rm -rf $dataDir/texlive/bin
	rm -f $dataDir/texlive/install-tl*

	# texmf_doc package
	packageEntries doc \
		$dataDir/texlive/texmf-dist/doc

	# exit 1
}

TEST()
{
	make check
}
