SUMMARY="Next generation ConTeXt processing engine"
DESCRIPTION="The LuaMetaTeX program is a light weight variant of LuaTeX. This program finds its \
origin in parts of TeX (the original program, eTeX (some extensions), pdfTeX (more extensions) \
Aleph (based on Omega, directions) and of course LuaTeX (lots of things).

This is a follow up on the LuaTeX project. The source is considered part of the ConTeXt \
distribution and managed by the ConTeXt development team and the ConTeXt user group. That way it \
can be guaranteed that the engine and this TeX macro package work together as expected. The idea \
is that users can easily compile the source themselves and that way have a guaranteed long term \
(minimal) TeX based installation. Because the management scripts are in Lua, only one binary is \
needed to serve the ConTeXt distribution.

In the source code it was tried to stay close to the ancestors, LuaTeX, pdfTeX, eTeX and TeX, but \
in the meantime due to additions there is quite some diverge. There are new primitives and \
submechanisms, there is more control over the inner workings, font handling is mostly delegated \
to Lua and there is no built-in backend. The code base is all-inclusive and has no (nor will \
have) dependencies on external libraries. Performance and memory consumption have been optimized \
and the additions (compared to LuaTeX) donâ€™t have a negative impact."
HOMEPAGE="https://github.com/contextgarden/luametatex"
COPYRIGHT="Taco Hoekwater & Hans Hagen & Wolfgang Schuster"
LICENSE="GNU GPL v2"
REVISION="1"

# download from texlive SVN repo in case the GitHub repo is outdated (now not available any more):
#srcSvnRev="74428"
#SOURCE_URI="https://svn.tug.org:8369/texlive/trunk/Master/source/luametatex-$portVersion.tar.xz?revision=$srcSvnRev&view=co"
#CHECKSUM_SHA256="a2ed3859c2a7c842539145781e1946c034ec71d1094df946bf472937af6a9161"
#SOURCE_DIR="luametatex"

# main download location:
SOURCE_URI="https://github.com/contextgarden/luametatex/archive/refs/tags/v$portVersion.tar.gz"
CHECKSUM_SHA256="cf825633ee10a7bbf2a9bf98aa6842de5ef23258e8c370560c19ff5581b3d534"

PATCHES="luametatex-$portVersion.patchset"
ADDITIONAL_FILES="luametatex_postinstall.sh"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

POST_INSTALL_SCRIPTS="$relativePostInstallDir/luametatex_postinstall.sh"

PROVIDES="
	luametatex$secondaryArchSuffix = $portVersion
	cmd:context = $portVersion
	cmd:context.lua
	cmd:luametatex = $portVersion
	cmd:mtxrun = $portVersion
	cmd:mtxrun.lua
	"
REQUIRES="
	haiku$secondaryArchSuffix
	tex:context
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:make
	"

BUILD()
{
	cmake -Bbuild -S. -DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_BINDIR=$prefix/bin
	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	# install symlinks
	ln -s luametatex $prefix/bin/context
	ln -s luametatex $prefix/bin/mtxrun
	ln -s $portPackageLinksDir/tex~context/data/texlive/texmf-dist/scripts/context/lua/context.lua \
		$prefix/bin/context.lua
	ln -s $portPackageLinksDir/tex~context/data/texlive/texmf-dist/scripts/context/lua/mtxrun.lua \
		$prefix/bin/mtxrun.lua

	# install post-install script
	mkdir -p $postInstallDir
	install -t $postInstallDir -m 755 $portDir/additional-files/luametatex_postinstall.sh
}
