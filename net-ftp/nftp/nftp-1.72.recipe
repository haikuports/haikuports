SUMMARY="A text-mode ftp client"
DESCRIPTION="NFTP is a text-mode ftp client."
HOMEPAGE="http://www.ayukov.com/nftp"
COPYRIGHT="1994-2011 Sergey Ayukov"
LICENSE="MIT"
REVISION="1"
SOURCE_URI="ftp://ftp.ayukov.com/pub/src/nftp-$portVersion.zip"
CHECKSUM_SHA256="f8ba51aaca781b4fbde85d801204b3fdf29209f4610e33441436450d3f659fe3"
SOURCE_DIR="NFTP-$portVersion"
#patch includes a CFLAG fix for the build
PATCHES="nftp-$portVersion.patchset"
#libasvtools
SOURCE_URI_2="ftp://ftp.ayukov.com/pub/src/libasvtools-1.0.0.tar.gz"
CHECKSUM_SHA256_2="286dc7e661aa70b98ac317b5e26c8b74807783ea341653df8ef43c574c02de8e"
SOURCE_DIR_2="libasvtools-1.0.0"
#libmanycode
SOURCE_URI_3="ftp://ftp.ayukov.com/pub/src/libmanycode-1.0.0.tar.gz"
CHECKSUM_SHA256_3="5212a4b80a697718d7ce1ee13849c5caee761c85e819f03b5c4cfb2c24871b25"
SOURCE_DIR_3="libmanycode-1.0.0"
#libftpsearch and patch
SOURCE_URI_4="ftp://ftp.ayukov.com/pub/src/libftpsearch-1.0.tar.gz"
CHECKSUM_SHA256_4="bb196178c099a707ee6812424e742cf0882bb64cb66ba6a42d875711912125b8"
SOURCE_DIR_4="libftpsearch"
PATCHES_4="nftp-1.72-source4.patchset"
#libcrypto and patch
SOURCE_URI_5="ftp://ftp.ayukov.com/pub/src/libcrypto-1.0.tar.gz"
CHECKSUM_SHA256_5="b6e98313044ed14216e3edbc01fbc56e35c209cdfa6725c1934bdaa52efc6dc0"
SOURCE_DIR_5="libcrypto"
PATCHES_5="nftp-1.72-source5.patchset"
#libfly and patch
SOURCE_URI_6="ftp://ftp.ayukov.com/pub/src/libfly-1.0.tar.gz"
CHECKSUM_SHA256_6="6226d4c19f00a296c002b8d36bdf835376cb3cd4547a4e85364262731156b85f"
SOURCE_DIR_6="libfly"
PATCHES_6="nftp-1.72-source6.patchset"

ARCHITECTURES="x86_gcc2 !x86_64"

PROVIDES="
	nftp = $portVersion
	cmd:nftp = $portVersion
	lib:libasvtools = 0.0.0 compat >= 0
	lib:libmanycode = 0.0.0 compat >= 0
	"
REQUIRES="
	haiku
	lib:libasvtools
	lib:libmanycode
	lib:libncurses
	"

PROVIDES_devel="
	nftp_devel = $portVersion
	devel:libasvtools = 0.0.0 compat >= 0
	devel:libmanycode = 0.0.0 compat >= 0
	devel:libfsearch
	devel:libscl
	devel:libfly_beos_term
	"
REQUIRES_devel="
	nftp == $portVersion base
	"

BUILD_REQUIRES="
	haiku_devel
	devel:libncurses
	"
BUILD_PREREQUIRES="
	cmd:aclocal
	cmd:autoconf
	cmd:gcc
	cmd:libtoolize
	cmd:make
	"

BUILD()
{
	#create needed directories for the build
	#install/copy to have the needed libs/headers around
	#to be able to build the needed stuff
	mkdir -p $libDir \
		$includeDir/fly \
		$sourceDir/build

	#libasvtools
	cd $sourceDir2
	libtoolize -fci
	autoreconf -vfi
	runConfigure ./configure
	make $jobArgs
	make install

	#link to the packaging directory for the headers and libraries
	#this needs to be done after the first library is build
	ln -sf ../../../packaging $sourceDir/build

	#libmanycode
	cd $sourceDir3
	libtoolize -fci
	autoreconf -vfi
	runConfigure ./configure CFLAGS="-I$sourceDir/build/packaging/nftp/develop/headers" \
		LDFLAGS="-L$sourceDir/build/packaging/nftp/lib"
	make $jobArgs
	make install

	#copy the next static libs to $libDir so the build section will see them
	#copy the next headers to the correct place to be picked up

	#libftpsearch
	cd $sourceDir4
	make $jobArgs
	cp $sourceDir4/libfsearch.a $libDir
	cp $sourceDir4/fsearch.h $includeDir

	#libcrypto
	cd $sourceDir5
	make $jobArgs
	cp $sourceDir5/libscl.a $libDir
	cp $sourceDir5/scl.h $includeDir

	#libfly
	cd $sourceDir6
	make TARGETS=beos_term $jobArgs
	cp $sourceDir6/src/libfly_beos_term.a $libDir
	cp $sourceDir6/src/fly/* $includeDir/fly

	#nftp
	cd $sourceDir
	make clean
	make PLATFORM=i386-haiku1 $jobArgs
}

INSTALL()
{
	#create needed directories
	mkdir -p $binDir $libDir/nftp \
		$docDir $developLibDir

	#remove libtool file
	rm -f $libDir/*.la

	#move the static libs to the proper develop directory
	mv -f $libDir/libfly_beos_term.a $developLibDir
	mv -f $libDir/libfsearch.a $developLibDir
	mv -f $libDir/libscl.a $developLibDir

	#install the devel libraries needed for nftp
	prepareInstalledDevelLibs libasvtools libmanycode
	#devel package
	packageEntries devel \
		$developDir

	#nftp
	cd $sourceDir
	make distcopy
	cd nftp-1.72
	chmod +x install.sh
	./install.sh
	mv nftp_beos_term $binDir/nftp
	cp -R documentation/nftp/* $docDir
	cp -R nftp/* $libDir/nftp #still need to cp the files to ~/.nftp
}
