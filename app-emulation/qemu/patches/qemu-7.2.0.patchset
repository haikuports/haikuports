From 18e0e12f7efb9700a8b5defc97bb6ed8c22fe8f7 Mon Sep 17 00:00:00 2001
From: Alexander von Gluck IV <kallisti5@unixzen.com>
Date: Tue, 18 May 2021 16:49:20 -0500
Subject: haiku: fixes and patches, rebased from qemu 3.x


diff --git a/disas/nanomips.c b/disas/nanomips.c
index a025359..e877de2 100644
--- a/disas/nanomips.c
+++ b/disas/nanomips.c
@@ -30,10 +30,14 @@
 #include "qemu/osdep.h"
 #include "disas/dis-asm.h"
 
+#ifndef __HAIKU__
 typedef int64_t int64;
 typedef uint64_t uint64;
 typedef uint32_t uint32;
 typedef uint16_t uint16;
+#else
+#include <SupportDefs.h>
+#endif
 typedef uint64_t img_address;
 
 typedef enum  {
diff --git a/os-posix.c b/os-posix.c
index 4858650..2d21c8b 100644
--- a/os-posix.c
+++ b/os-posix.c
@@ -42,6 +42,16 @@
 #include "qemu/async-teardown.h"
 #endif
 
+#ifdef __HAIKU__
+#ifndef MCL_CURRENT
+#define MCL_CURRENT 8192
+#endif
+#ifndef MCL_FUTURE
+#define MCL_FUTURE 16384
+#endif
+#endif
+
+
 /*
  * Must set all three of these at once.
  * Legal combinations are              unset   by name   by uid
diff --git a/util/main-loop.c b/util/main-loop.c
index 10fa74c..727ef80 100644
--- a/util/main-loop.c
+++ b/util/main-loop.c
@@ -99,7 +99,9 @@ static int qemu_signal_init(Error **errp)
      */
     sigemptyset(&set);
     sigaddset(&set, SIG_IPI);
+    #ifdef SIGIO
     sigaddset(&set, SIGIO);
+    #endif
     sigaddset(&set, SIGALRM);
     sigaddset(&set, SIGBUS);
     /* SIGINT cannot be handled via signalfd, so that ^C can be used
diff --git a/util/notify.c b/util/notify.c
index 76bab21..7c1ea84 100644
--- a/util/notify.c
+++ b/util/notify.c
@@ -67,6 +67,10 @@ int notifier_with_return_list_notify(NotifierWithReturnList *list, void *data)
     int ret = 0;
 
     QLIST_FOREACH_SAFE(notifier, &list->notifiers, node, next) {
+        #ifdef __HAIKU__
+        if(notifier->notify == NULL) break;
+        #endif
+
         ret = notifier->notify(notifier, data);
         if (ret != 0) {
             break;
-- 
2.37.3

