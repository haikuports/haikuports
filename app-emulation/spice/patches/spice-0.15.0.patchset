From 4844b9ad94f23a31d3bf1bb89b03ef78c480aa81 Mon Sep 17 00:00:00 2001
From: Han Pengfei <pengphei@qq.com>
Date: Sun, 16 Oct 2022 01:21:46 +0000
Subject: fix meson build


diff --git a/meson.build b/meson.build
index fa3cfe5..09de360 100644
--- a/meson.build
+++ b/meson.build
@@ -104,9 +104,11 @@ foreach dep : ['libjpeg', 'zlib']
 endforeach
 
 if host_machine.system() != 'windows'
-  foreach dep : ['rt', 'm']
-    spice_server_deps += compiler.find_library(dep)
-  endforeach
+	if host_machine.system() != 'haiku'
+  		foreach dep : ['rt', 'm']
+    		spice_server_deps += compiler.find_library(dep)
+  		endforeach
+  	endif
 else
   foreach dep : ['ws2_32', 'shlwapi']
     spice_server_deps += compiler.find_library(dep)
diff --git a/subprojects/spice-common/meson_options.txt b/subprojects/spice-common/meson_options.txt
index 9f10a63..ce38053 100644
--- a/subprojects/spice-common/meson_options.txt
+++ b/subprojects/spice-common/meson_options.txt
@@ -28,7 +28,7 @@ option('smartcard',
 
 option('python-checks',
     type : 'boolean',
-    value : true,
+    value : false,
     description : 'Enable checks for Python modules needed to build from git')
 
 option('manual',
-- 
2.37.3


From cadd4afbc09417c70d8f9509b8251f3ee2044922 Mon Sep 17 00:00:00 2001
From: Han Pengfei <pengphei@qq.com>
Date: Sun, 16 Oct 2022 02:21:30 +0000
Subject: disable doxygen


diff --git a/meson.build b/meson.build
index 09de360..67a4ada 100644
--- a/meson.build
+++ b/meson.build
@@ -231,4 +231,4 @@ endif
 configure_file(output : 'config.h',
                configuration : spice_server_config_data)
 
-run_target('doxy', command : './doxygen.sh')
+#run_target('doxy', command : './doxygen.sh')
-- 
2.37.3


From 038603b5e9cdfb93df78cc7f632c7a6e765706c1 Mon Sep 17 00:00:00 2001
From: Han Pengfei <pengphei@qq.com>
Date: Sun, 16 Oct 2022 02:32:46 +0000
Subject: Fix SUN_LEN missing


diff --git a/server/reds.cpp b/server/reds.cpp
index fa6e393..7db0c9b 100644
--- a/server/reds.cpp
+++ b/server/reds.cpp
@@ -78,6 +78,11 @@
 #include "net-utils.h"
 #include "red-stream-device.h"
 
+#ifndef SUN_LEN
+#define SUN_LEN(su) \
+		(sizeof(*(su)) - sizeof((su)->sun_path) + strlen((su)->sun_path))
+#endif
+
 #define REDS_MAX_STAT_NODES 100
 
 static void reds_client_monitors_config(RedsState *reds, VDAgentMonitorsConfig *monitors_config);
-- 
2.37.3


From 729509975ca13b344221dada27825194f3cff6a0 Mon Sep 17 00:00:00 2001
From: Han Pengfei <pengphei@qq.com>
Date: Sun, 16 Oct 2022 02:36:23 +0000
Subject: fix missing pthread_setname_np


diff --git a/server/red-worker.cpp b/server/red-worker.cpp
index 4d0a236..7022509 100644
--- a/server/red-worker.cpp
+++ b/server/red-worker.cpp
@@ -1130,7 +1130,7 @@ bool red_worker_run(RedWorker *worker)
 #ifndef _WIN32
     pthread_sigmask(SIG_SETMASK, &curr_sig_mask, nullptr);
 #endif
-#if !defined(__APPLE__)
+#if !defined(__APPLE__) && !defined(__HAIKU__)
     pthread_setname_np(worker->thread, "SPICE Worker");
 #endif
 
-- 
2.37.3

