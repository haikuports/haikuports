SUMMARY="Tiniest x86-64-linux emulator"
DESCRIPTION="blink is a virtual machine that runs x86-64-linux programs \
on different operating systems and hardware architectures."
HOMEPAGE="https://github.com/jart/blink"
COPYRIGHT="2022 Justine Alexandra Roberts Tunney"
LICENSE="ISC"
REVISION="1"
srcGitRev="98f95e8383d1032eb4d2dc6aae937b23539e915e"

SOURCE_URI="https://github.com/jart/blink/archive/$srcGitRev.tar.gz"
CHECKSUM_SHA256="c0ceb4479cd719b03af56e4dca7f2f8436e65858117eee5c1b50777afff9e0f9"
SOURCE_DIR="blink-$srcGitRev"

ARCHITECTURES="ALL !x86_gcc2"
# x86 is unsupported

PROVIDES="
	blink = $portVersion
	cmd:blink = $portVersion
	cmd:blinkenlights = $portVersion
	"
REQUIRES="
	haiku
	"
BUILD_REQUIRES="
	haiku_devel
	"
BUILD_PREREQUIRES="
	cmd:gcc
	cmd:make
	"

PATCHES="
	blink-1.1.0~git.patchset
	"

BUILD()
{
	# not doing this causes it to hang forever sometimes
	# (if you run the build multiple times without cleaning the working dir)
	#	make clean || true

	./configure \
		--enable-vfs \
		--enable-sockets \
		--prefix="$prefix"

	make $jobArgs
}

INSTALL()
{
	mkdir -p "$binDir"
	install -Dm755 o/blink/blink "$binDir"/blink
	install -Dm755 o/blink/blinkenlights "$binDir"/blinkenlights
	mkdir -p "$manDir"
	install -Dm644 blink/blink.1 "$manDir"/blink.1
	install -Dm644 blink/blinkenlights.1 "$manDir"/blinkenlights.1

	# `make install` hangs forever and even crashed haiku for me for some reason,
	# so let's do the installation manually for now
}

TEST()
{
	make check
}
