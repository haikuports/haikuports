SUMMARY="Enhanced Wolfenstein 3D source port"
DESCRIPTION="ECWolf is an advanced source port for Wolfenstein 3D, \
Spear of Destiny and Super 3D Noah's Ark based off of the Wolf4SDL \
code base. ECWolf aims to provide a wide array of mod editing \
capabilities without the need to modify the source code.

For players, ECWolf provides many useful features such as better \
control binding, support for wide screen resolutions, and unlimited \
save slots. ECWolf allows you to keep all of your game data \
in one directory as one binary plays all supported games.

The binaries will look for compatible data files in:
* ~/config/non-packaged/data/ecwolf
* ~/config/settings/ecwolf
* The current folder (when run from command-line)"
HOMEPAGE="https://maniacsvault.net/ecwolf/"
COPYRIGHT="2004-2025 the ECWolf team"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="https://maniacsvault.net/ecwolf/files/ecwolf/1.x/ecwolf-${portVersion}-src.tar.xz"
CHECKSUM_SHA256="2121fb3fc63e532423681dcddf5d3848e19e8c6b4e2e1bfa802b16a2d42f84f5"
SOURCE_DIR="ecwolf-${portVersion}-src"
PATCHES="ecwolf-$portVersion.patchset"
ADDITIONAL_FILES="ecwolf.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	ecwolf$secondaryArchSuffix = $portVersion
	cmd:ecwolf = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libbz2$secondaryArchSuffix
	lib:libjpeg$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libSDL2_mixer_2.0$secondaryArchSuffix
	lib:libSDL2_net_2.0$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libbz2$secondaryArchSuffix
	devel:libflac$secondaryArchSuffix
	devel:libfluidsynth$secondaryArchSuffix
	devel:libjpeg$secondaryArchSuffix
	devel:libmodplug$secondaryArchSuffix
	devel:libogg$secondaryArchSuffix
	devel:libopus$secondaryArchSuffix
	devel:libopusfile$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libSDL2_mixer_2.0$secondaryArchSuffix
	devel:libSDL2_net_2.0$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	# -lSDL2_mixer is needed since at least 22 Oct 2025
	# It wasn't needed in earlier Haiku build environments
	# So check in the future if it's still needed:
	# https://github.com/haikuports/haikuports/issues/13089
	export LDFLAGS="-lbsd -lnetwork -lSDL2_mixer"

	cmake -Bbuild -S. $cmakeDirArgs \
		-Wno-dev -Wno-error=dev -Wno-deprecated \
		-DCMAKE_BUILD_TYPE=Release -DNO_GTK=ON \
		-DCMAKE_CXX_FLAGS="-D_DEFAULT_SOURCE -D_GNU_SOURCE"

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	# Remove *nixy desktop files
	rm -r $dataDir/{applications,icons,metainfo}

	# Generate the rdef
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		$portDir/additional-files/ecwolf.rdef.in > ecwolf.rdef

	addResourcesToBinaries ecwolf.rdef $prefix/bin/ecwolf
	addAppDeskbarSymlink $prefix/bin/ecwolf "ECWolf"
}
