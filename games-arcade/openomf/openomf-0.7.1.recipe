SUMMARY="Open Source remake of One Must Fall 2097"
DESCRIPTION="OpenOMF is an Open Source remake of 'One Must Fall 2097' by Diversions Entertainment.
Since the original DOS game from 1994 uses IPX networking and is a pain to set up, the community needed \
a better solution to keep playing the game we love. Together with networking, we try to make it easier \
to play One Must Fall in its original glory on multiple platforms.

The original game's data is included, as it was made freeware in 1999."
HOMEPAGE="https://www.openomf.org/"
COPYRIGHT="
	1994-1995 Diversions Entertainment
	2025 OpenOMF team
	"
LICENSE="MIT"
REVISION="1"
SOURCE_URI="https://github.com/omf2097/openomf/archive/refs/tags/$portVersion.tar.gz"
CHECKSUM_SHA256="2d1b8ab2353f23ef51999fc400cd848345064464fee65f2f6f5523544bac36e5"
SOURCE_DIR="openomf-$portVersion"
SOURCE_URI_2="https://www.omf2097.com/pub/files/omf/omf2097-assets.zip"
CHECKSUM_SHA256_2="de472c786adf9e618bf4b71a5f2cb85bb0b090f27da2b3008f305453a8dea67d"
SOURCE_DIR_2="OMF2097"
PATCHES="openomf-$portVersion.patchset"
ADDITIONAL_FILES="openomf.rdef.in"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURE="x86"

PROVIDES="
	openomf$secondaryArchSuffix = $portVersion
	cmd:openomf = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libargtable2$secondaryArchSuffix
	lib:libconfuse$secondaryArchSuffix
	lib:libenet$secondaryArchSuffix
	lib:libepoxy$secondaryArchSuffix
	lib:libpng16$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libSDL2_mixer_2.0$secondaryArchSuffix
	lib:libxmp$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libargtable2$secondaryArchSuffix
	devel:libconfuse$secondaryArchSuffix
	devel:libenet$secondaryArchSuffix
	devel:libepoxy$secondaryArchSuffix
	devel:libopusfile$secondaryArchSuffix
	devel:libpng16$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libSDL2_mixer_2.0$secondaryArchSuffix
	devel:libxmp$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	#cmd:git #Optional, build wants it for SHA hash
	cmd:make
	"

BUILD()
{
	#These don't work for some reason
	#export OPENOMF_RESOURCE_DIR="$dataDir/openomf" OPENOMF_SHADER_DIR="$dataDir/openomf/shaders"

	cmake -Bbuild -S. -DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=$prefix

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	#Cleanup
	mv -t $dataDir/openomf $prefix/share/games/openomf/*
	rm -rf $prefix/share
	cp -t $dataDir/openomf $sourceDir2/*
	mkdir -p $appsDir
	mv $prefix/bin/openomf $appsDir/OpenOMF

	# Generate the rdef
	local MAJOR="`echo "$portVersion" | cut -b1`"
	local MIDDLE="`echo "$portVersion" | cut -b3`"
	local MINOR="0"
	local LONG_INFO="$SUMMARY"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		$portDir/additional-files/openomf.rdef.in > openomf.rdef

	addResourcesToBinaries openomf.rdef $appsDir/OpenOMF
	addAppDeskbarSymlink $appsDir/OpenOMF
}
