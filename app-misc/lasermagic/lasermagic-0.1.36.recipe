SUMMARY="Open-source tool designed for laser cutting and engraving"
DESCRIPTION="LaserMagic is a powerful, open-source tool designed for laser cutting and engraving, \
written entirely in Rust. Compatible with both Windows and Linux operating systems, \
LaserMagic provides a seamless experience for users seeking to generate GRBL files \
interpretable by laser machines.

Features:
- GRBL File Generation: The tool facilitates the creation of GRBL files, ensuring compatibility \
  with a wide range of laser machines.
- SVG File Support: One of LaserMagic's standout features is its ability to save all project \
  data within SVG files. This not only enhances portability but also ensures that designs are \
  easily shareable and editable across different platforms and software.
- Cross-Platform Compatibility: Whether you're running Windows or Linux, LaserCut delivers \
  consistent performance and reliability.
- User-Friendly Interface: With a clean and intuitive interface, LaserCut caters to users of all \
  skill levels, making the laser cutting and engraving process accessible to everyone."
HOMEPAGE="https://lasermagic.ci-yow.com/"
COPYRIGHT="2025 BenoÃ®t Forgette alias MadSquirrel"
LICENSE="GNU GPL v3"
REVISION="1"
SOURCE_URI="https://gitlab.com/MadSquirrels/lasermagic/laser_tool/-/archive/v$portVersion/laser_tool-v$portVersion.tar.bz2"
SOURCE_DIR="lasermagic-v$portVersion-056c2a5cfaab55220a547b3e69f950a3d006d41a"
CHECKSUM_SHA256="fab22cd5c4d7a129bc83377e5cea834eae73549db685546b5c62345f7b1c5170"
PATCHES="lasermagic-$portVersion.patchset"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	lasermagic$secondaryArchSuffix = $portVersion
	cmd:laser_magic_cli = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
#	tinycss2_python310 # Incscape dependency?
#	appdirs_python310 # Inkscape dependency? use pip3 install for this
	cmd:python3.10
	lib:libcrypto$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libssl$secondaryArchSuffix >= 3
	"
BUILD_PREREQUIRES="
	cmd:cargo$secondaryArchSuffix
	cmd:cc$secondaryArchSuffix
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	cargo fetch --locked
	cargo build --release --verbose
}

INSTALL()
{
	# Install binary
	install -Dm755 "target/release/laser-magic-cli" "$prefix/bin/laser-magic-cli"

	# Install documentation
	install -Dm644 README.md "$documentationDir/$portBaseName/README.md"
	install -Dm644 CHANGELOG.md "$documentationDir/$portBaseName/CHANGELOG.md"

	# Install Inkscape plugins (following the Makefile logic)
	# Create directories
	install -d "$dataDir/inkscape/extensions/lasermagic"
	install -d "$dataDir/inkscape/palettes"

	# Update version in the inx files
	VERSION=$(grep -m 1 '^version' lib/Cargo.toml | cut -d '=' -f2 | sed -E 's/.*"(.*).*"/\1/g')
	for inx in plugins/src/*.inx; do
		sed "s/#VERSION#/$VERSION/g" "$inx" > "${inx}.tmp"
		install -Dm644 "${inx}.tmp" "$dataDir/inkscape/extensions/lasermagic/$(basename $inx)"
		rm "${inx}.tmp"
	done

	# Copy Python scripts
	for py in plugins/src/*.py; do
		install -Dm755 "$py" "$dataDir/inkscape/extensions/lasermagic/$(basename $py)"
	done

	# Copy shared libraries
	install -Dm644 target/release/libliblasermagic.so "$dataDir/inkscape/extensions/lasermagic/"

	# Copy palette
	install -Dm644 plugins/src/*.gpl "$dataDir/inkscape/palettes/"
}
