From 3f052c39ec8335691c0b9d63cdc743235e8687d5 Mon Sep 17 00:00:00 2001
From: Chris Roberts <cpr420@gmail.com>
Date: Sun, 30 Jul 2023 01:14:33 -0600
Subject: disable `be-resources` when building from HaikuPorts

It isn't necessary since we add our own resources and the chroot doesn't have
the haiku_datatranslators package active when building which causes
`be-resources` to exit with an error when it can't translate the emacs.png
file.

diff --git a/src/Makefile.in b/src/Makefile.in
index b5d88eb..5b0c42c 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -673,8 +673,8 @@ endif
 ifeq ($(HAVE_BE_APP),yes)
 Emacs: emacs$(EXEEXT) $(libsrc)/be-resources
 	$(AM_V_GEN) cp -f emacs$(EXEEXT) $@
-	$(AM_V_at) $(libsrc)/be-resources \
-	  $(etc)/images/icons/hicolor/32x32/apps/emacs.png $@
+#	$(AM_V_at) $(libsrc)/be-resources \
+#	  $(etc)/images/icons/hicolor/32x32/apps/emacs.png $@
 Emacs.pdmp: $(pdmp)
 	$(AM_V_GEN) cp -f $(pdmp) $@
 endif
-- 
2.45.2


From a051077da617a62c7580eb9504044a75e30ff36a Mon Sep 17 00:00:00 2001
From: Vincent Filou <vincent.filou@gmail.com>
Date: Sun, 9 Nov 2025 19:02:38 +0000
Subject: alt key fix


diff --git a/src/haiku_support.cc b/src/haiku_support.cc
index 782e9a3..64abb2e 100644
--- a/src/haiku_support.cc
+++ b/src/haiku_support.cc
@@ -427,6 +427,40 @@ map_caps (uint32_t kc, uint32_t *ch)
   key_map_lock.Unlock ();
 }
 
+static void
+map_option (uint32_t kc, uint32_t *ch)
+{
+  if (!key_map_lock.Lock ())
+    gui_abort ("Failed to lock keymap");
+  if (!key_map)
+    get_key_map (&key_map, &key_chars);
+  if (!key_map)
+    return;
+  if (kc >= 128)
+    return;
+
+  int32_t m = key_map->option_map[kc];
+  map_key (key_chars, m, ch);
+  key_map_lock.Unlock ();
+}
+
+static void
+map_shift_option (uint32_t kc, uint32_t *ch)
+{
+  if (!key_map_lock.Lock ())
+    gui_abort ("Failed to lock keymap");
+  if (!key_map)
+    get_key_map (&key_map, &key_chars);
+  if (!key_map)
+    return;
+  if (kc >= 128)
+    return;
+
+  int32_t m = key_map->option_shift_map[kc];
+  map_key (key_chars, m, ch);
+  key_map_lock.Unlock ();
+}
+
 static void
 map_caps_shift (uint32_t kc, uint32_t *ch)
 {
@@ -1087,7 +1121,7 @@ class EmacsWindow : public BWindow
 	if (mods & B_COMMAND_KEY)
 	  rq.modifiers |= HAIKU_MODIFIER_ALT;
 
-	if (mods & B_OPTION_KEY)
+	if (mods & B_LEFT_OPTION_KEY)
 	  rq.modifiers |= HAIKU_MODIFIER_SUPER;
 
 	/* mods & B_SHIFT_KEY should be inverted if keycode is
@@ -1137,14 +1171,21 @@ class EmacsWindow : public BWindow
 		if (mods & B_CAPS_LOCK)
 		  map_caps_shift (key, &rq.multibyte_char);
 		else
-		  map_shift (key, &rq.multibyte_char);
+		  if(mods & B_RIGHT_OPTION_KEY)
+			map_shift_option(key, &rq.multibyte_char);
+		  else
+			map_shift (key, &rq.multibyte_char);
 	      }
 	    else
 	      {
-		if (mods & B_CAPS_LOCK)
-		  map_caps (key, &rq.multibyte_char);
-		else
-		  map_normal (key, &rq.multibyte_char);
+			if(mods & B_RIGHT_OPTION_KEY)
+				map_option(key, &rq.multibyte_char);
+			else{
+				if (mods & B_CAPS_LOCK)
+					map_caps (key, &rq.multibyte_char);
+				else
+					map_normal (key, &rq.multibyte_char);
+			}
 	      }
 	  }
 
@@ -1167,7 +1208,7 @@ class EmacsWindow : public BWindow
 	if (mods & B_COMMAND_KEY)
 	  rq.modifiers |= HAIKU_MODIFIER_ALT;
 
-	if (mods & B_OPTION_KEY)
+	if (mods & B_LEFT_OPTION_KEY)
 	  rq.modifiers |= HAIKU_MODIFIER_SUPER;
 
 	float dx, dy;
@@ -2013,7 +2054,7 @@ class EmacsView : public BView
     if (mods & B_COMMAND_KEY)
       rq.modifiers |= HAIKU_MODIFIER_ALT;
 
-    if (mods & B_OPTION_KEY)
+    if (mods & B_LEFT_OPTION_KEY)
       rq.modifiers |= HAIKU_MODIFIER_SUPER;
 
     if (!scroll_bar)
@@ -2100,7 +2141,7 @@ class EmacsView : public BView
     if (mods & B_COMMAND_KEY)
       rq.modifiers |= HAIKU_MODIFIER_ALT;
 
-    if (mods & B_OPTION_KEY)
+    if (mods & B_LEFT_OPTION_KEY)
       rq.modifiers |= HAIKU_MODIFIER_SUPER;
 
     rq.time = when;
-- 
2.45.2

From a8e79f9bb89e7863bd968b630cf4af45664190ed Mon Sep 17 00:00:00 2001
From: Christof Meerwald <cmeerw@cmeerw.org>
Date: Tue, 13 Jan 2026 19:09:12 +0000
Subject: [PATCH] BObjectList API change


diff --git a/src/haiku_support.cc b/src/haiku_support.cc
index 64abb2e..3234d69 100644
--- a/src/haiku_support.cc
+++ b/src/haiku_support.cc
@@ -2903,8 +2903,13 @@ class EmacsFontSelectionDialog : public BWindow
   BScrollView font_family_scroller;
   BScrollView font_style_scroller;
   TripleLayoutView style_view;
+#if B_HAIKU_VERSION > B_HAIKU_VERSION_1_BETA_5
+  BObjectList<BStringItem, true> all_families;
+  BObjectList<BStringItem, true> all_styles;
+#else
   BObjectList<BStringItem> all_families;
   BObjectList<BStringItem> all_styles;
+#endif
   BButton cancel_button, ok_button;
   BTextControl size_entry;
   port_id comm_port;
@@ -3167,8 +3172,13 @@ class EmacsFontSelectionDialog : public BWindow
 			   B_SUPPORTS_LAYOUT, false, true),
       style_view (&font_style_scroller, &antialias_checkbox,
 		  &preview_checkbox),
+#if B_HAIKU_VERSION > B_HAIKU_VERSION_1_BETA_5
+      all_families (20),
+      all_styles (20),
+#else
       all_families (20, true),
       all_styles (20, true),
+#endif
       cancel_button ("Cancel", "Cancel",
 		     new BMessage (B_CANCEL)),
       ok_button ("OK", "OK", new BMessage (B_OK)),
-- 
2.52.0

From dfcf67558587115db3c643795e838ad183c2334b Mon Sep 17 00:00:00 2001
From: Christof Meerwald <cmeerw@cmeerw.org>
Date: Wed, 14 Jan 2026 16:29:04 +0000
Subject: [PATCH] Also need to handle unmapped key events


diff --git a/src/haiku_support.cc b/src/haiku_support.cc
index 3234d69..17534f3 100644
--- a/src/haiku_support.cc
+++ b/src/haiku_support.cc
@@ -1080,7 +1080,8 @@ class EmacsWindow : public BWindow
   void
   DispatchMessage (BMessage *msg, BHandler *handler)
   {
-    if (msg->what == B_KEY_DOWN || msg->what == B_KEY_UP)
+    if (msg->what == B_UNMAPPED_KEY_DOWN || msg->what == B_UNMAPPED_KEY_UP ||
+	msg->what == B_KEY_DOWN || msg->what == B_KEY_UP)
       {
 	struct haiku_key_event rq;
 
@@ -1096,7 +1097,11 @@ class EmacsWindow : public BWindow
 
 	int32 raw, key;
 	int ret;
-	msg->FindInt32 ("raw_char", &raw);
+	if (msg->FindInt32 ("raw_char", &raw) != B_OK)
+	{
+          BWindow::DispatchMessage (msg, handler);
+          return;
+	}
 	msg->FindInt32 ("key", &key);
 	msg->FindInt64 ("when", &rq.time);
 
@@ -1189,7 +1194,9 @@ class EmacsWindow : public BWindow
 	      }
 	  }
 
-	haiku_write (msg->what == B_KEY_DOWN ? KEY_DOWN : KEY_UP, &rq);
+	bool is_key_down = msg->what == B_KEY_DOWN ||
+			   msg->what == B_UNMAPPED_KEY_DOWN;
+	haiku_write (is_key_down ? KEY_DOWN : KEY_UP, &rq);
       }
     else if (msg->what == B_MOUSE_WHEEL_CHANGED)
       {
-- 
2.52.0

