SUMMARY="A highly configurable text editor"
DESCRIPTION="Vim is a highly configurable text editor built to enable \
efficient text editing. It is an improved version of the vi editor \
distributed with most UNIX systems.

Vim is often called a \"programmer's editor,\" and so useful for programming \
that many consider it an entire IDE. It's not just for programmers, though. \
Vim is perfect for all kinds of text editing, from composing email to editing \
configuration files.
Despite this, Vim can be configured to work in a very simple (Notepad-like) \
way, called evim or Easy Vim."
HOMEPAGE="https://www.vim.org/"
COPYRIGHT="1991-2020 Bram Moleenar et al."
LICENSE="Vim"
REVISION="1"
SOURCE_URI="https://github.com/vim/vim/archive/v$portVersion.tar.gz"
CHECKSUM_SHA256="f01c2a367a1c296e9ea25598bf3c8d5bd4203ecf4cbb8c0eee41c2a480ea449f"
SOURCE_FILENAME="vim-$portVersion.tar.gz"

ARCHITECTURES="x86_gcc2 x86_64"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	vim = $portVersion
	cmd:ex$secondaryArchSuffix = $portVersion
	cmd:gview$secondaryArchSuffix = $portVersion
	cmd:gvim$secondaryArchSuffix = $portVersion
	cmd:gvimdiff$secondaryArchSuffix = $portVersion
	cmd:rgview$secondaryArchSuffix = $portVersion
	cmd:rgvim$secondaryArchSuffix = $portVersion
	cmd:rview$secondaryArchSuffix = $portVersion
	cmd:rvim$secondaryArchSuffix = $portVersion
	cmd:vi$secondaryArchSuffix = $portVersion
	cmd:view$secondaryArchSuffix = $portVersion
	cmd:vim$secondaryArchSuffix = $portVersion compat >= 8.2
	cmd:vimdiff$secondaryArchSuffix = $portVersion
	cmd:vimtutor$secondaryArchSuffix = $portVersion
	cmd:xxd$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libiconv$secondaryArchSuffix
	lib:libintl$secondaryArchSuffix
	lib:libncurses$secondaryArchSuffix >= 6
	"

if [ $effectiveTargetArchitecture != "x86_gcc2" ] ; then
	REQUIRES+="
		lib:libssp$secondaryArchSuffix
	"
fi

BUILD_REQUIRES="
	haiku_${secondaryArchSuffix}_devel
	devel:libiconv$secondaryArchSuffix
	devel:libintl$secondaryArchSuffix
#	devel:liblua$secondaryArchSuffix
	devel:libncurses$secondaryArchSuffix >= 6
	devel:libtclstub8.5
	"

if [ $effectiveTargetArchitecture != "x86_gcc2" ] ; then
	BUILD_REQUIRES+="
		devel:libruby$secondaryArchSuffix
	"
fi

BUILD_PREREQUIRES="
	cmd:autoconf
	cmd:find
	cmd:gcc$secondaryArchSuffix
	cmd:gettext
	cmd:grep
	cmd:make
#	cmd:perl
	cmd:pkg_config$secondaryArchSuffix
	cmd:python3
	cmd:ruby
	cmd:sed
	"

BUILD()
{

# Global ----------------------------------------

	cd src
	autoconf

	export CFLAGS="\
		`pkg-config --cflags python3` \
		-fPIC"

# CLI -------------------------------------------

	# Clean objects from possible previous run to avoid mixup of GUI/CLI objects
	rm objects/*.o || true

	runConfigure ./configure \
		--disable-gui \
		--with-features=huge \
		--enable-cscope \
		--enable-pythoninterp=dynamic \
		--enable-rubyinterp=dynamic \
		--enable-tclinterp=dynamic \
		--with-compiledby=Haikuports \
		--disable-terminal # FIXME: 'exit' command does not work
#		--enable-luainterp=dynamic
#		--enable-python3interp=dynamic currently broken
#		--enable-perlinterp=dynamic not dynamic yet


	make $jobArgs
	cp vim vim.con # preserve gui-less executable
	rm objects/*.o

# GUI -------------------------------------------

	MAJOR="`echo "$portVersion" | cut -d. -f1`"
	MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	MINOR="`echo "$portVersion" | cut -d. -f3`"
		sed -i "s|@MAJOR@|$MAJOR|" os_haiku.rdef
		sed -i "s|@MIDDLE@|$MIDDLE|" os_haiku.rdef
		sed -i "s|@MINOR@|$MINOR|" os_haiku.rdef

	runConfigure ./configure \
		--with-features=huge \
		--enable-cscope \
		--enable-pythoninterp=dynamic \
		--enable-rubyinterp=dynamic \
		--enable-tclinterp==dynamic \
		--with-compiledby=Haikuports \
		--disable-terminal # FIXME: Builds, but does not display anything
#		--enable-luainterp=dynamic
#		--enable-python3interp=dynamic currently broken
#		--enable-perlinterp=dynamic not dynamic yet

	make $jobArgs
}

INSTALL()
{
	make install
	ln -s vim $binDir/vi
	addAppDeskbarSymlink $binDir/gvim Vim
}

TEST()
{
	cd src
	make check
}
