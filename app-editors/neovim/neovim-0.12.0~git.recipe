SUMMARY="Editor based on Vim"
DESCRIPTION="Fork of Vim aiming to improve user experience, plugins, and GUIs"
HOMEPAGE="https://neovim.io"
COPYRIGHT="Neovim contributors"
LICENSE="Apache v2
Vim"
REVISION="1"
srcGitRev="10c11c4644e30f06b5d3029b72b2a945b654ca22"

SOURCE_URI="https://github.com/neovim/neovim/archive/$srcGitRev.tar.gz"
CHECKSUM_SHA256="0c76533552a99d591381e226d90c60a9005fcf145a2e0429e234c9caafd78ca1"
SOURCE_DIR="neovim-$srcGitRev"

SOURCE_URI_2="https://github.com/lunarmodules/lua-compat-5.3/archive/v0.13.tar.gz#noarchive"
CHECKSUM_SHA256_2="f5dc30e7b1fda856ee4d392be457642c1f0c259264a9b9bfbcb680302ce88fc2"

SOURCE_URI_3="https://github.com/luvit/luv/archive/1.51.0-1.tar.gz#noarchive"
CHECKSUM_SHA256_3="d4a11178ae8e16ba5886799ea91905dd9b0b479c75aebd67866d37373e41526f"

srcGitRev4="d495ee6f79e7962a53ad79670cb92488abe0b9b4"
SOURCE_URI_4="https://github.com/neovim/deps/raw/$srcGitRev4/opt/lpeg-1.1.0.tar.gz#noarchive"
CHECKSUM_SHA256_4="4b155d67d2246c1ffa7ad7bc466c1ea899bbc40fef0257cc9c03cecbaed4352a"

SOURCE_URI_5="https://github.com/tree-sitter/tree-sitter-c/archive/v0.24.1.tar.gz#noarchive"
CHECKSUM_SHA256_5="25dd4bb3dec770769a407e0fc803f424ce02c494a56ce95fedc525316dcf9b48"

SOURCE_URI_6="https://github.com/tree-sitter-grammars/tree-sitter-lua/archive/v0.4.0.tar.gz#noarchive"
CHECKSUM_SHA256_6="b0977aced4a63bb75f26725787e047b8f5f4a092712c840ea7070765d4049559"

SOURCE_URI_7="https://github.com/tree-sitter-grammars/tree-sitter-vim/archive/v0.7.0.tar.gz#noarchive"
CHECKSUM_SHA256_7="44eabc31127c4feacda19f2a05a5788272128ff561ce01093a8b7a53aadcc7b2"

SOURCE_URI_8="https://github.com/neovim/tree-sitter-vimdoc/archive/v4.0.0.tar.gz#noarchive"
CHECKSUM_SHA256_8="8096794c0f090b2d74b7bff94548ac1be3285b929ec74f839bd9b3ff4f4c6a0b"

# XXX: neovim pulls v0.7.0 instead, however this is breaks haikuporter, so we pull the raw commit instead
srcGitRev9="60e253d3c9d6b1131a0f75c85e4bdcc9a48d5b42"
SOURCE_URI_9="https://github.com/tree-sitter-grammars/tree-sitter-query/archive/$srcGitRev9.tar.gz#noarchive"
CHECKSUM_SHA256_9="b43e668d7e45a162361f5ffc584c9e01bbc07b6d1210334dbc37ce9788733320"

SOURCE_URI_10="https://github.com/tree-sitter-grammars/tree-sitter-markdown/archive/v0.5.1.tar.gz#noarchive"
CHECKSUM_SHA256_10="acaffe5a54b4890f1a082ad6b309b600b792e93fc6ee2903d022257d5b15e216"

SOURCE_URI_11="https://github.com/tree-sitter/tree-sitter/archive/v0.25.10.tar.gz#noarchive"
CHECKSUM_SHA256_11="ad5040537537012b16ef6e1210a572b927c7cdc2b99d1ee88d44a7dcdc3ff44c"

SOURCE_URI_12="https://github.com/juliastrings/utf8proc/archive/v2.11.1.tar.gz#noarchive"
CHECKSUM_SHA256_12="dc146fd279eacbbf399d3f70932ce66f516aac2d13f8ec2d26a30f8ed70aa5b4"

ARCHITECTURES="ALL !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

commandBinDir=$binDir
commandSuffix=$secondaryArchSuffix
if [ "$targetArchitecture" = x86_gcc2 ]; then
	commandSuffix=
	commandBinDir=$prefix/bin
fi

PROVIDES="
	neovim$secondaryArchSuffix = $portVersion
	cmd:nvim = $portVersion
	"

REQUIRES="
	haiku$secondaryArchSuffix
	lib:libiconv$secondaryArchSuffix
	lib:libintl$secondaryArchSuffix
	lib:libluajit_5.1$secondaryArchSuffix
	lib:libunibilium$secondaryArchSuffix
	lib:libuv$secondaryArchSuffix
	luajit$secondaryArchSuffix
	"
BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libiconv${secondaryArchSuffix}
	devel:libintl$secondaryArchSuffix
	devel:libluajit_5.1$secondaryArchSuffix
	devel:libunibilium$secondaryArchSuffix
	devel:libuv$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:make
	cmd:sed
	"

PATCHES="
	neovim-0.12.0~git.patchset
	"

BUILD()
{
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$LUACOMPAT|$(find $sourceDir2/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$LUV|$(find $sourceDir3/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$LPEG|$(find $sourceDir4/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$TREESITTERC|$(find $sourceDir5/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$TREESITTERLUA|$(find $sourceDir6/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$TREESITTERVIM|$(find $sourceDir7/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$TREESITTERVIMDOC|$(find $sourceDir8/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$TREESITTERQUERY|$(find $sourceDir9/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$TREESITTERMD|$(find $sourceDir10/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$TREESITTER|$(find $sourceDir11/*)|"
	sed -i ./cmake.deps/deps.txt \
		-e "s|\$UTF8PROC|$(find $sourceDir12/*)|"

	cmake -DCMAKE_BUILD_TYPE=Release \
		$cmakeDirArgs \
		-DCMAKE_INSTALL_BINDIR=$commandBinDir \
		-DUSE_BUNDLED_LIBUV=OFF \
		-DUSE_BUNDLED_UNIBILIUM=OFF \
		-DUSE_BUNDLED_LUAJIT=OFF \
		-B .deps ./cmake.deps

	make -C .deps $jobArgs

	cmake -B build -S . \
		-DCMAKE_BUILD_TYPE=Release \
		$cmakeDirArgs \
		-DCMAKE_INSTALL_BINDIR=$commandBinDir

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install $jobArgs
}
