SUMMARY="A todo manager"
DESCRIPTION="KomoDo is a todo manager that uses todo.txt specification. It parses any compliant todo.txt files \
and turns them into easy to use list of tasks.

KomoDo has built-in help for the todo.txt specification, so it's suitable for newcomers too!

Features:

* Open and create new todo.txt files
* Add, delete and edit tasks
* Filter and search tasks"
HOMEPAGE="https://apps.kde.org/komodo/"
COPYRIGHT="2010-2025 KDE Organisation
	2025 Akseli Lahtinen"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="https://download.kde.org/stable/komodo/$portVersion/komodo-$portVersion.tar.xz"
CHECKSUM_SHA256="0831ac4a43ea292653105541e1db2d98346e94f3eb2aae5a365375de798377bc"
ADDITIONAL_FILES="komodo.rdef.in"

ARCHITECTURES="ALL !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	komodo$secondaryArchSuffix = $portVersion
	app:Komodo = $portVersion
	devel:libkomodo_modelsplugin$secondaryArchSuffix = $portVersion
	devel:libkomodo_uiplugin$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libGL$secondaryArchSuffix
	lib:libKirigamiAddonsStatefulApp$secondaryArchSuffix
	# KF6
	qqc2_desktop_style6$secondaryArchSuffix
	lib:libKF6ColorScheme$secondaryArchSuffix
	lib:libKF6ConfigCore$secondaryArchSuffix
	lib:libKF6CoreAddons$secondaryArchSuffix
	lib:libKF6GuiAddons$secondaryArchSuffix
	lib:libKF6I18n$secondaryArchSuffix
	lib:libKF6WindowSystem$secondaryArchSuffix
	lib:libKirigami$secondaryArchSuffix
	# Qt6
	lib:libQt6Core$secondaryArchSuffix
	lib:libQt6Gui$secondaryArchSuffix
	lib:libQt6Network$secondaryArchSuffix
	lib:libQt6OpenGL$secondaryArchSuffix
	lib:libQt6Qml$secondaryArchSuffix
	lib:libQt6Quick$secondaryArchSuffix
	lib:libQt6Widgets$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libKirigamiAddonsStatefulApp$secondaryArchSuffix
	# KF6
	extra_cmake_modules$secondaryArchSuffix
	qqc2_desktop_style6${secondaryArchSuffix}_devel
	devel:libKF6ColorScheme$secondaryArchSuffix
	devel:libKF6ConfigCore$secondaryArchSuffix
	devel:libKF6CoreAddons$secondaryArchSuffix
	devel:libKF6GuiAddons$secondaryArchSuffix
	devel:libKF6I18n$secondaryArchSuffix
	devel:libKF6ItemModels$secondaryArchSuffix
	devel:libKF6WindowSystem$secondaryArchSuffix
	devel:libKirigami$secondaryArchSuffix
	# Qt6
	devel:libQt6Core$secondaryArchSuffix
	devel:libQt6Qml$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:g++$secondaryArchSuffix
	cmd:make
	cmd:msgfmt$secondaryArchSuffix
	cmd:msgmerge$secondaryArchSuffix
	cmd:pkg_config$secondaryArchSuffix
	"

TEST_REQUIRES="
	haikuplugins$secondaryArchSuffix
	"

BUILD()
{
	cmake -B build -S . -DCMAKE_BUILD_TYPE=Release \
		$cmakeDirArgs \
		-DCMAKE_INSTALL_BINDIR=$appsDir \
		-DCMAKE_INSTALL_DATAROOTDIR=data \
		-DKDE_INSTALL_PLUGINDIR=$addOnsDir/Qt6 \
		-DKDE_INSTALL_QMLDIR=$dataDir/Qt6/qml \
		-DKDE_INSTALL_QTPLUGINDIR=$addOnsDir/Qt6 \
		-DKDE_INSTALL_QTQCHDIR=$documentationDir/packages/qt6_base \
		-DECM_DIR=/system/data/cmake/Modules/ECM/cmake \
		-DCMAKE_SKIP_RPATH=YES \
		-DBUILD_TESTING=ON \
		-Wno-dev

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	# cleanup
	rm -rf $dataDir/{applications,metainfo}

	mv $appsDir/komodo $appsDir/Komodo

	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="0"
	local APP_NAME="Komodo"
	local LONG_INFO="$SUMMARY"
	local APP_SIGNATURE="application/x-vnd.kde-komodo"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		-e "s|@APP_NAME@|$APP_NAME|" \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		$portDir/additional-files/komodo.rdef.in > komodo.rdef

	addResourcesToBinaries komodo.rdef $appsDir/Komodo

	addAppDeskbarSymlink $appsDir/Komodo

	prepareInstalledDevelLibs \
		libkomodo_modelsplugin \
		libkomodo_uiplugin
}

TEST()
{
	ctest --test-dir build --output-on-failure
}
