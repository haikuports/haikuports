SUMMARY="An open source antivirus engine"
DESCRIPTION="ClamAV is an open source antivirus engine for detecting  \
trojans, viruses, malware & other malicious threats."
HOMEPAGE="https://www.clamav.net"
COPYRIGHT="2001-2007 Tomasz Kojm
	2007-2023 Cisco Systems"
PACKAGER="Luca D'Amico <damico.luca91@live.it>"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="https://github.com/Cisco-Talos/clamav/archive/refs/tags/clamav-$portVersion.tar.gz"
CHECKSUM_SHA256="efe7e234fe29a96bf4da23336e38ea2989ed0be162342993e99a11901524f43f"
SOURCE_DIR="clamav-clamav-$portVersion"
PATCHES="haiku-$portVersion.patch"
ADDITIONAL_FILES="
	clamd.conf
	freshclam.conf
	"

ARCHITECTURES="all ?x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	clamav$secondaryArchSuffix = $portVersion
	cmd:clambc$secondaryArchSuffix = $portVersion
	cmd:clamconf$secondaryArchSuffix = $portVersion
	cmd:clamd$secondaryArchSuffix = $portVersion
	cmd:clamdscan$secondaryArchSuffix = $portVersion
	cmd:clamdtop$secondaryArchSuffix = $portVersion
	cmd:clamscan$secondaryArchSuffix = $portVersion
	cmd:clamsubmit$secondaryArchSuffix = $portVersion
	cmd:freshclam$secondaryArchSuffix = $portVersion
	cmd:sigtool$secondaryArchSuffix = $portVersion
	lib:libclamav$secondaryArchSuffix = $portVersion
	lib:libclammspack$secondaryArchSuffix = $portVersion
	lib:libclamunrar$secondaryArchSuffix = $portVersion
	lib:libclamunrar_iface$secondaryArchSuffix = $portVersion
	lib:libfreshclam$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	json_c$secondaryArchSuffix
	lib:libbz2$secondaryArchSuffix
	lib:libcrypto$secondaryArchSuffix
	lib:libcurl$secondaryArchSuffix
	lib:libiconv$secondaryArchSuffix
	lib:libncurses$secondaryArchSuffix
	lib:libpcre2_8$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libxml2$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	check${secondaryArchSuffix}_devel
	devel:libbz2$secondaryArchSuffix
	devel:libcrypto$secondaryArchSuffix
	devel:libcurl$secondaryArchSuffix
	devel:libiconv$secondaryArchSuffix
	devel:libncurses$secondaryArchSuffix
	devel:libpcre2_8$secondaryArchSuffix
	devel:libpthread_stubs$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libxml2$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	json_c${secondaryArchSuffix}_devel
	python3.12$secondaryArchSuffix
	rust_bin$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:make
	"

GLOBAL_WRITABLE_FILES="
	settings/clamav/clamd.conf keep-old
	settings/clamav/freshclam.conf keep-old
	settings/clamav/db directory keep-old
	"

BUILD()
{
	cmake -Bbuild -S. -DENABLE_MILTER=OFF \
	-DAPP_CONFIG_DIRECTORY=$settingsDir/clamav \
	-DDATABASE_DIRECTORY=$settingsDir/clamav/db \
	-DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_BUILD_TYPE=Release .

	make -C build
}

INSTALL()
{
	mkdir -p $binDir $libDir $manDir/man1 $manDir/man5 $manDir/man8
	mkdir -p $settingsDir/clamav/
	mkdir -p $settingsDir/clamav/db

	# install libs
	cp build/libclamav/libclamav.so* $libDir
	cp build/libclammspack/libclammspack.so* $libDir
	cp build/libclamunrar/libclamunrar.so* $libDir
	cp build/libclamunrar_iface/libclamunrar_iface.so* $libDir
	cp build/libfreshclam/libfreshclam.so* $libDir

	# install bins
	cp build/clambc/clambc $binDir
	cp build/clamconf/clamconf $binDir
	cp build/clamd/clamd $binDir
	cp build/clamdscan/clamdscan $binDir
	cp build/clamdtop/clamdtop $binDir
	cp build/clamscan/clamscan $binDir
	cp build/clamsubmit/clamsubmit $binDir
	cp build/freshclam/freshclam $binDir
	cp build/sigtool/sigtool $binDir

	# install mans
	cp build/docs/man/*.1 $manDir/man1
	cp build/docs/man/*.5 $manDir/man5
	cp build/docs/man/*.8 $manDir/man8

	# install conf files
	cp $portDir/additional-files/clamd.conf $settingsDir/clamav/
	cp $portDir/additional-files/freshclam.conf $settingsDir/clamav/

}
