SUMMARY="A large scale non-linear optimization library"
DESCRIPTION="Ceres Solver 1 is an open source C++ library for modeling and \
solving large, complicated optimization problems. It can be used to solve \
Non-linear Least Squares problems with bounds constraints and general \
unconstrained optimization problems. It is a mature, feature rich, and \
performant library that has been used in production at Google since 2010."
HOMEPAGE="http://ceres-solver.org/"
COPYRIGHT="2015 Google Inc."
LICENSE="BSD (3-clause)
	Apache v2"
REVISION="1"
SOURCE_URI="https://github.com/ceres-solver/ceres-solver/archive/$portVersion.tar.gz"
CHECKSUM_SHA256="12efacfadbfdc1bbfa203c236e96f4d3c210bed96994288b3ff0c8e7c6f350d4"
SOURCE_FILENAME="ceres-solver-$portVersion-tar.gz"
SOURCE_DIR="ceres-solver-$portVersion"

ARCHITECTURES="ALL !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

libVersion="$portVersion"
libVersionCompat="$libVersion compat >= ${libVersion%%.*}"

tbbVersion="12.17"
tbbmallocVersion="2.17"

PROVIDES="
	ceres_solver$secondaryArchSuffix = $portVersion
	lib:libceres$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libamd$secondaryArchSuffix
	lib:libcamd$secondaryArchSuffix
	lib:libccolamd$secondaryArchSuffix
	lib:libcholmod$secondaryArchSuffix
	lib:libcolamd$secondaryArchSuffix
	lib:libgflags$secondaryArchSuffix
	lib:libglog$secondaryArchSuffix
	lib:libopenblas$secondaryArchSuffix
	lib:libspqr$secondaryArchSuffix
	lib:libsuitesparseconfig$secondaryArchSuffix
	lib:libtbb$secondaryArchSuffix
	"

PROVIDES_devel="
	ceres_solver${secondaryArchSuffix}_devel = $portVersion
	devel:libceres$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES_devel="
	ceres_solver$secondaryArchSuffix == $portVersion base
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:eigen$secondaryArchSuffix
	devel:libamd$secondaryArchSuffix
	devel:libcamd$secondaryArchSuffix
	devel:libccolamd$secondaryArchSuffix
	devel:libcholmod$secondaryArchSuffix
	devel:libcolamd$secondaryArchSuffix
	devel:libgflags$secondaryArchSuffix
	devel:libglog$secondaryArchSuffix
	devel:libopenblas$secondaryArchSuffix
	devel:libspqr$secondaryArchSuffix
	devel:libsuitesparseconfig$secondaryArchSuffix
	devel:libtbb$secondaryArchSuffix == $tbbVersion
	devel:libtbbmalloc$secondaryArchSuffix == $tbbmallocVersion
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:g++$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

defineDebugInfoPackage ceres_solver$secondaryArchSuffix \
	$libDir/libceres.so.$libVersion

BUILD()
{
	mkdir -p build && cd "$_"

	cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo \
		$cmakeDirArgs \
		-DBUILD_SHARED_LIBS=ON \
		-DEigen3_DIR=`finddir B_SYSTEM_DATA_DIRECTORY`/eigen3/cmake \
		-DBUILD_EXAMPLES=OFF \
		-DBUILD_TESTING=OFF

	make # parallel builds needs way too much ram
}

INSTALL()
{
	cd build

	make install $jobArgs

	prepareInstalledDevelLib libceres

	fixPkgconfig

	packageEntries devel \
		$developDir \
		$libDir/cmake
}

TEST()
{
	# about 40 crashes (if i counted right)
	# summary is: 100% tests passed, 0 tests failed out of 175
	ctest --test-dir build --output-on-failure
}
