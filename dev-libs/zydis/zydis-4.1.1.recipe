SUMMARY="Disassembler Library for x86 and x86-64"
DESCRIPTION="Zydis is a fast and lightweight x86/x86-64 disassembler and code \
generation library."
HOMEPAGE="https://zydis.re/"
COPYRIGHT="2014-2024 Florian Bernd
	2014-2024 Joel HÃ¶ner"
LICENSE="MIT"
REVISION="1"
SOURCE_URI="https://github.com/zyantific/zydis/archive/v$portVersion.tar.gz"
CHECKSUM_SHA256="45c6d4d499a1cc80780f7834747c637509777c01dca1e98c5e7c0bfaccdb1514"
SOURCE_FILENAME="zydis-$portVersion.tar.gz"
zycoreVersion="1.5.2"
SOURCE_URI_2="https://github.com/zyantific/zycore-c/archive/v$zycoreVersion.tar.gz"
CHECKSUM_SHA256_2="943f91eb9ab2a8cc01ab9f8b785e769a273502071e0ee8011cdfcaad93947cec"
SOURCE_DIR_2="zycore-c-$zycoreVersion"
SOURCE_FILENAME_2="zycore-$zycoreVersion.tar.gz"
PATCHES="zydis-$portVersion.patchset"
PATCHES_2="zycore-$zycoreVersion.patchset"

ARCHITECTURES="ALL !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	zydis$secondaryArchSuffix = $portVersion
	cmd:zydisdisasm
	cmd:zydisinfo
	"
REQUIRES="
	haiku$secondaryArchSuffix
	"

PROVIDES_devel="
	zydis${secondaryArchSuffix}_devel = $portVersion
	devel:libzycore$secondaryArchSuffix
	devel:libzydis$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:make
	cmd:python3
	"

defineDebugInfoPackage zydis$secondaryArchSuffix \
	$prefix/bin/ZydisDisasm \
	$prefix/bin/ZydisInfo

BUILD()
{
	cmake -S. -Bbuild $cmakeDirArgs \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DZYAN_ZYCORE_PATH:PATH=$sourceDir2 \
		-DCMAKE_INSTALL_BINDIR=$prefix/bin
	make -C build $jobArgs
}

INSTALL()
{
	make -C build install
	make -C build/zycore install

	sed "s|{_IMPORT_PREFIX}/$relativeLibDir|{_IMPORT_PREFIX}/$relativeDevelopLibDir|g" \
		-i $libDir/cmake/zycore/zycore-targets-*.cmake $libDir/cmake/zydis/zydis-targets-*.cmake

	prepareInstalledDevelLibs libZycore libZydis

	packageEntries devel \
		"$developDir" \
		"$libDir"/cmake
}

TEST()
{
	make check
}
