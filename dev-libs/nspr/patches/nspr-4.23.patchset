From cd87dcbf617c39626938eb4e58ef69a42989556f Mon Sep 17 00:00:00 2001
From: Ken Mays <kmays2000@gmail.com>
Date: Sat, 09 Nov 2019 00:09:11 +0200
Subject: Migrated NSPR 4.19 patchset to NSPR 4.23

* Additional Haiku patching and migration to NSPR 4.23 by Ken Mays 
* Old patchset wouldn't apply anymore.
* Platform code by korli.
* pr/include/obsolete/prototypes.h by pulkomandy.
* Fix build of libpurple.
* pr/include/prtypes.h by Kacper Kasper.
  Fix build of NSS. NSS uses XP_BEOS and defs for BeOS fail on GCC7.

diff --git a/configure.in.orig b/configure.in
index 04bb64d..b4255f1 100644
--- a/configure.in.orig
+++ b/configure.in
@@ -1234,6 +1234,30 @@ case "$target" in
     PR_MD_CSRCS=aix.c
     RESOLVE_LINK_SYMBOLS=1
     ;;
+
+*-haiku*)
+    AC_DEFINE(XP_UNIX)
+    AC_DEFINE(XP_HAIKU)
+    AC_DEFINE(HAIKU)
+    AC_DEFINE(Haiku)
+    AC_DEFINE(HAVE_SOCKLEN_T)
+    AC_DEFINE(HAVE_FCNTL_FILE_LOCKING)
+    DSO_CFLAGS="-fPIC"
+    USE_PTHREADS=1
+    IMPL_STRATEGY=_PTH
+    MDCPUCFG_H=_linux.cfg
+    if test -n "$USE_64"; then
+        PR_MD_ASFILES=os_Linux_x86_64.s
+    else
+        PR_MD_ASFILES=os_Linux_x86.s
+    fi
+    PR_MD_CSRCS=linux.c
+    MKSHLIB='$(CC) $(DSO_LDOPTS) -o $@'
+    DSO_CFLAGS=-fPIC
+    DSO_LDOPTS='-shared -Wl,-soname -Wl,$(notdir $@)'
+    _OPTIMIZE_FLAGS=-O2
+    AC_CHECK_LIB(network, gethostbyaddr, [OS_LIBS="$OS_LIBS -lnetwork"])
+    ;;
         
 *-bsdi*)
     AC_DEFINE(XP_UNIX)
@@ -2369,7 +2393,7 @@ fi
 esac
 
 case "$target_os" in
-darwin*)
+darwin*|haiku*)
     _HAVE_PTHREADS=1
     ;;
 *)
diff --git a/pr/include/md/_pth.h.orig b/pr/include/md/_pth.h
index 37d26e7..be75484 100644
--- a/pr/include/md/_pth.h.orig
+++ b/pr/include/md/_pth.h
@@ -14,6 +14,7 @@
 #define _PR_MD_DISABLE_CLOCK_INTERRUPTS()
 #define _PR_MD_ENABLE_CLOCK_INTERRUPTS()
 
+
 #if defined(BSDI)
 /*
  * Mutex and condition attributes are not supported.  The attr
@@ -89,7 +90,7 @@
     || defined(HPUX) || defined(FREEBSD) \
     || defined(NETBSD) || defined(OPENBSD) || defined(BSDI) \
     || defined(NTO) || defined(DARWIN) \
-    || defined(UNIXWARE) || defined(RISCOS)
+    || defined(UNIXWARE) || defined(RISCOS) || defined(HAIKU)
 #define _PT_PTHREAD_INVALIDATE_THR_HANDLE(t)  (t) = 0
 #define _PT_PTHREAD_THR_HANDLE_IS_INVALID(t)  (t) == 0
 #define _PT_PTHREAD_COPY_THR_HANDLE(st, dt)   (dt) = (st)
@@ -116,7 +117,7 @@
     || defined(LINUX) || defined(__GNU__)|| defined(__GLIBC__) \
     || defined(FREEBSD) || defined(NETBSD) || defined(OPENBSD) \
     || defined(BSDI) || defined(UNIXWARE) \
-    || defined(DARWIN)
+    || defined(DARWIN) || defined(HAIKU)
 #define PT_NO_SIGTIMEDWAIT
 #endif
 
@@ -133,7 +134,7 @@
 #define PT_PRIO_MIN            sched_get_priority_min(SCHED_OTHER)
 #define PT_PRIO_MAX            sched_get_priority_max(SCHED_OTHER)
 #elif defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) \
-    || defined(FREEBSD)
+    || defined(FREEBSD) || defined(HAIKU)
 #define PT_PRIO_MIN            sched_get_priority_min(SCHED_OTHER)
 #define PT_PRIO_MAX            sched_get_priority_max(SCHED_OTHER)
 #elif defined(NTO)
@@ -177,7 +178,7 @@ extern int (*_PT_aix_yield_fcn)();
     || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) \
     || defined(FREEBSD) || defined(NETBSD) || defined(OPENBSD) \
     || defined(BSDI) || defined(NTO) || defined(DARWIN) \
-    || defined(UNIXWARE) || defined(RISCOS)
+    || defined(UNIXWARE) || defined(RISCOS) || defined(HAIKU)
 #define _PT_PTHREAD_YIELD()             sched_yield()
 #else
 #error "Need to define _PT_PTHREAD_YIELD for this platform"
diff --git a/pr/include/md/_unixos.h.orig b/pr/include/md/_unixos.h
index 7d444cd..9534c61 100644
--- a/pr/include/md/_unixos.h.orig
+++ b/pr/include/md/_unixos.h
@@ -15,7 +15,7 @@
  * not be redefined.
  */
 #if !defined(LINUX) && !defined(__GNU__) && !defined(__GLIBC__) \
-    && !defined(DARWIN)
+    && !defined(DARWIN) && !defined(HAIKU)
 #ifndef FD_SETSIZE
 #define FD_SETSIZE  4096
 #endif
@@ -46,7 +46,7 @@
  */
 #include <sys/time.h>
 #include <sys/types.h>
-#if defined(AIX)
+#if defined(AIX) || defined(HAIKU)
 #include <sys/select.h>
 #endif
 
diff --git a/pr/include/md/prosdep.h.orig b/pr/include/md/prosdep.h
index 42eba3d..0cc49bc 100644
--- a/pr/include/md/prosdep.h.orig
+++ b/pr/include/md/prosdep.h
@@ -49,7 +49,7 @@ PR_BEGIN_EXTERN_C
 #elif defined(HPUX)
 #include "md/_hpux.h"
 
-#elif defined(LINUX) || defined(__GNU__) || defined(__GLIBC__)
+#elif defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) || defined(HAIKU)
 #include "md/_linux.h"
 
 #elif defined(DARWIN)
diff --git a/pr/src/pthreads/ptio.c.orig b/pr/src/pthreads/ptio.c
index 3ad2d80..9cdc4e5 100644
--- a/pr/src/pthreads/ptio.c.orig
+++ b/pr/src/pthreads/ptio.c
@@ -28,7 +28,7 @@
 #include <sys/uio.h>
 #include <sys/file.h>
 #include <sys/ioctl.h>
-#if defined(DARWIN)
+#if defined(DARWIN) || defined(HAIKU)
 #include <sys/utsname.h> /* for uname */
 #endif
 #if defined(SOLARIS) || defined(UNIXWARE)
@@ -183,7 +183,7 @@ static PRBool _pr_ipv6_v6only_on_by_default;
     || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) \
     || defined(FREEBSD) || defined(NETBSD) || defined(OPENBSD) \
     || defined(BSDI) || defined(NTO) || defined(DARWIN) \
-    || defined(UNIXWARE) || defined(RISCOS)
+    || defined(UNIXWARE) || defined(RISCOS) || defined(HAIKU)
 #define _PRSelectFdSetArg_t fd_set *
 #else
 #error "Cannot determine architecture"
@@ -3477,7 +3477,7 @@ static PRIOMethods _pr_socketpollfd_methods = {
     || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) \
     || defined(AIX) || defined(FREEBSD) || defined(NETBSD) \
     || defined(OPENBSD) || defined(BSDI) || defined(NTO) \
-    || defined(DARWIN) || defined(UNIXWARE) || defined(RISCOS)
+    || defined(DARWIN) || defined(UNIXWARE) || defined(RISCOS) || defined(HAIKU)
 #define _PR_FCNTL_FLAGS O_NONBLOCK
 #else
 #error "Can't determine architecture"
diff --git a/pr/src/pthreads/ptthread.c.orig b/pr/src/pthreads/ptthread.c
index 292c89e..4e117e0 100644
--- a/pr/src/pthreads/ptthread.c.orig
+++ b/pr/src/pthreads/ptthread.c
@@ -1414,7 +1414,7 @@ static void suspend_signal_handler(PRIntn sig)
     {
 #if !defined(FREEBSD) && !defined(NETBSD) && !defined(OPENBSD) \
     && !defined(BSDI) && !defined(UNIXWARE) \
-    && !defined(DARWIN) && !defined(RISCOS)
+    && !defined(DARWIN) && !defined(RISCOS) && !defined(HAIKU)
         PRIntn rv;
         sigwait(&sigwait_set, &rv);
 #endif
@@ -1682,7 +1682,7 @@ PR_IMPLEMENT(PRStatus) PR_SetCurrentThreadName(const char *name)
      * On OSX, pthread_setname_np is only available in 10.6 or later, so test
      * for it at runtime.  It also may not be available on all linux distros.
      */
-#if defined(DARWIN)
+/* #if defined(DARWIN) && !defined(HAIKU)
     int (*dynamic_pthread_setname_np)(const char*);
 #else
     int (*dynamic_pthread_setname_np)(pthread_t, const char*);
@@ -1693,7 +1693,7 @@ PR_IMPLEMENT(PRStatus) PR_SetCurrentThreadName(const char *name)
     if (!dynamic_pthread_setname_np) {
         return PR_SUCCESS;
     }
-
+*/
     /*
      * The 15-character name length limit is an experimentally determined
      * length of a null-terminated string that most linux distros and OS X
@@ -1704,21 +1704,21 @@ PR_IMPLEMENT(PRStatus) PR_SetCurrentThreadName(const char *name)
 #define SETNAME_FRAGMENT1_LENGTH (SETNAME_LENGTH_CONSTRAINT >> 1)
 #define SETNAME_FRAGMENT2_LENGTH \
     (SETNAME_LENGTH_CONSTRAINT - SETNAME_FRAGMENT1_LENGTH - 1)
-    char name_dup[SETNAME_LENGTH_CONSTRAINT + 1];
+/*    char name_dup[SETNAME_LENGTH_CONSTRAINT + 1];
     if (nameLen > SETNAME_LENGTH_CONSTRAINT) {
         memcpy(name_dup, name, SETNAME_FRAGMENT1_LENGTH);
-        name_dup[SETNAME_FRAGMENT1_LENGTH] = '~';
+        name_dup[SETNAME_FRAGMENT1_LENGTH] = '~'; */
         /* Note that this also copies the null terminator. */
-        memcpy(name_dup + SETNAME_FRAGMENT1_LENGTH + 1,
+/*        memcpy(name_dup + SETNAME_FRAGMENT1_LENGTH + 1,
                name + nameLen - SETNAME_FRAGMENT2_LENGTH,
                SETNAME_FRAGMENT2_LENGTH + 1);
         name = name_dup;
     }
-
+*/
 #if defined(DARWIN)
     result = dynamic_pthread_setname_np(name);
-#else
-    result = dynamic_pthread_setname_np(thread->id, name);
+/* #else
+    result = dynamic_pthread_setname_np(thread->id, name); */
 #endif
 #endif /* not BSD */
 
diff --git a/pr/tests/Makefile.in.orig b/pr/tests/Makefile.in
index 8a87ad0..7f385fc 100644
--- a/pr/tests/Makefile.in.orig
+++ b/pr/tests/Makefile.in
@@ -326,7 +326,7 @@ LIBPTHREAD = -lpthread
 ifeq ($(OS_ARCH),AIX)
 LIBPTHREAD = -lpthreads
 endif
-ifeq (,$(filter-out FreeBSD OpenBSD BSD_OS QNX Darwin OpenUNIX,$(OS_ARCH)))
+ifeq (,$(filter-out Haiku FreeBSD OpenBSD BSD_OS QNX Darwin OpenUNIX,$(OS_ARCH)))
 LIBPTHREAD =
 endif
 endif
@@ -404,6 +404,15 @@ $(OBJDIR)/prpoll: $(OBJDIR)/prpoll.o
 	$(PURE) $(CC) $(XCFLAGS) $< $(LDOPTS) $(LIBPLC) $(LIBNSPR) -lsocket $(EXTRA_LIBS) -o $@
 endif
 
+ifeq ($(OS_ARCH),Haiku)
+ifeq ($(USE_IPV6),1)
+$(OBJDIR)/gethost: $(OBJDIR)/gethost.o
+	$(PURE) $(CC) $(XCFLAGS) $< $(LDOPTS) $(LIBPLC) $(LIBNSPR) -lnetwork $(EXTRA_LIBS) -o $@
+endif
+$(OBJDIR)/prpoll: $(OBJDIR)/prpoll.o
+	$(PURE) $(CC) $(XCFLAGS) $< $(LDOPTS) $(LIBPLC) $(LIBNSPR) -lnetwork $(EXTRA_LIBS) -o $@
+endif
+
 ifeq ($(USE_PTHREADS), 1)
 $(OBJDIR)/attach: $(OBJDIR)/attach.o
 	$(PURE) $(CC) $(XCFLAGS) $< $(LDOPTS) $(LIBPLC) $(LIBNSPR) $(LIBPTHREAD) $(EXTRA_LIBS) -o $@
diff --git a/pr/src/misc/prnetdb.c.orig b/pr/src/misc/prnetdb.c
index 6ad0242..22a1bcc 100644
--- a/pr/src/misc/prnetdb.c.orig
+++ b/pr/src/misc/prnetdb.c
@@ -1198,7 +1198,7 @@ PR_IMPLEMENT(PRStatus) PR_GetHostByAddr(
  * any usable implementation.
  */
 
-#if defined(ANDROID)
+#if defined(ANDROID) || defined(HAIKU)
 /* Android's Bionic libc system includes prototypes for these in netdb.h,
  * but doesn't actually include implementations.  It uses the 5-arg form,
  * so these functions end up not matching the prototype.  So just rename
diff --git a/pr/include/md/_linux.h.orig b/pr/include/md/_linux.h
index 6b54d09..fd572a3 100644
--- a/pr/include/md/_linux.h.orig
+++ b/pr/include/md/_linux.h
@@ -291,7 +291,7 @@ static inline PRInt32 _MD_ATOMIC_SET(PRInt32 *ptr, PRInt32 nv)
 #endif /* __arm__ */
 
 #define USE_SETJMP
-#if (defined(__GLIBC__) && __GLIBC__ >= 2) || defined(ANDROID)
+#if (defined(__GLIBC__) && __GLIBC__ >= 2) || defined(ANDROID) || defined(HAIKU)
 #define _PR_POLL_AVAILABLE
 #endif
 #undef _PR_USE_POLL
@@ -312,7 +312,7 @@ static inline PRInt32 _MD_ATOMIC_SET(PRInt32 *ptr, PRInt32 nv)
 #define _PR_HAVE_GETADDRINFO
 #define _PR_INET6_PROBE
 #endif
-#ifndef ANDROID
+#if !defined(ANDROID) && !defined(HAIKU)
 #define _PR_HAVE_SYSV_SEMAPHORES
 #define PR_HAVE_SYSV_NAMED_SHARED_MEMORY
 #endif
diff --git a/pr/src/md/unix/uxrng.c.orig b/pr/src/md/unix/uxrng.c
index 4798590..f244b67 100644
--- a/pr/src/md/unix/uxrng.c.orig
+++ b/pr/src/md/unix/uxrng.c
@@ -64,7 +64,7 @@ GetHighResClock(void *buf, size_t maxbytes)
 
 #elif (defined(LINUX) || defined(FREEBSD) || defined(__FreeBSD_kernel__) \
     || defined(NETBSD) || defined(__NetBSD_kernel__) || defined(OPENBSD) \
-    || defined(__GNU__))
+    || defined(__GNU__)) || defined(HAIKU)
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <fcntl.h>
diff --git a/pr/include/obsolete/protypes.h.orig b/pr/include/obsolete/protypes.h
index 5400afb..b5b943a 100644
--- a/pr/include/obsolete/protypes.h.orig
+++ b/pr/include/obsolete/protypes.h
@@ -27,6 +27,10 @@ typedef PRIntn intn;
  * defined by those standard headers.
  */
 
+#if defined(XP_HAIKU)
+#include <support/SupportDefs.h>
+#endif
+
 /*
  * SVR4 typedef of uint is commonly found on UNIX machines.
  *
@@ -48,7 +52,7 @@ typedef PRIntn intn;
  * uint
  */
 
-#if !defined(XP_OS2) && !defined(XP_UNIX) || defined(NTO)
+#if !defined(XP_OS2) && !defined(XP_UNIX) && !defined(XP_HAIKU) || defined(NTO)
 typedef PRUintn uint;
 #endif
 
@@ -56,13 +60,15 @@ typedef PRUintn uint;
  * uint64
  */
 
+#if !defined(XP_HAIKU)
 typedef PRUint64 uint64;
+#endif
 
 /*
  * uint32
  */
 
-#if !defined(_WIN32) && !defined(XP_OS2) && !defined(NTO)
+#if !defined(_WIN32) && !defined(XP_OS2) && !defined(XP_HAIKU) && !defined(NTO)
 typedef PRUint32 uint32;
 #else
 typedef unsigned long uint32;
@@ -72,19 +78,23 @@ typedef unsigned long uint32;
  * uint16
  */
 
+#if !defined(XP_HAIKU)
 typedef PRUint16 uint16;
+#endif
 
 /*
  * uint8
  */
 
+#if !defined(XP_HAIKU)
 typedef PRUint8 uint8;
+#endif
 
 /*
  * int64
  */
 
-#if !defined(_PR_AIX_HAVE_BSD_INT_TYPES)
+#if !defined(_PR_AIX_HAVE_BSD_INT_TYPES) && !defined(XP_HAIKU)
 typedef PRInt64 int64;
 #endif
 
@@ -94,7 +104,7 @@ typedef PRInt64 int64;
 
 #if !defined(_PR_AIX_HAVE_BSD_INT_TYPES) \
     && !defined(HPUX)
-#if !defined(_WIN32) && !defined(XP_OS2) && !defined(NTO)
+#if !defined(_WIN32) && !defined(XP_OS2) && !defined(XP_HAIKU) && !defined(NTO)
 typedef PRInt32 int32;
 #else
 typedef long int32;
@@ -106,7 +116,7 @@ typedef long int32;
  */
 
 #if !defined(_PR_AIX_HAVE_BSD_INT_TYPES) \
-    && !defined(HPUX)
+    && !defined(HPUX) && !defined(XP_HAIKU)
 typedef PRInt16 int16;
 #endif
 
@@ -115,7 +125,7 @@ typedef PRInt16 int16;
  */
 
 #if !defined(_PR_AIX_HAVE_BSD_INT_TYPES) \
-    && !defined(HPUX)
+    && !defined(HPUX) && !defined(XP_HAIKU)
 typedef PRInt8 int8;
 #endif
 
