SUMMARY="A Data Serialization Format"
DESCRIPTION="Cap'n Proto is a binary data interchange format and capability-based \
RPC system."
HOMEPAGE="https://capnproto.org"
COPYRIGHT="2017 Cloudflare, Inc. and contributors"
LICENSE="MIT"
REVISION="1"
SOURCE_URI="https://capnproto.org/capnproto-c++-$portVersion.tar.gz"
CHECKSUM_SHA256="ed00e44ecbbda5186bc78a41ba64a8dc4a861b5f8d4e822959b0144ae6fd42ef"
SOURCE_DIR="capnproto-c++-$portVersion"
PATCHES="capnproto-$portVersion.patchset"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

libVersion="$portVersion"
libVersionCompat="$libVersion compat >= ${libVersion%.*}"

PROVIDES="
	capnproto$secondaryArchSuffix = $portVersion
	lib:libcapnp_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libcapnpc_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libcapnp_json_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libcapnp_rpc_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libcapnp_websocket_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libkj_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libkj_async_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libkj_gzip_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libkj_http_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libkj_test_$libVersion$secondaryArchSuffix = $libVersionCompat
	lib:libkj_tls_$libVersion$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

PROVIDES_devel="
	capnproto${secondaryArchSuffix}_devel = $portVersion
	cmd:capnp
	cmd:capnpc
	cmd:capnpc_c++
	cmd:capnpc_capnp
	devel:libcapnp$secondaryArchSuffix = $libVersionCompat
	devel:libcapnpc$secondaryArchSuffix = $libVersionCompat
	devel:libcapnp_json$secondaryArchSuffix = $libVersionCompat
	devel:libcapnp_rpc$secondaryArchSuffix = $libVersionCompat
	devel:libcapnp_websocket$secondaryArchSuffix = $libVersionCompat
	devel:libkj$secondaryArchSuffix = $libVersionCompat
	devel:libkj_async$secondaryArchSuffix = $libVersionCompat
	devel:libkj_gzip$secondaryArchSuffix = $libVersionCompat
	devel:libkj_http$secondaryArchSuffix = $libVersionCompat
	devel:libkj_test$secondaryArchSuffix = $libVersionCompat
	devel:libkj_tls$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES_devel="
	capnproto$secondaryArchSuffix == $portVersion base
	haiku$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libssl$secondaryArchSuffix >= 3
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:aclocal
	cmd:autoconf
	cmd:awk
	cmd:gcc$secondaryArchSuffix
	cmd:libtoolize$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	autoreconf -i
	runConfigure --omit-dirs "binDir" ./configure \
		--bindir=$prefix/bin --disable-static
	make $jobArgs
}

INSTALL()
{
	make install

	prepareInstalledDevelLibs \
		libcapnp \
		libcapnpc \
		libcapnp-json \
		libcapnp-rpc \
		libcapnp-websocket \
		libkj \
		libkj-async \
		libkj-gzip \
		libkj-http \
		libkj-test \
		libkj-tls

	fixPkgconfig

	packageEntries devel \
		$binDir \
		$developDir \
		$libDir/cmake
}

TEST()
{
	# 1 test hangs and must be killed, a few fail
	make check
}
