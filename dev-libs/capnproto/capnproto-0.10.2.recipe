SUMMARY="A Data Serialization Format"
DESCRIPTION="Cap'n Proto is a binary data interchange format and capability-based \
RPC system."
HOMEPAGE="https://capnproto.org"
COPYRIGHT="2017 Cloudflare, Inc. and contributors"
LICENSE="MIT"
REVISION="1"
SOURCE_URI="https://github.com/capnproto/capnproto/archive/refs/tags/v${portVersion}.tar.gz"
CHECKSUM_SHA256="756262841fa66260c9969e900701cc86720c2548584fb96c8153348fd7edfe69"
SOURCE_DIR="capnproto-$portVersion"
PATCHES="capnproto-$portVersion.patchset"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	capnproto$secondaryArchSuffix = $portVersion
	cmd:capnp
	cmd:capnpc
	cmd:capnpc_c++
	cmd:capnpc_capnp
	lib:libcapnp$secondaryArchSuffix = $portVersion
	lib:libcapnpc$secondaryArchSuffix = $portVersion
	lib:libcapnp_json$secondaryArchSuffix = $portVersion
	lib:libcapnp_rpc$secondaryArchSuffix = $portVersion
	lib:libcapnp_websocket$secondaryArchSuffix = $portVersion
	lib:libkj$secondaryArchSuffix = $portVersion
	lib:libkj_async$secondaryArchSuffix = $portVersion
	lib:libkj_gzip$secondaryArchSuffix = $portVersion
	lib:libkj_http$secondaryArchSuffix = $portVersion
	lib:libkj_test$secondaryArchSuffix = $portVersion
	lib:libkj_tls$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

PROVIDES_devel="
	capnproto${secondaryArchSuffix}_devel = $portVersion
	devel:libcapnp$secondaryArchSuffix = $portVersion
	devel:libcapnpc$secondaryArchSuffix = $portVersion
	devel:libcapnp_json$secondaryArchSuffix = $portVersion
	devel:libcapnp_rpc$secondaryArchSuffix = $portVersion
	devel:libcapnp_websocket$secondaryArchSuffix = $portVersion
	devel:libkj$secondaryArchSuffix = $portVersion
	devel:libkj_async$secondaryArchSuffix = $portVersion
	devel:libkj_gzip$secondaryArchSuffix = $portVersion
	devel:libkj_http$secondaryArchSuffix = $portVersion
	devel:libkj_test$secondaryArchSuffix = $portVersion
	devel:libkj_tls$secondaryArchSuffix = $portVersion
	"
REQUIRES_devel="
	capnproto$secondaryArchSuffix == $portVersion base
	"

BUILD_REQUIRES="
	haiku_devel$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

BUILD()
{
	cmake . \
		-DCMAKE_INSTALL_PREFIX=$prefix \
		-DCMAKE_INSTALL_INCLUDEDIR=$includeDir \
		-DBUILD_SHARED_LIBS=ON \
		-DBUILD_TESTING=OFF \
		-DWITH_OPENSSL=ON \
		-DCMAKE_BUILD_TYPE=Release
	make $jobArgs
}

INSTALL()
{
	make install

	prepareInstalledDevelLib libcapnp
	prepareInstalledDevelLib libcapnpc
	prepareInstalledDevelLib libcapnp-json
	prepareInstalledDevelLib libcapnp-rpc
	prepareInstalledDevelLib libcapnp-websocket

	prepareInstalledDevelLib libkj
	prepareInstalledDevelLib libkj-async
	prepareInstalledDevelLib libkj-gzip
	prepareInstalledDevelLib libkj-http
	prepareInstalledDevelLib libkj-test
	prepareInstalledDevelLib libkj-tls

	fixPkgconfig

	if [ -n "$secondaryArchSuffix" ]; then
		rm -rf $documentationDir
	fi

	packageEntries devel \
		$developDir \
		$libDir/cmake
}
