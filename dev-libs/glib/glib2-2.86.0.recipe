SUMMARY="GLib is a cross-platform software utility library"
DESCRIPTION="GLib is a cross-platform software utility library that began as \
part of the GTK+ project. However, before releasing version 2 of GTK+, the \
project's developers decided to separate non-GUI-specific code from the GTK+ \
platform, thus creating GLib as a separate product. GLib was released as a \
separate library so other developers, those who did not make use of the \
GUI-related portions of GTK+, could make use of the non-GUI portions of the \
library without the overhead of depending on the entire GUI library.
Since GLib is a cross-platform library, applications using it to interface \
with the operating system are usually portable across different operating \
systems without major changes."
HOMEPAGE="https://www.gtk.org/"
COPYRIGHT="2025 GNOME Foundation Inc."
LICENSE="GNU LGPL v2"
REVISION="1"
SOURCE_URI="https://gitlab.gnome.org/GNOME/glib/-/archive/$portVersion/glib-$portVersion.tar.gz"
CHECKSUM_SHA256="56aef5791f402fff73a2de0664e573c5d00ef8cb71405eb76b388f44c6d78927"
SOURCE_DIR="glib-$portVersion"
srvGitRev2="4758f6fb7f889e074e13df3f914328f3eecb1fd3"
SOURCE_URI_2="https://gitlab.gnome.org/GNOME/gvdb/-/archive/$srvGitRev2/gvdb-$srvGitRev2.tar.bz2"
CHECKSUM_SHA256_2="0f1a2a968105cbae8b9829fe71e40b35a473f1bd4093b5b3dfd7be6d0960ca3a"
SOURCE_DIR_2="gvdb-$srvGitRev2"
PATCHES="glib2-$portVersion.patchset"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="?x86"

commandSuffix=$secondaryArchSuffix
commandBinDir=$binDir
if [ "$targetArchitecture" = x86_gcc2 ]; then
	commandSuffix=
	commandBinDir=$prefix/bin
fi

libVersion="0.8600.0"
libVersionCompat="$libVersion compat >= ${libVersion%%.*}"

PROVIDES="
	glib2$secondaryArchSuffix = $portVersion
	cmd:gapplication$commandSuffix
	cmd:gdbus$commandSuffix
	cmd:gdbus_codegen$commandSuffix
	cmd:gi_compile_repository$commandSuffix
	cmd:gi_decompile_typelib$commandSuffix
	cmd:gi_inspect_typelib$commandSuffix
	cmd:gio$commandSuffix
	cmd:gio_launch_desktop$commandSuffix
	cmd:gio_querymodules$commandSuffix
	cmd:glib_compile_resources$commandSuffix
	cmd:glib_compile_schemas$commandSuffix
	cmd:gresource$commandSuffix
	cmd:gsettings$commandSuffix
	lib:libglib_2.0$secondaryArchSuffix = $libVersionCompat
	lib:libgio_2.0$secondaryArchSuffix = $libVersionCompat
	lib:libgirepository_2.0$secondaryArchSuffix = $libVersionCompat
	lib:libgmodule_2.0$secondaryArchSuffix = $libVersionCompat
	lib:libgobject_2.0$secondaryArchSuffix = $libVersionCompat
	lib:libgthread_2.0$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libffi$secondaryArchSuffix
	lib:libiconv$secondaryArchSuffix
	lib:libintl$secondaryArchSuffix
	lib:libpcre2_8$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

PROVIDES_devel="
	glib2${secondaryArchSuffix}_devel = $portVersion compat >= 0
	cmd:glib_genmarshal$commandSuffix
	cmd:glib_gettextize$commandSuffix
	cmd:glib_mkenums$commandSuffix
	cmd:gobject_query$commandSuffix
	cmd:gtester$commandSuffix
	cmd:gtester_report$commandSuffix
	devel:libgio_2.0$secondaryArchSuffix = $libVersionCompat
	devel:libglib_2.0$secondaryArchSuffix = $libVersionCompat
	devel:libgmodule_2.0$secondaryArchSuffix = $libVersionCompat
	devel:libgobject_2.0$secondaryArchSuffix = $libVersionCompat
	devel:libgthread_2.0$secondaryArchSuffix = $libVersionCompat
	"
REQUIRES_devel="
	glib2$secondaryArchSuffix == $portVersion base
	haiku$secondaryArchSuffix
	cmd:perl
	cmd:python3
	devel:libffi$secondaryArchSuffix
	devel:libiconv$secondaryArchSuffix
	devel:libintl$secondaryArchSuffix
	devel:libpcre2_8$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
#	devel:libdbus_1$secondaryArchSuffix
#	devel:libelf$secondaryArchSuffix
	devel:libffi$secondaryArchSuffix
	devel:libiconv$secondaryArchSuffix
	devel:libintl$secondaryArchSuffix
	devel:libpcre2_8$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:meson
	cmd:python3
	cmd:pkg_config$secondaryArchSuffix
	"

defineDebugInfoPackage glib2$secondaryArchSuffix \
	$commandBinDir/gapplication \
	$commandBinDir/gdbus \
	$commandBinDir/gio \
	$commandBinDir/gio-querymodules \
	$commandBinDir/glib-compile-resources \
	$commandBinDir/glib-compile-schemas \
	$commandBinDir/gresource \
	$commandBinDir/gsettings \
	$libDir/libgio-2.0.so.$libVersion \
	$libDir/libglib-2.0.so.$libVersion \
	$libDir/libgmodule-2.0.so.$libVersion \
	$libDir/libgobject-2.0.so.$libVersion \
	$libDir/libgthread-2.0.so.$libVersion

BUILD()
{
	rm -rf subprojects/gvdb
	ln -s $sourceDir2 subprojects/gvdb

	CFLAGS="-D_BSD_SOURCE" \
		LDFLAGS="-lbsd -lgnu -lnetwork" meson build \
		-D glib_debug=disabled --buildtype=debugoptimized \
		--prefix=$prefix --includedir=$includeDir \
		--libdir=$libDir --datadir=$dataDir --bindir=$commandBinDir \
		--localedir=$dataDir/locale

	ninja $jobArgs -C build
}

INSTALL()
{
	ninja -C build install

	prepareInstalledDevelLibs libgio-2.0 \
					libglib-2.0 \
					libgmodule-2.0 \
					libgobject-2.0 \
					libgthread-2.0

	# move the glibconfig header into devel as well
	mv $libDir/glib-2.0 $developLibDir

	fixPkgconfig

	# devel package
	packageEntries devel \
		$developDir \
		$commandBinDir/glib-genmarshal \
		$commandBinDir/glib-gettextize \
		$commandBinDir/glib-mkenums \
		$commandBinDir/gobject-query \
		$commandBinDir/gtester \
		$commandBinDir/gtester-report

	rm -rf $prefix/libexec
}

TEST()
{
	meson test -C build
}
