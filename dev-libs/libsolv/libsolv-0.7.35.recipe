SUMMARY="A library for solving packages and reading repositories"
DESCRIPTION="A Library for solving packages and reading repositories."
HOMEPAGE="https://github.com/openSUSE/libsolv"
COPYRIGHT="2007-2013, Novell Inc."
LICENSE="BSD (3-clause)"
REVISION="1"
SOURCE_URI="https://github.com/openSUSE/libsolv/archive/refs/tags/$portVersion.tar.gz"
CHECKSUM_SHA256="e6ef552846f908beb3bbf6ca718b6dd431bd8a281086d82af9a6d2a3ba919be5"
SOURCE_FILENAME="libsolv-$portVersion.tar.gz"
SOURCE_DIR="libsolv-$portVersion"

ARCHITECTURES="?all"
SECONDARY_ARCHITECTURES="?x86"

PROVIDES="
	libsolv$secondaryArchSuffix = $portVersion
	lib:libsolv$secondaryArchSuffix = $portVersion
	lib:libsolvext$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libexpat$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

PROVIDES_devel="
	libsolv${secondaryArchSuffix}_devel = $portVersion
	devel:libsolv${secondaryArchSuffix} = $portVersion
	devel:libsolvext${secondaryArchSuffix} = $portVersion
	"
REQUIRES_devel="
	libsolv${secondaryArchSuffix} == $portVersion base
	"

PROVIDES_tools="
	libsolv${secondaryArchSuffix}_tools = $portVersion
	cmd:dumpsolv${secondaryArchSuffix} = $portVersion
	cmd:installcheck${secondaryArchSuffix} = $portVersion
	cmd:mergesolv${secondaryArchSuffix} = $portVersion
	cmd:repo2solv${secondaryArchSuffix} = $portVersion
	cmd:testsolv${secondaryArchSuffix} = $portVersion
	"
REQUIRES_tools="
	libsolv${secondaryArchSuffix} == $portVersion base
	haiku$secondaryArchSuffix
	"

BUILD_REQUIRES="
	devel:libexpat$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	haiku${secondaryArchSuffix}_devel
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:sed
	"

PATCH()
{
	sed -i 's,${CMAKE_INSTALL_PREFIX}/share/cmake/Modules',$dataDir/cmake/Modules, CMakeLists.txt
}

BUILD()
{
	cmake -B build -S . \
		-DCMAKE_BUILD_TYPE=Release \
		$cmakeDirArgs

	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	# set up the develop directory correctly
	prepareInstalledDevelLibs libsolv libsolvext

	packageEntries tools \
		$binDir \
		$manDir/man1

	# devel package
	packageEntries devel \
		$dataDir \
		$developDir \
		$manDir
}

# Reference results on beta5 x86_64:
# 75% tests passed, 7 tests failed out of 28
# Total Test time (real) =  10.95 sec
# The following tests FAILED:
#           2 - alternative (Failed)
#           3 - blacklist (Failed)
#           8 - distupgrade (Failed)
#          11 - favor (Failed)
#          14 - lock (Failed)
#          20 - sat (Failed)
#          24 - targeted (Failed)
TEST()
{
	ctest --test-dir build --output-on-failure
}
